<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test Dashboard MCP - SignalConso</title>
    
    <!-- Favicon DSFR -->
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/favicon/apple-touch-icon.png">
    <link rel="icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/favicon/favicon.svg" type="image/svg+xml">
    
    <!-- CSS - Ordre important : ODS puis DSFR -->
    <link rel="stylesheet" href="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    
    <style>
        /* Harmonisation ODS/DSFR */
        .ods-widget {
            font-family: Marianne, arial, sans-serif;
        }
        
        .widget-section {
            background: #f6f6f6;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .facet-wrapper {
            background: white;
            border: 1px solid var(--border-default-grey);
            border-radius: 0.25rem;
            padding: 1rem;
            min-height: 100px;
        }
        
        .ods-map {
            width: 100% !important;
            height: 500px !important;
        }
        
        /* KPI Cards */
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #000091;
        }
    </style>
</head>
<body>
    <!-- Header DSFR -->
    <header role="banner" class="fr-header">
        <div class="fr-header__body">
            <div class="fr-container">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                                <p class="fr-logo">
                                    République
                                    <br>Française
                                </p>
                            </div>
                        </div>
                        <div class="fr-header__service">
                            <p class="fr-header__service-title">
                                Test Dashboard MCP
                            </p>
                            <p class="fr-header__service-tagline">
                                Génération automatique de widgets avec MCP
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Contenu principal -->
    <main class="fr-container fr-mt-4w" ng-app="ods-widgets">
        <ods-dataset-context 
            context="signalconso" 
            signalconso-domain="data.economie.gouv.fr" 
            signalconso-dataset="signalconso">
            
            <div class="fr-mb-4w">
                <h1>Dashboard de Test MCP - SignalConso</h1>
                <p class="fr-text--lg">
                    Ce dashboard a été généré automatiquement en utilisant les serveurs MCP (DSFR + ODS Widgets).
                </p>
            </div>

            <!-- Section 1: Barre de recherche -->
            <div class="widget-section">
                <h2 class="fr-h3">Recherche</h2>
                <div class="fr-search-bar" role="search">
                    <label class="fr-label" for="search-signalconso">
                        Rechercher dans les signalements
                    </label>
                    <input 
                        type="text" 
                        class="fr-input" 
                        id="search-signalconso"
                        ng-model="signalconso.parameters['q']"
                        ng-model-options="{ debounce: 300 }"
                        placeholder="Rechercher par catégorie, région, statut..."
                        aria-label="Rechercher dans les signalements">
                    <button class="fr-btn" type="button">
                        Rechercher
                    </button>
                </div>
            </div>

            <!-- Section 2: KPIs -->
            <div class="widget-section">
                <h2 class="fr-h3">Indicateurs clés</h2>
                <div class="fr-grid-row fr-grid-row--gutters">
                    <!-- KPI 1: Total -->
                    <div class="fr-col-12 fr-col-md-3">
                        <div class="fr-tile fr-tile--vertical">
                            <div class="fr-tile__body">
                                <h4 class="fr-tile__title fr-text--sm">Total Signalements</h4>
                                <div class="fr-tile__content">
                                    <ods-aggregation 
                                        context="signalconso"
                                        function="COUNT">
                                        <p class="kpi-value">{{ aggregation | number }}</p>
                                    </ods-aggregation>
                                    <p class="fr-text--sm">Enregistrements</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KPI 2: Régions -->
                    <div class="fr-col-12 fr-col-md-3">
                        <div class="fr-tile fr-tile--vertical">
                            <div class="fr-tile__body">
                                <h4 class="fr-tile__title fr-text--sm">Couverture</h4>
                                <div class="fr-tile__content">
                                    <ods-aggregation 
                                        context="signalconso"
                                        function="COUNT"
                                        field="reg_name">
                                        <p class="kpi-value">{{ aggregation }}</p>
                                    </ods-aggregation>
                                    <p class="fr-text--sm">Régions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KPI 3: Catégories -->
                    <div class="fr-col-12 fr-col-md-3">
                        <div class="fr-tile fr-tile--vertical">
                            <div class="fr-tile__body">
                                <h4 class="fr-tile__title fr-text--sm">Diversité</h4>
                                <div class="fr-tile__content">
                                    <ods-aggregation 
                                        context="signalconso"
                                        function="COUNT"
                                        field="category">
                                        <p class="kpi-value">{{ aggregation }}</p>
                                    </ods-aggregation>
                                    <p class="fr-text--sm">Catégories</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KPI 4: Année courante -->
                    <div class="fr-col-12 fr-col-md-3">
                        <div class="fr-tile fr-tile--vertical">
                            <div class="fr-tile__body">
                                <h4 class="fr-tile__title fr-text--sm">Cette année</h4>
                                <div class="fr-tile__content">
                                    <ods-aggregation 
                                        context="signalconso"
                                        function="COUNT"
                                        expression="year(creationdate) = 2024">
                                        <p class="kpi-value">{{ aggregation | number }}</p>
                                    </ods-aggregation>
                                    <p class="fr-text--sm">Signalements 2024</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Filtres -->
            <div class="widget-section">
                <h2 class="fr-h3">Filtres</h2>
                <ods-facets context="signalconso">
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-md-3">
                            <div class="facet-wrapper">
                                <h3 class="fr-text--sm fr-mb-1w">Région</h3>
                                <ods-facet name="reg_name" disjunctive="true"></ods-facet>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-3">
                            <div class="facet-wrapper">
                                <h3 class="fr-text--sm fr-mb-1w">Catégorie</h3>
                                <ods-facet name="category" disjunctive="true"></ods-facet>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-3">
                            <div class="facet-wrapper">
                                <h3 class="fr-text--sm fr-mb-1w">Statut</h3>
                                <ods-facet name="status" disjunctive="true"></ods-facet>
                            </div>
                        </div>
                        <div class="fr-col-12 fr-col-md-3">
                            <div class="facet-wrapper">
                                <h3 class="fr-text--sm fr-mb-1w">Année</h3>
                                <ods-facet name="creationdate" timeunit="year" disjunctive="true"></ods-facet>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fr-mt-2w">
                        <ods-clear-all-filters context="signalconso">
                            <button class="fr-btn fr-btn--secondary">
                                Réinitialiser tous les filtres
                            </button>
                        </ods-clear-all-filters>
                    </div>
                </ods-facets>
            </div>

            <!-- Section 4: Carte -->
            <div class="widget-section">
                <h2 class="fr-h3">Carte des signalements</h2>
                <div class="fr-card">
                    <div class="fr-card__body">
                        <ods-map 
                            context="signalconso"
                            location="12,46.5,2.5"
                            basemap="jawg.streets"
                            toolbar-fullscreen="true">
                            <ods-map-layer 
                                context="signalconso"
                                color="#000091"
                                picto="ods-circle"
                                size="4"
                                border-color="#ffffff"
                                border-size="1"
                                caption="true"
                                title="Signalements">
                            </ods-map-layer>
                        </ods-map>
                    </div>
                </div>
            </div>

            <!-- Section 5: Graphique -->
            <div class="widget-section">
                <h2 class="fr-h3">Analyse des données</h2>
                <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-12 fr-col-md-6">
                        <div class="fr-card">
                            <div class="fr-card__body">
                                <h3 class="fr-card__title">Top 10 Catégories</h3>
                                <ods-chart>
                                    <ods-chart-query 
                                        context="signalconso"
                                        field-x="category"
                                        maxpoints="10"
                                        sort="serie1-1">
                                        <ods-chart-serie 
                                            chart-type="column"
                                            function-y="COUNT"
                                            color="#000091"
                                            scientific-display="false">
                                        </ods-chart-serie>
                                    </ods-chart-query>
                                </ods-chart>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fr-col-12 fr-col-md-6">
                        <div class="fr-card">
                            <div class="fr-card__body">
                                <h3 class="fr-card__title">Évolution temporelle</h3>
                                <ods-chart timescale="year">
                                    <ods-chart-query 
                                        context="signalconso"
                                        timescale="year">
                                        <ods-chart-serie 
                                            chart-type="line"
                                            function-y="COUNT"
                                            timescale="year"
                                            color="#000091">
                                        </ods-chart-serie>
                                    </ods-chart-query>
                                </ods-chart>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 6: Tableau -->
            <div class="widget-section">
                <h2 class="fr-h3">Données détaillées</h2>
                <div class="fr-table fr-table--bordered">
                    <div class="fr-table__wrapper">
                        <div class="fr-table__container">
                            <ods-table 
                                context="signalconso"
                                displayed-fields="creationdate,category,reg_name,dep_name,status,subcategories"
                                sort="-creationdate"
                                page-size="10">
                            </ods-table>
                        </div>
                    </div>
                </div>
                
                <div class="fr-mt-2w">
                    <ods-pager context="signalconso" page-size="10"></ods-pager>
                </div>
            </div>

            <!-- Résumé des résultats -->
            <div class="fr-callout fr-mb-4w">
                <p class="fr-callout__text" ods-result-context="signalconso">
                    <strong>{{ signalconso.nhits | number }}</strong> signalements trouvés
                    <span ng-if="signalconso.parameters['q']">
                        pour la recherche "{{ signalconso.parameters['q'] }}"
                    </span>
                </p>
            </div>

        </ods-dataset-context>
    </main>

    <!-- Footer DSFR -->
    <footer class="fr-footer" role="contentinfo">
        <div class="fr-container">
            <div class="fr-footer__body">
                <div class="fr-footer__brand">
                    <p class="fr-logo">
                        République
                        <br>Française
                    </p>
                </div>
                <div class="fr-footer__content">
                    <p class="fr-footer__content-desc">
                        Dashboard de test généré avec les serveurs MCP
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-sanitize/1.8.2/angular-sanitize.min.js"></script>
    <script src="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>