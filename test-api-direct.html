<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Direct - Sans ODS Widgets</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
</head>
<body>
    <div class="fr-container fr-my-5w">
        <h1>Test Direct API SignalConso</h1>
        
        <div class="fr-callout fr-my-3w">
            <h3 class="fr-callout__title">Statut de connexion</h3>
            <p class="fr-callout__text" id="status">Test en cours...</p>
        </div>

        <div class="fr-table fr-table--bordered">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Catégorie</th>
                        <th>Ville</th>
                        <th>Détails</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr>
                        <td colspan="4">Chargement...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <pre id="debug" class="fr-mt-3w" style="background: #f5f5f5; padding: 1rem; display: none;"></pre>
    </div>

    <script>
        // Test direct sans Angular ni ODS Widgets
        (async function() {
            const statusEl = document.getElementById('status');
            const tableBody = document.getElementById('table-body');
            const debugEl = document.getElementById('debug');
            
            try {
                // Test avec l'API v1.0 (plus compatible)
                const response = await fetch('https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=10');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                statusEl.innerHTML = `✅ Connexion réussie ! ${data.nhits} signalements trouvés.`;
                statusEl.style.color = 'green';
                
                // Afficher les données dans le tableau
                if (data.records && data.records.length > 0) {
                    tableBody.innerHTML = '';
                    
                    data.records.forEach(record => {
                        const row = document.createElement('tr');
                        const fields = record.fields || {};
                        
                        // Utiliser les vrais noms de champs de l'API
                        const dateStr = fields.creationdate ? new Date(fields.creationdate).toLocaleDateString('fr-FR') : 'N/A';
                        const category = fields.category || 'N/A';
                        const location = fields.dep_name ? `${fields.dep_name} (${fields.dep_code})` : 'N/A';
                        const tags = fields.tags || fields.subcategories || 'N/A';
                        
                        row.innerHTML = `
                            <td>${dateStr}</td>
                            <td>${category}</td>
                            <td>${location}</td>
                            <td>${tags.substring(0, 100)}${tags.length > 100 ? '...' : ''}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4">Aucune donnée trouvée</td></tr>';
                }
                
                // Debug info
                debugEl.style.display = 'block';
                debugEl.textContent = JSON.stringify(data, null, 2);
                
            } catch (error) {
                statusEl.innerHTML = `❌ Erreur: ${error.message}`;
                statusEl.style.color = 'red';
                
                // Tentative avec CORS proxy
                statusEl.innerHTML += '<br>Tentative avec proxy CORS...';
                
                try {
                    const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                    const targetUrl = 'https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=10';
                    const proxyResponse = await fetch(proxyUrl + targetUrl);
                    const proxyData = await proxyResponse.json();
                    
                    statusEl.innerHTML += '<br>✅ Proxy CORS fonctionne!';
                    debugEl.style.display = 'block';
                    debugEl.textContent = JSON.stringify(proxyData, null, 2);
                    
                } catch (proxyError) {
                    statusEl.innerHTML += `<br>❌ Proxy CORS échoué: ${proxyError.message}`;
                    statusEl.innerHTML += '<br><br>⚠️ Problème CORS détecté. L\'API nécessite peut-être une configuration serveur ou une clé API.';
                }
            }
        })();
    </script>
</body>
</html>