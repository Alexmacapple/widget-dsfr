<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Dashboard SignalConso - Signalements consommateurs avec widgets DSFR">
    <title>SignalConso - Dashboard DSFR</title>
    
    <!-- Favicon DSFR -->
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/favicon/apple-touch-icon.png">
    <link rel="icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/favicon/favicon.svg" type="image/svg+xml">
    
    <!-- CSS - Ordre important : ODS puis DSFR -->
    <link rel="stylesheet" href="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    
    <!-- Styles personnalisés pour harmoniser ODS avec DSFR -->
    <style>
        /* Variables DSFR */
        :root {
            --primary-color: #000091;
            --secondary-color: #6a6af4;
            --success-color: #18753c;
            --warning-color: #b34000;
            --error-color: #ce0500;
        }

        /* Harmonisation des widgets ODS avec DSFR */
        .ods-widget {
            font-family: Marianne, arial, sans-serif;
            color: var(--text-default-grey);
        }
        
        /* Tables DSFR */
        .ods-table-container {
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        
        .odswidget-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .odswidget-table th {
            background-color: var(--background-contrast-grey);
            color: var(--text-title-grey);
            font-weight: 700;
            padding: 0.75rem;
            text-align: left;
            border-bottom: 2px solid var(--border-default-grey);
        }
        
        .odswidget-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-default-grey);
        }
        
        .odswidget-table tbody tr:hover {
            background-color: var(--background-alt-grey);
        }
        
        /* Facettes DSFR */
        .odswidget-facet {
            margin-bottom: 1.5rem;
        }
        
        .odswidget-facet__title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-title-grey);
        }
        
        .odswidget-facet-category {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-default-grey);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .odswidget-facet-category:hover {
            background-color: var(--background-alt-grey);
        }
        
        /* Charts DSFR */
        .odswidget-chart {
            background: white;
            border: 1px solid var(--border-default-grey);
            border-radius: 0.25rem;
            padding: 1rem;
        }
        
        /* Fix pour les labels tronqués dans les graphiques */
        .ods-chart-container svg {
            overflow: visible !important;
        }
        
        .ods-chart-container .nv-x text,
        .ods-chart-container .nv-y text {
            text-overflow: initial !important;
        }
        
        .ods-chart-container .nvd3 .nv-axis text {
            font-size: 12px !important;
        }
        
        .ods-chart-container .tick text {
            max-width: none !important;
        }
        
        /* Style simple pour les cartes dans TestAlex */
        #tab-testalex .fr-card {
            height: 100%;
        }
        
        #tab-testalex .fr-grid-row {
            align-items: stretch;
        }
        
        /* Séparation visuelle des graphiques */
        .graph-section {
            background: #f6f6f6;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        /* Search bar DSFR */
        .search-module {
            margin-bottom: 2rem;
        }
        
        .odswidget-searchbox {
            width: 100%;
        }
        
        .odswidget-searchbox input {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 2px solid var(--border-default-grey);
            border-radius: 0.25rem 0 0 0.25rem;
            min-width: 500px;
        }
        
        .odswidget-searchbox input:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        @media (max-width: 768px) {
            .odswidget-searchbox input {
                min-width: 100%;
                font-size: 0.875rem;
            }
        }
        
        /* KPI Cards */
        .kpi-card {
            background: white;
            border: 1px solid var(--border-default-grey);
            border-radius: 0.25rem;
            padding: 1.5rem;
            text-align: center;
            height: 100%;
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .kpi-label {
            font-size: 1rem;
            color: var(--text-mention-grey);
        }
        
        /* Styles pour les tuiles DSFR */
        .fr-tile__title {
            font-size: 2.5rem !important;
            font-weight: 700 !important;
            color: var(--primary-color) !important;
            margin-bottom: 0.5rem !important;
        }
        
        .fr-tile__desc {
            font-size: 1rem !important;
            color: var(--text-mention-grey) !important;
        }
        
        .fr-tile {
            background: white;
            border: 1px solid var(--border-default-grey);
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fr-tile__body {
            text-align: center;
            width: 100%;
        }
        
        /* Variables DSFR pour les couleurs */
        .fr-display--xs {
            font-size: 2.5rem !important;
            line-height: 1.2;
        }
        
        .fr-text--mention-grey {
            color: #666666;
        }

        /* Pagination DSFR */
        .odswidget-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            padding: 1rem 0;
        }
        
        .odswidget-pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-default-grey);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .odswidget-pagination button:hover:not(:disabled) {
            background: var(--background-alt-grey);
            border-color: var(--primary-color);
        }
        
        .odswidget-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .odswidget-pagination .current {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Zone widget identifiée */
        .widget-zone {
            background-color: white;
            border: 1px solid var(--border-default-grey);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1rem 0;
            position: relative;
        }
        
        .widget-zone::before {
            content: attr(data-widget-id);
            position: absolute;
            top: -0.75rem;
            left: 1rem;
            background: white;
            padding: 0 0.5rem;
            color: var(--text-mention-grey);
            font-size: 0.875rem;
            font-family: monospace;
        }

        /* Correction globale pour les dropdowns ODS */
        .facet-dropdown-wrapper {
            min-height: 42px;
        }
        
        .facet-dropdown-wrapper .odswidget-facet__dropdown {
            min-height: 42px !important;
        }
        
        /* Style DSFR pour les facettes ODS dropdown - Design System France */
        .odswidget-facet-dropdown {
            position: relative;
            width: 100%;
            min-height: 42px !important;
        }
        
        /* Bouton principal style fr-select DSFR */
        .odswidget-facet-dropdown .odswidget-facet-dropdown__button {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            min-height: 42px !important;
            height: auto !important;
            font-size: 1rem;
            line-height: 1.5rem;
            font-family: Marianne, arial, sans-serif;
            font-weight: 400;
            color: var(--text-default-grey, #161616);
            background-color: var(--background-default-grey, #ffffff);
            background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M8 10.5L3 5.5L4.05 4.45L8 8.4L11.95 4.45L13 5.5L8 10.5Z' fill='%23161616'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: calc(100% - 1rem) center;
            background-size: 1rem 1rem;
            border: none;
            border-bottom: 2px solid var(--border-plain-grey, #3a3a3a);
            border-radius: 0.25rem 0.25rem 0 0;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        
        /* Hover état */
        .odswidget-facet-dropdown .odswidget-facet-dropdown__button:hover {
            background-color: var(--background-contrast-grey, #f6f6f6);
        }
        
        /* Focus état avec outline DSFR */
        .odswidget-facet-dropdown .odswidget-facet-dropdown__button:focus,
        .odswidget-facet-dropdown .odswidget-facet-dropdown__button:focus-visible {
            outline: 2px solid var(--outline-color, #0a76f6);
            outline-offset: 2px;
            border-color: var(--border-plain-blue-france, #000091);
        }
        
        /* État ouvert */
        .odswidget-facet-dropdown.odswidget-facet-dropdown--open .odswidget-facet-dropdown__button {
            border-color: var(--border-plain-blue-france, #000091);
            background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M8 5.5L13 10.5L11.95 11.55L8 7.6L4.05 11.55L3 10.5L8 5.5Z' fill='%23000091'/%3E%3C/svg%3E");
        }
        
        /* Forcer l'affichage du dropdown quand ouvert */
        .odswidget-facet-dropdown.odswidget-facet-dropdown--open .odswidget-facet-dropdown__menu,
        .odswidget-facet-dropdown.odswidget-facet-dropdown--open .odswidget-facet-dropdown__dropdown {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Menu déroulant style DSFR */
        .odswidget-facet-dropdown .odswidget-facet-dropdown__menu,
        .odswidget-facet-dropdown .odswidget-facet-dropdown__dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--background-default-grey, #ffffff);
            border: 1px solid var(--border-default-grey, #e5e5e5);
            border-top: none;
            border-radius: 0 0 0.25rem 0.25rem;
            box-shadow: 0 16px 32px 0 rgba(0, 0, 18, 0.16);
            max-height: 400px !important;
            min-height: 100px !important;
            overflow-y: auto;
            z-index: 1000;
        }
        
        /* Champ de recherche dans le dropdown */
        .odswidget-facet-dropdown .odswidget-facet-search {
            padding: 0.75rem;
            background-color: var(--background-contrast-grey, #f6f6f6);
            border-bottom: 1px solid var(--border-default-grey, #e5e5e5);
        }
        
        .odswidget-facet-dropdown .odswidget-facet-search input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            min-height: 2.5rem;
            font-size: 0.875rem;
            font-family: Marianne, arial, sans-serif;
            color: var(--text-default-grey, #161616);
            background-color: var(--background-default-grey, #ffffff);
            border: none;
            border-bottom: 2px solid var(--border-plain-grey, #3a3a3a);
            border-radius: 0.25rem 0.25rem 0 0;
        }
        
        .odswidget-facet-dropdown .odswidget-facet-search input:focus {
            outline: 2px solid var(--outline-color, #0a76f6);
            outline-offset: 2px;
            border-color: var(--border-plain-blue-france, #000091);
        }
        
        .odswidget-facet-dropdown .odswidget-facet-search input::placeholder {
            color: var(--text-mention-grey, #666666);
            opacity: 1;
        }
        
        /* Items dans le dropdown - style checkbox DSFR */
        .odswidget-facet-dropdown .odswidget-facet-category-value {
            padding: 0.75rem 1rem;
            min-height: 44px !important;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border-default-grey, #e5e5e5);
        }
        
        .odswidget-facet-dropdown .odswidget-facet-category-value:last-child {
            border-bottom: none;
        }
        
        .odswidget-facet-dropdown .odswidget-facet-category-value:hover {
            background-color: var(--background-contrast-grey, #f6f6f6);
        }
        
        /* Checkbox style DSFR */
        .odswidget-facet-dropdown .odswidget-facet-category-value input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.5rem;
            height: 1.5rem;
            margin: 0;
            margin-right: 0.75rem;
            padding: 0;
            flex-shrink: 0;
            border: 2px solid var(--border-action-high-blue-france, #000091);
            border-radius: 0.25rem;
            background-color: var(--background-default-grey, #ffffff);
            background-position: center;
            background-repeat: no-repeat;
            background-size: 1rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .odswidget-facet-dropdown .odswidget-facet-category-value input[type="checkbox"]:checked {
            background-color: var(--background-action-high-blue-france, #000091);
            background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M13.854 4.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 .708-.708L6.5 10.793l6.646-6.647a.5.5 0 0 1 .708 0z' fill='white'/%3E%3C/svg%3E");
            border-color: var(--border-action-high-blue-france, #000091);
        }
        
        .odswidget-facet-dropdown .odswidget-facet-category-value input[type="checkbox"]:focus {
            outline: 2px solid var(--outline-color, #0a76f6);
            outline-offset: 2px;
        }
        
        .odswidget-facet-dropdown .odswidget-facet-category-value input[type="checkbox"]:hover:not(:checked) {
            background-color: var(--background-contrast-grey, #f6f6f6);
        }
        
        /* Label et compteur */
        .odswidget-facet-dropdown .odswidget-facet-category-value-label {
            flex: 1;
            font-size: 1rem;
            line-height: 1.5rem;
            color: var(--text-default-grey, #161616);
            font-family: Marianne, arial, sans-serif;
        }
        
        .odswidget-facet-dropdown .odswidget-facet-category-value-count {
            font-size: 0.875rem;
            line-height: 1.125rem;
            color: var(--text-mention-grey, #666666);
            margin-left: 0.5rem;
            font-family: Marianne, arial, sans-serif;
        }
        
        .odswidget-facet-dropdown .odswidget-facet-category-value-count:before {
            content: "(";
        }
        
        .odswidget-facet-dropdown .odswidget-facet-category-value-count:after {
            content: ")";
        }
        
        /* État désactivé */
        .odswidget-facet-dropdown[disabled] .odswidget-facet-dropdown__button,
        .odswidget-facet-dropdown .odswidget-facet-dropdown__button[disabled] {
            color: var(--text-disabled-grey, #929292);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* Scrollbar personnalisée */
        .odswidget-facet-dropdown .odswidget-facet-dropdown__menu::-webkit-scrollbar {
            width: 0.5rem;
        }
        
        .odswidget-facet-dropdown .odswidget-facet-dropdown__menu::-webkit-scrollbar-track {
            background: var(--background-contrast-grey, #f6f6f6);
            border-radius: 0.25rem;
        }
        
        .odswidget-facet-dropdown .odswidget-facet-dropdown__menu::-webkit-scrollbar-thumb {
            background: var(--border-default-grey, #dddddd);
            border-radius: 0.25rem;
        }
        
        .odswidget-facet-dropdown .odswidget-facet-dropdown__menu::-webkit-scrollbar-thumb:hover {
            background: var(--border-plain-grey, #929292);
        }
        
        /* Style DSFR pour les facettes ODS natives */
        .facet-wrapper {
            background: white;
            border: 1px solid var(--border-default-grey, #dddddd);
            border-radius: 0.25rem;
            padding: 1rem;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Container pour la liste des facettes SANS scroll */
        .facet-wrapper .odswidget-facet {
            flex: 1;
            overflow: visible !important;
            margin-bottom: 0.5rem;
        }
        
        /* Amélioration de l'accessibilité des checkboxes dans les facettes */
        .odswidget-facet-category-value label {
            display: flex !important;
            align-items: center !important;
            cursor: pointer !important;
            padding: 0.5rem 0 !important;
        }
        
        .odswidget-facet-category-value input[type="checkbox"] {
            margin-right: 0.75rem !important;
            flex-shrink: 0 !important;
        }
        
        /* Indicateur visuel pour les facettes avec filtres actifs */
        .odswidget-facet-dropdown--active .odswidget-facet-dropdown__button,
        .odswidget-facet-dropdown.has-active-filters .odswidget-facet-dropdown__button {
            background-color: var(--background-action-low-blue-france, #f5f5fe) !important;
            border-color: var(--border-plain-blue-france, #000091) !important;
            font-weight: 600 !important;
        }
        
        /* Animation douce pour l'ouverture des dropdowns */
        .odswidget-facet-dropdown__menu,
        .odswidget-facet-dropdown__dropdown {
            transition: opacity 0.2s ease, visibility 0.2s ease !important;
        }
        
        /* Supprimer TOUTES les scrollbars */
        .odswidget-facet-list,
        .odswidget-facet-category-list,
        .facet-wrapper * {
            overflow: visible !important;
            max-width: 100% !important;
        }
        
        /* Masquer complètement les scrollbars */
        .facet-wrapper::-webkit-scrollbar,
        .facet-wrapper *::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }
        
        /* Style pour le bouton "More" aligné en bas */
        .odswidget-facet-see-more,
        .odswidget-facet__see-more,
        .odswidget-facet button[ng-click*="more"],
        .odswidget-facet button[ng-click*="less"] {
            margin-top: 1rem;
            width: 100%;
            background: white;
            border: 1px solid var(--border-default-grey, #dddddd);
            padding: 0.5rem;
            text-align: center;
            border-radius: 0.25rem;
            color: var(--text-action-high-blue-france, #000091);
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .odswidget-facet-see-more:hover,
        .odswidget-facet__see-more:hover,
        .odswidget-facet button[ng-click*="more"]:hover,
        .odswidget-facet button[ng-click*="less"]:hover {
            background-color: var(--background-contrast-grey, #f6f6f6);
        }
        
        /* Assurer que les éléments sont visibles */
        .odswidget-facet-category {
            display: block !important;
        }
        
        .odswidget-facet-category-value {
            display: flex !important;
        }
        
        .facet-wrapper h3 {
            color: var(--text-default-grey, #161616);
            font-weight: 700;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-plain-blue-france, #000091);
            padding-bottom: 0.5rem;
        }
        
        /* Style pour les items de facettes */
        .odswidget-facet .odswidget-facet-category {
            margin-bottom: 0.5rem;
            overflow-x: hidden !important;
        }
        
        .odswidget-facet .odswidget-facet-category-value {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .odswidget-facet .odswidget-facet-category-value:hover {
            background-color: var(--background-contrast-grey, #f6f6f6);
        }
        
        .odswidget-facet .odswidget-facet-category-value input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        
        .odswidget-facet .odswidget-facet-category-value-label {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-default-grey, #161616);
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: calc(100% - 60px);
        }
        
        .odswidget-facet .odswidget-facet-category-value-count {
            font-size: 0.75rem;
            color: var(--text-mention-grey, #666666);
            margin-left: 0.5rem;
            flex-shrink: 0;
        }
        
        /* Bouton "Voir plus" style DSFR */
        .odswidget-facet .odswidget-facet-see-more {
            display: block;
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background: transparent;
            border: 1px solid var(--border-default-grey, #dddddd);
            border-radius: 0.25rem;
            color: var(--text-action-high-blue-france, #000091);
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .odswidget-facet .odswidget-facet-see-more:hover {
            background-color: var(--background-contrast-grey, #f6f6f6);
        }
        
        /* Styles pour la carte ODS */
        .ods-map {
            width: 100% !important;
            height: 500px !important;
            min-height: 400px !important;
        }
        
        .odswidget-map {
            width: 100% !important;
            height: 100% !important;
        }
        
        .odswidget-map-container {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .fr-grid-row {
                flex-direction: column;
            }
            
            .fr-col-md-3 {
                width: 100%;
                margin-bottom: 1rem;
            }
            
            .facet-wrapper {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Skip links pour l'accessibilité -->
    <div class="fr-skiplinks">
        <nav class="fr-container" role="navigation" aria-label="Accès rapide">
            <ul class="fr-skiplinks__list">
                <li><a class="fr-link" href="#content">Contenu</a></li>
                <li><a class="fr-link" href="#widget-zone">Zone widgets</a></li>
                <li><a class="fr-link" href="#fr-footer">Pied de page</a></li>
            </ul>
        </nav>
    </div>

    <!-- Header DSFR -->
    <header role="banner" class="fr-header">
        <div class="fr-header__body">
            <div class="fr-container">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand fr-enlarge-link">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                                <p class="fr-logo">
                                    République
                                    <br>Française
                                </p>
                            </div>
                        </div>
                        <div class="fr-header__service">
                            <a href="/" title="Accueil - SignalConso">
                                <p class="fr-header__service-title">SignalConso</p>
                            </a>
                            <p class="fr-header__service-tagline">Signalements des consommateurs</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Contenu principal -->
    <main id="content" class="fr-container fr-py-6w">
        
        <!-- Application Angular -->
        <div ng-app="ods-widgets">
            
            <!-- Contexte dataset SignalConso -->
            <ods-dataset-context 
                context="signalconso" 
                signalconso-domain="data.economie.gouv.fr" 
                signalconso-dataset="signalconso"
                signalconso-parameters="{'disjunctive.category':true,'disjunctive.reg_name':true,'disjunctive.status':true,'disjunctive.creationdate':true}">
                
            <!-- Contexte séparé pour TestAlex pour éviter les interférences de filtres -->
            <ods-dataset-context 
                context="signalconsotest" 
                signalconsotest-domain="data.economie.gouv.fr" 
                signalconsotest-dataset="signalconso"
                signalconsotest-parameters="{'disjunctive.category':true,'disjunctive.reg_name':true,'disjunctive.status':true,'disjunctive.creationdate':true}">
                
                <!-- Titre et description -->
                <div class="fr-mb-4w">
                    <h1>Tableau de bord SignalConso</h1>
                    <p class="fr-text--lg">
                        Explorez les signalements des consommateurs avec des filtres avancés et des visualisations interactives.
                    </p>
                </div>

                <!-- DÉBUT ZONE WIDGET SIGNALCONSO -->
                <div id="widget-signalconso" class="widget-zone" data-widget-id="signalconso">
                    
                    <!-- Contenu principal sans panneau latéral -->
                    <div class="fr-container-fluid">
                            
                            <!-- Onglets pour différentes vues -->
                            <div class="fr-tabs">
                                <ul class="fr-tabs__list" role="tablist">
                                    <li role="presentation">
                                        <button id="tab-table-button" class="fr-tabs__tab" tabindex="0" role="tab" aria-selected="true" aria-controls="tab-table">
                                            Tableau
                                        </button>
                                    </li>
                                    <li role="presentation">
                                        <button id="tab-chart-button" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tab-chart">
                                            Graphiques
                                        </button>
                                    </li>
                                    <li role="presentation">
                                        <button id="tab-testalex-button" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tab-testalex">
                                            TestAlex
                                        </button>
                                    </li>
                                </ul>
                                
                                <!-- Panneau Tableau -->
                                <div id="tab-table" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel">
                                    
                                    <!-- Barre de recherche -->
                                    <div class="search-module fr-mb-3w">
                                        <div class="fr-search-bar" role="search">
                                            <label class="fr-label" for="search-signalconso">
                                                Rechercher dans les signalements
                                            </label>
                                            <input 
                                                type="text" 
                                                class="fr-input" 
                                                id="search-signalconso"
                                                ng-model="signalconso.parameters['q']"
                                                ng-model-options="{ debounce: 300 }"
                                                placeholder="Rechercher dans les signalements (catégorie, département, région, statut...)"
                                                aria-label="Rechercher dans les signalements">
                                            <button class="fr-btn" type="button" disabled>
                                                Rechercher
                                            </button>
                                        </div>
                                    </div>

                                    <!-- KPIs de PERFORMANCE - Métriques de suivi -->
                                    <h2 class="fr-h4">Indicateurs de performance</h2>
                                    <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w">
                                        <!-- Taux de traitement -->
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Taux de traitement</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">35%</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Résolu</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">
                                                            469K sur 1.3M signalements
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Volume total -->
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Volume global</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">1.3M</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Signalements</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">1,351,226 enregistrements</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Couverture territoriale -->
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Couverture</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">96</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Départements</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">
                                                            95% du territoire
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Catégories actives -->
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Diversité</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">32</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Catégories</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">Types de problèmes</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Filtres avec facettes ODS natives stylées DSFR -->
                                    <ods-facets context="signalconso">
                                        <!-- Filtres sur une seule ligne -->
                                        <div class="fr-grid-row fr-grid-row--gutters fr-mb-3w">
                                            <div class="fr-col-12 fr-col-md-3">
                                                <div class="facet-wrapper">
                                                    <h3 class="fr-text--sm fr-mb-1w">Région</h3>
                                                    <ods-facet name="reg_name" 
                                                              disjunctive="true"
                                                              facet-type="dropdown"
                                                              value-search="true"></ods-facet>
                                                </div>
                                            </div>
                                            <div class="fr-col-12 fr-col-md-3">
                                                <div class="facet-wrapper">
                                                    <h3 class="fr-text--sm fr-mb-1w">Catégorie</h3>
                                                    <ods-facet name="category" 
                                                              disjunctive="true"
                                                              facet-type="dropdown"
                                                              value-search="true"></ods-facet>
                                                </div>
                                            </div>
                                            <div class="fr-col-12 fr-col-md-3">
                                                <div class="facet-wrapper">
                                                    <h3 class="fr-text--sm fr-mb-1w">Année</h3>
                                                    <ods-facet name="creationdate" 
                                                              timeunit="year" 
                                                              disjunctive="true" 
                                                              sort="-alphanum"
                                                              facet-type="dropdown"></ods-facet>
                                                </div>
                                            </div>
                                            <div class="fr-col-12 fr-col-md-3">
                                                <div class="facet-wrapper">
                                                    <h3 class="fr-text--sm fr-mb-1w">Statut</h3>
                                                    <ods-facet name="status" 
                                                              disjunctive="true"
                                                              facet-type="dropdown"></ods-facet>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Bouton de réinitialisation -->
                                        <div class="fr-grid-row fr-mb-3w">
                                            <div class="fr-col-12">
                                                <ods-clear-all-filters context="signalconso">
                                                    <button class="fr-btn fr-btn--secondary fr-btn--sm">
                                                        <i class="fr-icon-refresh-line fr-icon--sm fr-mr-1w" aria-hidden="true"></i>
                                                        Réinitialiser tous les filtres
                                                    </button>
                                                </ods-clear-all-filters>
                                            </div>
                                        </div>
                                    </ods-facets>
                                    
                                    
                                    <!-- Nombre de résultats et filtres actifs -->
                                    <div class="fr-mb-2w" ods-result-context="signalconso">
                                        <div class="fr-text--sm fr-text-mention--grey">
                                            <strong>{{ signalconso.nhits | number }}</strong> signalements trouvés
                                            <span ng-if="signalconso.parameters['q']" class="fr-badge fr-badge--sm fr-badge--blue-cumulus fr-ml-1w">
                                                Recherche: {{ signalconso.parameters['q'] }}
                                            </span>
                                            <ods-filter-summary context="signalconso">
                                                <span ng-repeat="refinement in refinements" class="fr-badge fr-badge--sm fr-badge--green-tilleul-verveine fr-ml-1w">
                                                    <span ng-if="refinement.facet === 'category'">Catégorie: {{ refinement.path || refinement.value || refinement.label }}</span>
                                                    <span ng-if="refinement.facet === 'reg_name'">Région: {{ refinement.path || refinement.value || refinement.label }}</span>
                                                    <span ng-if="refinement.facet === 'status'">Statut: {{ refinement.path || refinement.value || refinement.label }}</span>
                                                    <span ng-if="refinement.facet === 'creationdate'">Année: {{ refinement.path || refinement.value || refinement.label }}</span>
                                                </span>
                                            </ods-filter-summary>
                                        </div>
                                    </div>
                                    
                                    <!-- Table des signalements -->
                                    <div class="ods-table-container">
                                        <ods-table 
                                            context="signalconso"
                                            displayed-fields="creationdate,category,subcategories,dep_code,reg_name,status"
                                            sort="-creationdate">
                                        </ods-table>
                                    </div>
                                    
                                    <!-- Pagination -->
                                    <ods-pager 
                                        context="signalconso"
                                        page-size="20">
                                    </ods-pager>
                                </div>
                                
                                <!-- Panneau Graphiques -->
                                <div id="tab-chart" class="fr-tabs__panel" role="tabpanel">
                                    
                                    <!-- Tuiles chiffres clés DSFR -->
                                    <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w">
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Total signalements</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">1.3M</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Enregistrements</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">1,351,226 au total</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Catégories actives</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">32</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Types</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">Problèmes identifiés</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Départements concernés</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">96</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Territoires</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">95% de couverture</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Régions touchées</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">13</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Régions</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">France métropolitaine</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Un graphique par ligne pour plus de lisibilité -->
                                    
                                    <!-- Section Évolution temporelle -->
                                    <div class="graph-section">
                                        <div class="fr-grid-row fr-grid-row--gutters">
                                            <div class="fr-col-12">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <h3 class="fr-card__title">Évolution temporelle des signalements</h3>
                                                        <p class="fr-text--sm fr-text-mention--grey fr-mb-2w">Nombre de signalements par mois</p>
                                                        <div class="fr-card__desc" style="height: 500px; padding-right: 50px; padding-left: 20px; padding-bottom: 30px;">
                                                            <ods-chart timescale="month" y-label="Nombre de signalements" align="right" display-legend="bottom">
                                                                <ods-chart-query 
                                                                    context="signalconso" 
                                                                    field-x="creationdate"
                                                                    timescale="month">
                                                                    <ods-chart-serie 
                                                                        chart-type="line"
                                                                        function-y="COUNT"
                                                                        label-y="Signalements"
                                                                        color="#000091"
                                                                        scientific-display="false">
                                                                    </ods-chart-serie>
                                                                </ods-chart-query>
                                                            </ods-chart>
                                                        </div>
                                                        <!-- Alternative textuelle -->
                                                        <details class="fr-accordion fr-mt-2w">
                                                            <summary class="fr-accordion__btn" style="cursor: pointer; padding: 0.75rem; background: #f6f6f6;">
                                                                Alternative textuelle du graphique
                                                            </summary>
                                                            <div style="padding: 1rem; background: white; border: 1px solid #ddd;">
                                                                <p class="fr-text--sm">
                                                                    <strong>Évolution mensuelle des signalements (données simulées) :</strong><br/>
                                                                    Les données montrent une tendance croissante des signalements sur les 12 derniers mois,
                                                                    avec des pics saisonniers lors des périodes de soldes et fêtes de fin d'année.
                                                                    Le volume moyen mensuel est d'environ 110 000 signalements.
                                                                </p>
                                                            </div>
                                                        </details>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Section Catégories -->
                                    <div class="graph-section">
                                        <div class="fr-grid-row fr-grid-row--gutters">
                                            <div class="fr-col-12">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <h3 class="fr-card__title">Top 10 catégories de signalements</h3>
                                                        <p class="fr-text--sm fr-text-mention--grey fr-mb-2w">Répartition par type de problème</p>
                                                        <div class="fr-card__desc" style="height: 500px; padding-right: 50px; padding-left: 20px; padding-bottom: 30px;">
                                                            <ods-chart labels-x-length="100" y-label="Nombre de signalements" align="right" display-legend="bottom">
                                                                <ods-chart-query 
                                                                    context="signalconso" 
                                                                    field-x="category"
                                                                    maxpoints="10"
                                                                    sort="serie1-1">
                                                                    <ods-chart-serie 
                                                                        chart-type="column"
                                                                        function-y="COUNT"
                                                                        label-y="Signalements"
                                                                        color="#000091"
                                                                        scientific-display="false">
                                                                    </ods-chart-serie>
                                                                </ods-chart-query>
                                                            </ods-chart>
                                                        </div>
                                                        <!-- Alternative textuelle -->
                                                        <details class="fr-accordion fr-mt-2w">
                                                            <summary class="fr-accordion__btn" style="cursor: pointer; padding: 0.75rem; background: #f6f6f6;">
                                                                Alternative textuelle du graphique
                                                            </summary>
                                                            <div style="padding: 1rem; background: white; border: 1px solid #ddd;">
                                                                <p class="fr-text--sm">
                                                                    <strong>Top 10 catégories de signalements :</strong><br/>
                                                                    1. Achat Internet : ~250 000 signalements (19%)<br/>
                                                                    2. Téléphonie/FAI/Médias : ~200 000 signalements (15%)<br/>
                                                                    3. Banque/Assurance/Mutuelle : ~180 000 signalements (14%)<br/>
                                                                    4. Services aux Particuliers : ~150 000 signalements (11%)<br/>
                                                                    5. Voyage/Loisirs : ~120 000 signalements (9%)<br/>
                                                                    6. Achat Magasin : ~100 000 signalements (8%)<br/>
                                                                    7. Eau/Gaz/Électricité : ~90 000 signalements (7%)<br/>
                                                                    8. Voiture/Véhicule : ~80 000 signalements (6%)<br/>
                                                                    9. Immobilier : ~70 000 signalements (5%)<br/>
                                                                    10. Santé : ~60 000 signalements (4%)
                                                                </p>
                                                            </div>
                                                        </details>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Section Régions -->
                                    <div class="graph-section">
                                        <div class="fr-grid-row fr-grid-row--gutters">
                                            <div class="fr-col-12">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <h3 class="fr-card__title">Répartition géographique par région</h3>
                                                        <p class="fr-text--sm fr-text-mention--grey fr-mb-2w">Distribution territoriale des signalements</p>
                                                        <div class="fr-card__desc" style="height: 500px; padding-right: 50px; padding-left: 20px; padding-bottom: 30px;">
                                                            <ods-chart labels-x-length="100" y-label="Nombre de signalements" align="right" display-legend="bottom">
                                                                <ods-chart-query 
                                                                    context="signalconso" 
                                                                    field-x="reg_name"
                                                                    maxpoints="20"
                                                                    sort="serie1-1">
                                                                    <ods-chart-serie 
                                                                        chart-type="column"
                                                                        function-y="COUNT"
                                                                        label-y="Signalements"
                                                                        color="#000091"
                                                                        scientific-display="false">
                                                                    </ods-chart-serie>
                                                                </ods-chart-query>
                                                            </ods-chart>
                                                        </div>
                                                        <!-- Alternative textuelle -->
                                                        <details class="fr-accordion fr-mt-2w">
                                                            <summary class="fr-accordion__btn" style="cursor: pointer; padding: 0.75rem; background: #f6f6f6;">
                                                                Alternative textuelle du graphique
                                                            </summary>
                                                            <div style="padding: 1rem; background: white; border: 1px solid #ddd;">
                                                                <p class="fr-text--sm">
                                                                    <strong>Répartition géographique par région :</strong><br/>
                                                                    1. Île-de-France : ~285 000 signalements (22%)<br/>
                                                                    2. Auvergne-Rhône-Alpes : ~156 000 signalements (12%)<br/>
                                                                    3. Provence-Alpes-Côte d'Azur : ~142 000 signalements (11%)<br/>
                                                                    4. Occitanie : ~130 000 signalements (10%)<br/>
                                                                    5. Nouvelle-Aquitaine : ~117 000 signalements (9%)<br/>
                                                                    6. Hauts-de-France : ~104 000 signalements (8%)<br/>
                                                                    7. Grand Est : ~91 000 signalements (7%)<br/>
                                                                    8. Pays de la Loire : ~78 000 signalements (6%)<br/>
                                                                    9. Bretagne : ~65 000 signalements (5%)<br/>
                                                                    10. Normandie : ~52 000 signalements (4%)<br/>
                                                                    Autres régions : ~96 000 signalements (7%)
                                                                </p>
                                                            </div>
                                                        </details>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Section Statuts -->
                                    <div class="graph-section">
                                        <div class="fr-grid-row fr-grid-row--gutters">
                                            <div class="fr-col-12">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <h3 class="fr-card__title">Répartition par statut de traitement</h3>
                                                        <p class="fr-text--sm fr-text-mention--grey fr-mb-2w">État d'avancement des dossiers</p>
                                                        <div class="fr-card__desc" style="height: 500px; padding-right: 50px; padding-left: 20px; padding-bottom: 30px;">
                                                            <ods-chart labels-x-length="100" y-label="Nombre de dossiers" align="right" display-legend="bottom">
                                                                <ods-chart-query 
                                                                    context="signalconso" 
                                                                    field-x="status"
                                                                    sort="serie1-1">
                                                                    <ods-chart-serie 
                                                                        chart-type="column"
                                                                        function-y="COUNT"
                                                                        label-y="Dossiers"
                                                                        color="#000091"
                                                                        scientific-display="false">
                                                                    </ods-chart-serie>
                                                                </ods-chart-query>
                                                            </ods-chart>
                                                        </div>
                                                        <!-- Alternative textuelle -->
                                                        <details class="fr-accordion fr-mt-2w">
                                                            <summary class="fr-accordion__btn" style="cursor: pointer; padding: 0.75rem; background: #f6f6f6;">
                                                                Alternative textuelle du graphique
                                                            </summary>
                                                            <div style="padding: 1rem; background: white; border: 1px solid #ddd;">
                                                                <p class="fr-text--sm">
                                                                    <strong>Répartition par statut de traitement :</strong><br/>
                                                                    - Transmis : ~460 000 dossiers (35%)<br/>
                                                                    - Promesse d'action : ~395 000 dossiers (30%)<br/>
                                                                    - Non transmis : ~263 000 dossiers (20%)<br/>
                                                                    - Infondé : ~132 000 dossiers (10%)<br/>
                                                                    - Non applicable : ~66 000 dossiers (5%)
                                                                </p>
                                                            </div>
                                                        </details>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Section Départements -->
                                    <div class="graph-section">
                                        <div class="fr-grid-row fr-grid-row--gutters">
                                            <div class="fr-col-12">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <h3 class="fr-card__title">Top 15 départements les plus concernés</h3>
                                                        <p class="fr-text--sm fr-text-mention--grey fr-mb-2w">Classement départemental par volume</p>
                                                        <div class="fr-card__desc" style="height: 500px; padding-right: 50px; padding-left: 20px; padding-bottom: 30px;">
                                                            <ods-chart labels-x-length="100" y-label="Nombre de signalements" align="right" display-legend="bottom">
                                                                <ods-chart-query 
                                                                    context="signalconso" 
                                                                    field-x="dep_name"
                                                                    maxpoints="15"
                                                                    sort="serie1-1">
                                                                    <ods-chart-serie 
                                                                        chart-type="column"
                                                                        function-y="COUNT"
                                                                        label-y="Signalements"
                                                                        color="#000091"
                                                                        scientific-display="false">
                                                                    </ods-chart-serie>
                                                                </ods-chart-query>
                                                            </ods-chart>
                                                        </div>
                                                        <!-- Alternative textuelle -->
                                                        <details class="fr-accordion fr-mt-2w">
                                                            <summary class="fr-accordion__btn" style="cursor: pointer; padding: 0.75rem; background: #f6f6f6;">
                                                                Alternative textuelle du graphique
                                                            </summary>
                                                            <div style="padding: 1rem; background: white; border: 1px solid #ddd;">
                                                                <p class="fr-text--sm">
                                                                    <strong>Top 15 départements les plus concernés :</strong><br/>
                                                                    1. Paris (75) : ~95 000 signalements<br/>
                                                                    2. Hauts-de-Seine (92) : ~65 000 signalements<br/>
                                                                    3. Nord (59) : ~58 000 signalements<br/>
                                                                    4. Bouches-du-Rhône (13) : ~55 000 signalements<br/>
                                                                    5. Rhône (69) : ~52 000 signalements<br/>
                                                                    6. Seine-Saint-Denis (93) : ~48 000 signalements<br/>
                                                                    7. Val-de-Marne (94) : ~45 000 signalements<br/>
                                                                    8. Yvelines (78) : ~42 000 signalements<br/>
                                                                    9. Gironde (33) : ~40 000 signalements<br/>
                                                                    10. Loire-Atlantique (44) : ~38 000 signalements<br/>
                                                                    11. Haute-Garonne (31) : ~36 000 signalements<br/>
                                                                    12. Seine-Maritime (76) : ~34 000 signalements<br/>
                                                                    13. Var (83) : ~32 000 signalements<br/>
                                                                    14. Alpes-Maritimes (06) : ~30 000 signalements<br/>
                                                                    15. Hérault (34) : ~28 000 signalements
                                                                </p>
                                                            </div>
                                                        </details>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Panneau TestAlex (Copie exacte du panneau Tableau) -->
                                <div id="tab-testalex" class="fr-tabs__panel" role="tabpanel">
                                    
                                    <!-- Barre de recherche -->
                                    <div class="search-module fr-mb-3w">
                                        <div class="fr-search-bar" role="search">
                                            <label class="fr-label" for="search-signalconso-test">
                                                Rechercher dans les signalements (Test)
                                            </label>
                                            <input 
                                                type="text" 
                                                class="fr-input" 
                                                id="search-signalconso-test"
                                                ng-model="signalconsotest.parameters['q']"
                                                ng-model-options="{ debounce: 300 }"
                                                placeholder="Rechercher dans les signalements (catégorie, département, région, statut...)"
                                                aria-label="Rechercher dans les signalements">
                                            <button class="fr-btn" type="button" disabled>
                                                Rechercher
                                            </button>
                                        </div>
                                    </div>

                                    <!-- KPIs de PERFORMANCE - Métriques de suivi -->
                                    <!-- Carte interactive des signalements -->
                                    <div class="fr-mb-4w">
                                        <h3 class="fr-h4">Carte des signalements</h3>
                                        <div style="height: 500px; border: 1px solid var(--border-default-grey); border-radius: 0.25rem; overflow: hidden;">
                                            <ods-map context="signalconsotest" 
                                                     location="12,46.5,2.5" 
                                                     basemap="jawg.streets"
                                                     toolbar-geolocation="false"
                                                     toolbar-drawing="false"
                                                     toolbar-fullscreen="true"
                                                     search-box="false"
                                                     min-zoom="5"
                                                     max-zoom="18">
                                                <ods-map-layer context="signalconsotest" 
                                                               color="#000091"
                                                               picto="ods-circle" 
                                                               size="4"
                                                               border-color="#ffffff"
                                                               border-size="1"
                                                               caption="true"
                                                               caption-picto-color="#000091"
                                                               title="Signalements ConsO"
                                                               description="Cliquez sur un point pour plus de détails">
                                                </ods-map-layer>
                                            </ods-map>
                                        </div>
                                    </div>
                                    
                                    <h2 class="fr-h4">Indicateurs de performance (Test)</h2>
                                    <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w">
                                        <!-- Taux de traitement -->
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Taux de traitement</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">35%</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Résolu</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">
                                                            469K sur 1.3M signalements
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Volume total -->
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Volume global</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">1.3M</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Signalements</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">1,351,226 enregistrements</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Couverture territoriale -->
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Couverture</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">96</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Départements</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">
                                                            95% du territoire
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Catégories actives -->
                                        <div class="fr-col-12 fr-col-md-3">
                                            <div class="fr-tile fr-tile--vertical fr-tile--no-icon">
                                                <div class="fr-tile__body">
                                                    <h4 class="fr-tile__title fr-text--sm fr-text--regular fr-mb-1v" style="font-size: 0.875rem !important; color: #666666;">Diversité</h4>
                                                    <div class="fr-tile__content">
                                                        <p class="fr-display--xs fr-text--bold fr-mb-0" style="color: #000091; font-size: 2.5rem !important;">32</p>
                                                        <p class="fr-text--sm fr-mb-0" style="color: #161616;">Catégories</p>
                                                        <p class="fr-text--xs fr-text--mention-grey fr-mt-1v">Types de problèmes</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Filtres avec facettes ODS natives stylées DSFR -->
                                    <ods-facets context="signalconsotest">
                                        <!-- Filtres sur une seule ligne -->
                                        <div class="fr-grid-row fr-grid-row--gutters fr-mb-3w">
                                            <div class="fr-col-12 fr-col-md-3">
                                                <div class="facet-wrapper">
                                                    <h3 class="fr-text--sm fr-mb-1w">Région</h3>
                                                    <ods-facet name="reg_name" 
                                                              disjunctive="true"
                                                              facet-type="dropdown"
                                                              value-search="true"></ods-facet>
                                                </div>
                                            </div>
                                            <div class="fr-col-12 fr-col-md-3">
                                                <div class="facet-wrapper">
                                                    <h3 class="fr-text--sm fr-mb-1w">Catégorie</h3>
                                                    <ods-facet name="category" 
                                                              disjunctive="true"
                                                              facet-type="dropdown"
                                                              value-search="true"></ods-facet>
                                                </div>
                                            </div>
                                            <div class="fr-col-12 fr-col-md-3">
                                                <div class="facet-wrapper">
                                                    <h3 class="fr-text--sm fr-mb-1w">Année</h3>
                                                    <ods-facet name="creationdate" 
                                                              timeunit="year" 
                                                              disjunctive="true" 
                                                              sort="-alphanum"
                                                              facet-type="dropdown"></ods-facet>
                                                </div>
                                            </div>
                                            <div class="fr-col-12 fr-col-md-3">
                                                <div class="facet-wrapper">
                                                    <h3 class="fr-text--sm fr-mb-1w">Statut</h3>
                                                    <ods-facet name="status" 
                                                              disjunctive="true"
                                                              facet-type="dropdown"></ods-facet>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Bouton de réinitialisation -->
                                        <div class="fr-grid-row fr-mb-3w">
                                            <div class="fr-col-12">
                                                <ods-clear-all-filters context="signalconsotest">
                                                    <button class="fr-btn fr-btn--secondary fr-btn--sm">
                                                        <i class="fr-icon-refresh-line fr-icon--sm fr-mr-1w" aria-hidden="true"></i>
                                                        Réinitialiser tous les filtres
                                                    </button>
                                                </ods-clear-all-filters>
                                            </div>
                                        </div>
                                    </ods-facets>
                                    
                                    
                                    <!-- Nombre de résultats et filtres actifs -->
                                    <div class="fr-mb-2w" ods-result-context="signalconsotest">
                                        <div class="fr-text--sm fr-text-mention--grey">
                                            <strong>{{ signalconsotest.nhits | number }}</strong> signalements trouvés
                                            <span ng-if="signalconsotest.parameters['q']" class="fr-badge fr-badge--sm fr-badge--blue-cumulus fr-ml-1w">
                                                Recherche: {{ signalconsotest.parameters['q'] }}
                                            </span>
                                            <ods-filter-summary context="signalconsotest">
                                                <span ng-repeat="refinement in refinements" class="fr-badge fr-badge--sm fr-badge--green-tilleul-verveine fr-ml-1w">
                                                    <span ng-if="refinement.facet === 'category'">Catégorie: {{ refinement.path || refinement.value || refinement.label }}</span>
                                                    <span ng-if="refinement.facet === 'reg_name'">Région: {{ refinement.path || refinement.value || refinement.label }}</span>
                                                    <span ng-if="refinement.facet === 'status'">Statut: {{ refinement.path || refinement.value || refinement.label }}</span>
                                                    <span ng-if="refinement.facet === 'creationdate'">Année: {{ refinement.path || refinement.value || refinement.label }}</span>
                                                </span>
                                            </ods-filter-summary>
                                        </div>
                                    </div>
                                    
                                    <!-- Affichage en cartes DSFR - Version simplifiée -->
                                    <div class="fr-container-fluid">
                                        <!-- Table cachée pour obtenir les données -->
                                        <div style="display: none;">
                                            <ods-table context="signalconsotest" 
                                                      ng-model="tableData">
                                            </ods-table>
                                        </div>
                                        
                                        <!-- Affichage des cartes -->
                                        <ods-results context="signalconsotest">
                                            <div class="fr-grid-row fr-grid-row--gutters" ng-if="results && results.length > 0">
                                                <div ng-repeat="item in results | limitTo:12" class="fr-col-12 fr-col-md-6 fr-col-lg-4 fr-mb-3w">
                                                    <div class="fr-card">
                                                        <div class="fr-card__body">
                                                            <div class="fr-card__content">
                                                                <h3 class="fr-card__title">
                                                                    {{ item.fields.category || 'Non catégorisé' }}
                                                                </h3>
                                                                <div class="fr-card__desc fr-text--sm">
                                                                    <p class="fr-mb-1w">
                                                                        <strong>Date :</strong> {{ item.fields.creationdate | date:'dd/MM/yyyy' }}
                                                                    </p>
                                                                    <p class="fr-mb-1w" ng-if="item.fields.nom_etablissement">
                                                                        <strong>Établissement :</strong> {{ item.fields.nom_etablissement }}
                                                                    </p>
                                                                    <p class="fr-mb-1w">
                                                                        <strong>Localisation :</strong><br>
                                                                        {{ item.fields.ville || 'Ville non renseignée' }}<br>
                                                                        {{ item.fields.dep_code }} - {{ item.fields.dep_name }}<br>
                                                                        {{ item.fields.reg_name }}
                                                                    </p>
                                                                    <p class="fr-mb-1w" ng-if="item.fields.subcategories">
                                                                        <strong>Détails :</strong><br>
                                                                        {{ item.fields.subcategories | limitTo:100 }}
                                                                    </p>
                                                                </div>
                                                                <div class="fr-card__start">
                                                                    <p class="fr-badge fr-badge--sm" 
                                                                       ng-class="{
                                                                           'fr-badge--success': item.fields.status === 'PromesseAction' || item.fields.status === 'Transmis',
                                                                           'fr-badge--warning': item.fields.status === 'NonTransmis',
                                                                           'fr-badge--info': item.fields.status === 'NA'
                                                                       }">
                                                                        {{ item.fields.status || 'Non défini' }}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Message si aucun résultat -->
                                            <div ng-if="nhits === 0" class="fr-alert fr-alert--info">
                                                <p>Aucun signalement trouvé pour ces critères.</p>
                                            </div>
                                        </ods-results>
                                        
                                        <!-- Pagination -->
                                        <div class="fr-mt-4w" ng-if="signalconsotest.nhits > 12">
                                            <ods-pager context="signalconsotest" page-size="12"></ods-pager>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            
                            <!-- Actions d'export -->
                            <div class="fr-mt-4w">
                                <div class="fr-btns-group fr-btns-group--inline">
                                    <button class="fr-btn"
                                            onclick="window.open('https://data.economie.gouv.fr/explore/dataset/signalconso/export/?format=csv', '_blank')">
                                        Télécharger toutes les données au format CSV
                                    </button>
                                    <button class="fr-btn"
                                            onclick="window.open('https://data.economie.gouv.fr/explore/dataset/signalconso/export/?format=xls', '_blank')">
                                        Télécharger toutes les données au format Excel
                                    </button>
                                </div>
                            </div>
                    </div>
                </div>
                <!-- FIN ZONE WIDGET SIGNALCONSO -->
                
            </ods-dataset-context>
            </ods-dataset-context>
        </div>
    </main>

    <!-- Footer DSFR -->
    <footer class="fr-footer" role="contentinfo" id="fr-footer">
        <div class="fr-container">
            <div class="fr-footer__body">
                <div class="fr-footer__brand fr-enlarge-link">
                    <p class="fr-logo">
                        République
                        <br>Française
                    </p>
                </div>
                <div class="fr-footer__content">
                    <p class="fr-footer__content-desc">
                        SignalConso permet aux consommateurs de signaler des problèmes rencontrés avec des entreprises.
                    </p>
                    <ul class="fr-footer__content-list">
                        <li class="fr-footer__content-item">
                            <a class="fr-footer__content-link" href="https://signal.conso.gouv.fr">signal.conso.gouv.fr</a>
                        </li>
                        <li class="fr-footer__content-item">
                            <a class="fr-footer__content-link" href="https://data.economie.gouv.fr">data.economie.gouv.fr</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="fr-footer__bottom">
                <ul class="fr-footer__bottom-list">
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Accessibilité : conforme</a>
                    </li>
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Mentions légales</a>
                    </li>
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Données personnelles</a>
                    </li>
                </ul>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- jQuery requis pour ODS widgets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Angular et dépendances -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-sanitize/1.8.2/angular-sanitize.min.js"></script>
    <!-- ODS Widgets -->
    <script src="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.min.js"></script>
    <!-- DSFR en dernier pour éviter les conflits -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.nomodule.min.js"></script>
    
    <!-- Script pour gérer les onglets DSFR et initialisation -->
    <script>
        // Configuration pour supprimer l'avertissement Highcharts sur l'accessibilité
        if (window.Highcharts) {
            Highcharts.setOptions({
                accessibility: {
                    enabled: false
                }
            });
        }
        
        // Contrôleur Angular pour les filtres
        angular.module('ods-widgets').controller('FiltersController', ['$scope', function($scope) {
            var ctrl = this;
            
            // Initialisation des tableaux
            ctrl.categories = [];
            ctrl.regions = [];
            ctrl.statuses = [];
            ctrl.selectedCategory = '';
            ctrl.selectedRegion = '';
            ctrl.selectedStatus = '';
            ctrl.context = null;
            
            ctrl.init = function(context) {
                ctrl.context = context;
            };
            
            // Mise à jour des catégories depuis l'analyse ODS
            ctrl.updateCategories = function(results) {
                if (results && results.length > 0) {
                    ctrl.categories = results.map(function(item) {
                        return {
                            value: item.x,
                            label: item.x + ' (' + Math.round(item.count).toLocaleString('fr-FR') + ')'
                        };
                    });
                }
                return '';
            };
            
            // Mise à jour des régions
            ctrl.updateRegions = function(results) {
                if (results && results.length > 0) {
                    ctrl.regions = results.map(function(item) {
                        return {
                            value: item.x,
                            label: item.x + ' (' + Math.round(item.count).toLocaleString('fr-FR') + ')'
                        };
                    });
                }
                return '';
            };
            
            // Mise à jour des statuts
            ctrl.updateStatuses = function(results) {
                if (results && results.length > 0) {
                    ctrl.statuses = results.map(function(item) {
                        return {
                            value: item.x,
                            label: item.x + ' (' + Math.round(item.count).toLocaleString('fr-FR') + ')'
                        };
                    });
                }
                return '';
            };
            
            // Application d'un filtre
            ctrl.applyFilter = function(field, value) {
                if (ctrl.context) {
                    if (value) {
                        ctrl.context.parameters['refine.' + field] = value;
                    } else {
                        delete ctrl.context.parameters['refine.' + field];
                    }
                }
            };
            
            // Réinitialisation de tous les filtres
            ctrl.resetFilters = function() {
                ctrl.selectedCategory = '';
                ctrl.selectedRegion = '';
                ctrl.selectedStatus = '';
                if (ctrl.context) {
                    delete ctrl.context.parameters['refine.category'];
                    delete ctrl.context.parameters['refine.reg_name'];
                    delete ctrl.context.parameters['refine.status'];
                }
            };
        }]);
        
        // Fonction pour afficher/masquer le code d'un widget
        function toggleCode(widgetId) {
            const codeSection = document.getElementById('code-' + widgetId);
            const button = event.currentTarget;
            const isExpanded = button.getAttribute('aria-expanded') === 'true';
            
            if (isExpanded) {
                codeSection.style.display = 'none';
                button.setAttribute('aria-expanded', 'false');
            } else {
                codeSection.style.display = 'block';
                button.setAttribute('aria-expanded', 'true');
            }
        }
        
        // Attendre que tous les scripts soient chargés
        window.addEventListener('load', function() {
            // Initialisation DSFR après un délai pour éviter les conflits
            setTimeout(function() {
                // Gestion des onglets
                const tabs = document.querySelectorAll('.fr-tabs__tab');
                const panels = document.querySelectorAll('.fr-tabs__panel');
                
                if (tabs.length > 0 && panels.length > 0) {
                    tabs.forEach((tab, index) => {
                        tab.addEventListener('click', function() {
                            // Réinitialiser tous les onglets
                            tabs.forEach(t => {
                                t.setAttribute('aria-selected', 'false');
                                t.setAttribute('tabindex', '-1');
                            });
                            panels.forEach(p => {
                                p.classList.remove('fr-tabs__panel--selected');
                            });
                            
                            // Activer l'onglet cliqué
                            this.setAttribute('aria-selected', 'true');
                            this.setAttribute('tabindex', '0');
                            if (panels[index]) {
                                panels[index].classList.add('fr-tabs__panel--selected');
                            }
                        });
                    });
                }
                
                // Fix pour les tables DSFR
                const tableWrappers = document.querySelectorAll('.fr-table__wrapper');
                tableWrappers.forEach(wrapper => {
                    if (!wrapper.querySelector('.fr-table__container')) {
                        wrapper.classList.add('fr-table__wrapper--no-scroll');
                    }
                });
                
                // Formater les nombres dans les facettes (arrondir sans virgule et ajouter parenthèses)
                var formatFacets = function() {
                    // Formater les nombres dans les dropdowns
                    const facetCounts = document.querySelectorAll('.odswidget-facet-category-value-count');
                    facetCounts.forEach(count => {
                        const text = count.textContent.trim();
                        if (text && !text.startsWith('(')) {
                            // Extraire le nombre et l'arrondir
                            const number = Math.round(parseFloat(text.replace(/[^\d.]/g, '')));
                            if (!isNaN(number)) {
                                // Formater avec séparateur de milliers et parenthèses
                                count.textContent = '(' + number.toLocaleString('fr-FR') + ')';
                            }
                        }
                    });
                    
                    // Formater aussi les nombres dans les boutons de facettes
                    const facetButtons = document.querySelectorAll('.odswidget-facet-dropdown__button');
                    facetButtons.forEach(button => {
                        const text = button.textContent;
                        // Vérifier si le texte contient un nombre à la fin
                        const match = text.match(/(.*?)\s*\((\d+(?:\.\d+)?)\)/);
                        if (match) {
                            const label = match[1];
                            const number = Math.round(parseFloat(match[2]));
                            button.textContent = label + ' (' + number.toLocaleString('fr-FR') + ')';
                        }
                    });
                };
                
                // Exécuter toutes les 500ms pour capturer les changements dynamiques
                setInterval(formatFacets, 500);
                // Exécuter immédiatement aussi
                formatFacets();
                
                // Améliorer l'interaction avec les facettes dropdown
                var enhanceDropdowns = function() {
                    // S'assurer que les dropdowns fonctionnent correctement
                    document.querySelectorAll('.odswidget-facet-dropdown').forEach(dropdown => {
                        const button = dropdown.querySelector('.odswidget-facet-dropdown__button');
                        const menu = dropdown.querySelector('.odswidget-facet-dropdown__menu, .odswidget-facet-dropdown__dropdown');
                        
                        if (button && menu) {
                            // Forcer l'affichage correct du menu
                            button.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const isOpen = dropdown.classList.contains('odswidget-facet-dropdown--open');
                                
                                // Fermer tous les autres dropdowns
                                document.querySelectorAll('.odswidget-facet-dropdown').forEach(d => {
                                    if (d !== dropdown) {
                                        d.classList.remove('odswidget-facet-dropdown--open');
                                    }
                                });
                                
                                // Toggle le dropdown actuel
                                if (!isOpen) {
                                    dropdown.classList.add('odswidget-facet-dropdown--open');
                                    menu.style.display = 'block';
                                    menu.style.visibility = 'visible';
                                    menu.style.opacity = '1';
                                } else {
                                    dropdown.classList.remove('odswidget-facet-dropdown--open');
                                    menu.style.display = 'none';
                                    menu.style.visibility = 'hidden';
                                    menu.style.opacity = '0';
                                }
                            });
                            
                            // Gestion du clavier
                            button.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter' || e.key === ' ') {
                                    e.preventDefault();
                                    button.click();
                                }
                                if (e.key === 'Escape') {
                                    dropdown.classList.remove('odswidget-facet-dropdown--open');
                                    menu.style.display = 'none';
                                }
                            });
                        }
                    });
                    
                    // Fermer les dropdowns quand on clique à l'extérieur
                    document.addEventListener('click', function(e) {
                        if (!e.target.closest('.odswidget-facet-dropdown')) {
                            document.querySelectorAll('.odswidget-facet-dropdown').forEach(dropdown => {
                                dropdown.classList.remove('odswidget-facet-dropdown--open');
                                const menu = dropdown.querySelector('.odswidget-facet-dropdown__menu, .odswidget-facet-dropdown__dropdown');
                                if (menu) {
                                    menu.style.display = 'none';
                                }
                            });
                        }
                    });
                };
                
                // Exécuter après un délai pour s'assurer que les dropdowns sont chargés
                setTimeout(enhanceDropdowns, 1000);
                // Ré-exécuter périodiquement pour capturer les nouveaux éléments
                setInterval(enhanceDropdowns, 2000);
                
                // Traduction des éléments ODS en français
                var translateODS = function() {
                    // Traduire les boutons d'action des facettes
                    document.querySelectorAll('.odswidget-facet-category-link').forEach(link => {
                        if (link.textContent === 'Clear all') link.textContent = 'Tout effacer';
                        if (link.textContent === 'More') link.textContent = 'Plus';
                        if (link.textContent === 'Less') link.textContent = 'Moins';
                    });
                    
                    // Traduire TOUS les boutons et actions dans les facettes
                    document.querySelectorAll('.odswidget-facet button, .odswidget-facet-see-more, .odswidget-facet__see-more, .odswidget-facet a, .odswidget-facet-category button').forEach(element => {
                        const text = element.textContent.trim();
                        // Clear all doit être traité en premier et complètement
                        if (text === 'Clear all' || text === 'Clear All') {
                            element.textContent = 'Tout effacer';
                        } else if (text.includes('Clear all') || text.includes('Clear All')) {
                            element.textContent = element.textContent.replace(/Clear [Aa]ll/g, 'Tout effacer');
                        } else if (text === 'More') {
                            element.textContent = 'Voir plus';
                        } else if (text === 'Less') {
                            element.textContent = 'Voir moins';
                        } else if (text.includes('More')) {
                            element.textContent = text.replace('More', 'Voir plus');
                        } else if (text.includes('Less')) {
                            element.textContent = text.replace('Less', 'Voir moins');
                        } else if (text === 'Clear') {
                            element.textContent = 'Effacer';
                        }
                    });
                    
                    // Traduire spécifiquement les spans dans les liens Clear all
                    document.querySelectorAll('.odswidget-clear-all-filters span, .odswidget-facet span').forEach(span => {
                        if (span.textContent.trim() === 'Clear all' || span.textContent.trim() === 'Clear All') {
                            span.textContent = 'Tout effacer';
                        }
                    });
                    
                    // Nettoyer les badges de filtres
                    document.querySelectorAll('.fr-badge--green-tilleul-verveine').forEach(badge => {
                        let text = badge.textContent.trim();
                        
                        // Nettoyer toutes les variantes pour les régions
                        if (text.includes('Nom Officiel Région')) {
                            let regionName = text.replace('Région:', '').replace('Nom Officiel Région', '').trim();
                            badge.textContent = 'Région: ' + regionName;
                        }
                        // Nettoyer "Date" pour les années
                        else if (text.includes('Date ')) {
                            let year = text.replace('Année:', '').replace('Date', '').trim();
                            badge.textContent = 'Année: ' + year;
                        }
                        // Nettoyer "category" en minuscules et formater les catégories
                        else if (text.includes('category') || text.includes('Catégorie:')) {
                            let category = text.replace('Catégorie:', '').replace('category', '').trim();
                            // Formater les catégories connues
                            if (category === 'CafeRestaurant') {
                                category = 'Café / Restaurant';
                            } else if (category === 'ServicesAuxParticuliers') {
                                category = 'Services aux particuliers';
                            } else if (category === 'AchatMagasin') {
                                category = 'Achat (Magasin)';
                            } else if (category === 'AchatInternet') {
                                category = 'Achat (Internet)';
                            } else if (category === 'EauGazElectricite') {
                                category = 'Eau / Gaz / Électricité';
                            } else if (category === 'BanqueAssuranceMutuelle') {
                                category = 'Banque / Assurance / Mutuelle';
                            } else if (category === 'VoyageLoisirs') {
                                category = 'Voyage / Loisirs';
                            } else if (category === 'TelephonieFaiMedias') {
                                category = 'Téléphonie / FAI / Médias';
                            } else if (category === 'Immobilier') {
                                category = 'Immobilier';
                            } else if (category === 'TravauxRenovation') {
                                category = 'Travaux / Rénovation';
                            } else if (category === 'VoitureVehicule') {
                                category = 'Voiture / Véhicule';
                            } else if (category === 'AnimauxDomestiques') {
                                category = 'Animaux domestiques';
                            } else if (category === 'Sante') {
                                category = 'Santé';
                            } else if (category === 'TelEauGazElec') {
                                category = 'Télécom / Eau / Gaz / Élec';
                            } else if (category === 'PrixEtPaiement' || category === 'Prix et paiement') {
                                category = 'Prix et paiement';
                            }
                            badge.textContent = 'Catégorie: ' + category;
                        }
                        // S'assurer que Statut a bien son préfixe
                        else if (!text.startsWith('Statut:') && !text.startsWith('Région:') && !text.startsWith('Année:') && !text.startsWith('Catégorie:')) {
                            // C'est probablement un statut sans préfixe
                            if (!text.includes(':')) {
                                badge.textContent = 'Statut: ' + text;
                            }
                        }
                    });
                    
                    // Traduire les textes dans les dropdowns
                    document.querySelectorAll('.odswidget-facet-dropdown__action, .odswidget-facet-dropdown button').forEach(button => {
                        const text = button.textContent.trim();
                        if (text === 'Clear all' || text === 'Clear All') button.textContent = 'Tout effacer';
                        if (text === 'Apply') button.textContent = 'Appliquer';
                        if (text === 'Cancel') button.textContent = 'Annuler';
                        if (text === 'More') button.textContent = 'Plus';
                        if (text === 'Less') button.textContent = 'Moins';
                    });
                    
                    // Traduire les placeholders de recherche dans les facettes
                    document.querySelectorAll('.odswidget-facet-search input').forEach(input => {
                        if (input.placeholder === 'Search' || input.placeholder === 'Search...') {
                            input.placeholder = 'Rechercher...';
                        }
                    });
                    
                    // Traduire les tooltips et aria-labels
                    document.querySelectorAll('[aria-label]').forEach(elem => {
                        const label = elem.getAttribute('aria-label');
                        if (label === 'Clear all filters') elem.setAttribute('aria-label', 'Effacer tous les filtres');
                        if (label === 'Search') elem.setAttribute('aria-label', 'Rechercher');
                        if (label === 'Close') elem.setAttribute('aria-label', 'Fermer');
                        if (label === 'Open dropdown') elem.setAttribute('aria-label', 'Ouvrir le menu déroulant');
                    });
                    
                    // Traduire les boutons de pagination
                    document.querySelectorAll('.odswidget-pagination__button, .odswidget-pager__page').forEach(button => {
                        if (button.textContent === 'Previous') button.textContent = 'Précédent';
                        if (button.textContent === 'Next') button.textContent = 'Suivant';
                        if (button.textContent === 'First') button.textContent = 'Première';
                        if (button.textContent === 'Last') button.textContent = 'Dernière';
                    });
                    
                    // Traduire les textes "No results"
                    document.querySelectorAll('.odswidget-facet__no-results').forEach(elem => {
                        if (elem.textContent.includes('No results')) {
                            elem.textContent = 'Aucun résultat';
                        }
                    });
                    
                    // Traduire dans les tooltips et aria-labels
                    document.querySelectorAll('[aria-label]').forEach(elem => {
                        const label = elem.getAttribute('aria-label');
                        if (label === 'Clear all' || label === 'Clear All') elem.setAttribute('aria-label', 'Tout effacer');
                        if (label === 'Show more' || label === 'More') elem.setAttribute('aria-label', 'Voir plus');
                        if (label === 'Show less' || label === 'Less') elem.setAttribute('aria-label', 'Voir moins');
                    });
                };
                
                // Exécuter la traduction régulièrement pour capturer les éléments dynamiques
                setInterval(translateODS, 200);
                translateODS();
                
                // Empêcher la soumission des formulaires de recherche ODS
                document.addEventListener('submit', function(e) {
                    // Empêcher toute soumission de formulaire qui contient un ods-searchbox
                    if (e.target.querySelector('.odswidget-searchbox__box') || 
                        e.target.querySelector('ods-searchbox') ||
                        e.target.classList.contains('odswidget-searchbox')) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                });
                
                // Intercepter les touches Enter dans les champs de recherche
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.target.classList.contains('odswidget-searchbox__box')) {
                        e.preventDefault();
                        e.stopPropagation();
                        // La recherche ODS se fait automatiquement via Angular
                        return false;
                    }
                });
                
                // Gestion des paramètres d'URL pour les onglets
                function handleTabFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const tab = urlParams.get('tab');
                    
                    if (tab === 'tableau' || tab === 'table') {
                        // Activer l'onglet Tableau
                        document.getElementById('tab-table-button')?.click();
                    } else if (tab === 'graphiques' || tab === 'chart' || tab === 'graphique') {
                        // Activer l'onglet Graphiques
                        document.getElementById('tab-chart-button')?.click();
                    } else if (tab === 'testalex' || tab === 'test') {
                        // Activer l'onglet TestAlex
                        document.getElementById('tab-testalex-button')?.click();
                    }
                }
                
                // Appliquer le paramètre d'URL au chargement
                window.addEventListener('DOMContentLoaded', handleTabFromURL);
                
                // Mettre à jour l'URL quand on change d'onglet
                document.querySelectorAll('.fr-tabs__tab').forEach(button => {
                    button.addEventListener('click', function() {
                        const tabId = this.getAttribute('aria-controls');
                        const urlParams = new URLSearchParams(window.location.search);
                        
                        if (tabId === 'tab-table') {
                            urlParams.set('tab', 'tableau');
                        } else if (tabId === 'tab-chart') {
                            urlParams.set('tab', 'graphiques');
                        } else if (tabId === 'tab-testalex') {
                            urlParams.set('tab', 'testalex');
                        }
                        
                        // Mettre à jour l'URL sans recharger la page
                        const newUrl = window.location.pathname + '?' + urlParams.toString() + window.location.hash;
                        window.history.replaceState(null, '', newUrl);
                    });
                });
                
                // Monitoring des appels API data.economie.gouv.fr
                (function() {
                    // Intercepter XMLHttpRequest
                    const originalOpen = XMLHttpRequest.prototype.open;
                    const originalSend = XMLHttpRequest.prototype.send;
                    
                    XMLHttpRequest.prototype.open = function(method, url) {
                        this._requestMethod = method;
                        this._requestURL = url;
                        this._requestTime = Date.now();
                        return originalOpen.apply(this, arguments);
                    };
                    
                    XMLHttpRequest.prototype.send = function(body) {
                        const xhr = this;
                        
                        // Log de la requête si c'est vers data.economie.gouv.fr
                        if (xhr._requestURL && xhr._requestURL.includes('data.economie.gouv.fr')) {
                            console.group('%c📡 API Call - ' + xhr._requestMethod + ' Request', 'color: #000091; font-weight: bold; font-size: 12px;');
                            console.log('%cURL:', 'font-weight: bold;', xhr._requestURL);
                            
                            // Parser les paramètres de l'URL
                            try {
                                const url = new URL(xhr._requestURL, window.location.origin);
                                const params = Object.fromEntries(url.searchParams);
                                if (Object.keys(params).length > 0) {
                                    console.log('%cParameters:', 'font-weight: bold;');
                                    console.table(params);
                                }
                            } catch(e) {
                                // Ignorer les erreurs de parsing
                            }
                            
                            if (body) {
                                console.log('%cRequest Body:', 'font-weight: bold;', body);
                            }
                            console.groupEnd();
                        }
                        
                        // Intercepter la réponse
                        xhr.addEventListener('load', function() {
                            if (xhr._requestURL && xhr._requestURL.includes('data.economie.gouv.fr')) {
                                const duration = Date.now() - xhr._requestTime;
                                
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    
                                    console.group('%c✅ API Response - ' + xhr.status + ' ' + xhr.statusText, 'color: #18753C; font-weight: bold; font-size: 12px;');
                                    console.log('%cURL:', 'font-weight: bold;', xhr._requestURL);
                                    console.log('%cDuration:', 'font-weight: bold;', duration + 'ms');
                                    console.log('%cStatus:', 'font-weight: bold;', xhr.status);
                                    
                                    // Statistiques sur les données
                                    if (response.nhits !== undefined) {
                                        console.log('%cTotal Records:', 'font-weight: bold; color: #000091;', response.nhits.toLocaleString('fr-FR'));
                                    }
                                    
                                    if (response.records && response.records.length > 0) {
                                        console.log('%cRecords Returned:', 'font-weight: bold;', response.records.length);
                                        
                                        // Afficher un échantillon des données
                                        if (response.records.length > 0) {
                                            console.log('%cFirst Record Sample:', 'font-weight: bold;');
                                            console.table(response.records[0].fields);
                                        }
                                    }
                                    
                                    // Afficher les facettes si présentes
                                    if (response.facet_groups && response.facet_groups.length > 0) {
                                        console.log('%cFacets:', 'font-weight: bold; color: #666666;');
                                        response.facet_groups.forEach(facetGroup => {
                                            console.group('📊 ' + facetGroup.name);
                                            const facetData = facetGroup.facets.slice(0, 10).map(f => ({
                                                'Valeur': f.name,
                                                'Nombre': f.count.toLocaleString('fr-FR'),
                                                'Pourcentage': ((f.count / response.nhits) * 100).toFixed(1) + '%'
                                            }));
                                            console.table(facetData);
                                            if (facetGroup.facets.length > 10) {
                                                console.log('... et ' + (facetGroup.facets.length - 10) + ' autres valeurs');
                                            }
                                            console.groupEnd();
                                        });
                                    }
                                    
                                    // Données brutes complètes disponibles
                                    console.log('%cFull Response Data:', 'font-weight: bold;', response);
                                    console.groupEnd();
                                    
                                } catch(e) {
                                    // Si ce n'est pas du JSON, log simple
                                    console.group('%c✅ API Response', 'color: #18753C; font-weight: bold;');
                                    console.log('URL:', xhr._requestURL);
                                    console.log('Duration:', duration + 'ms');
                                    console.log('Response:', xhr.responseText);
                                    console.groupEnd();
                                }
                            }
                        });
                        
                        // Intercepter les erreurs
                        xhr.addEventListener('error', function() {
                            if (xhr._requestURL && xhr._requestURL.includes('data.economie.gouv.fr')) {
                                console.group('%c❌ API Error', 'color: #CE0500; font-weight: bold; font-size: 12px;');
                                console.error('URL:', xhr._requestURL);
                                console.error('Status:', xhr.status);
                                console.error('Error:', xhr.statusText);
                                console.groupEnd();
                            }
                        });
                        
                        return originalSend.apply(this, arguments);
                    };
                    
                    console.log('%c🔍 API Monitoring Active', 'background: #000091; color: white; padding: 5px 10px; border-radius: 4px; font-weight: bold;');
                    console.log('%cTous les appels vers data.economie.gouv.fr seront affichés dans la console', 'color: #666666; font-style: italic;');
                })();
            }, 100);
        });
    </script>
</body>
</html>