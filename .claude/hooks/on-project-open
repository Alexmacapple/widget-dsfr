#!/bin/bash

# Hook Claude Code - DÃ©marrage automatique des services

echo "ğŸš€ Initialisation de l'environnement Widget DSFR..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# SECTION 1: ACTIVATION DES SERVEURS MCP
echo ""
echo "ğŸ”§ Activation des serveurs MCP..."

# VÃ©rifier le serveur Docker DSFR MCP
echo "  â€¢ VÃ©rification du serveur DSFR MCP Docker..."
if docker ps | grep -q dsfr-mcp-server 2>/dev/null; then
    echo "    âœ… Serveur DSFR MCP Docker dÃ©jÃ  actif"
    if curl -s http://localhost:3001/dashboard > /dev/null 2>&1; then
        echo "    âœ… Dashboard accessible : http://localhost:3001/dashboard"
    fi
elif docker ps -a | grep -q dsfr-mcp-server 2>/dev/null; then
    echo "    ğŸ”„ RedÃ©marrage du conteneur DSFR MCP..."
    docker start dsfr-mcp-server > /dev/null 2>&1
    sleep 2
    if docker ps | grep -q dsfr-mcp-server 2>/dev/null; then
        echo "    âœ… Serveur DSFR MCP Docker redÃ©marrÃ©"
    else
        echo "    âš ï¸  Impossible de redÃ©marrer le serveur DSFR MCP"
    fi
else
    echo "    âš ï¸  Conteneur DSFR MCP non trouvÃ©"
fi

# VÃ©rifier la configuration MCP
echo "  â€¢ VÃ©rification de la configuration MCP..."
if [ -f ".mcp.json" ]; then
    if grep -q "docker.*exec.*dsfr-mcp-server" .mcp.json 2>/dev/null; then
        echo "    âœ… Configuration MCP utilise Docker"
    else
        echo "    âš ï¸  Configuration MCP utilise Node.js local"
        if [ -f ".mcp-docker.json" ]; then
            echo "    ğŸ”„ Activation de la configuration Docker..."
            cp .mcp.json .mcp-local.backup.json 2>/dev/null
            cp .mcp-docker.json .mcp.json
            echo "    âœ… Configuration Docker activÃ©e"
        fi
    fi
else
    echo "    âš ï¸  Fichier .mcp.json non trouvÃ©"
fi

# Ã‰tat des serveurs MCP
echo ""
echo "  ğŸ“Š Ã‰tat des serveurs MCP :"
if command -v claude > /dev/null 2>&1; then
    claude mcp list 2>/dev/null | grep -E "dsfr-mcp|context7|angular-mcp" | sed 's/^/    /'
else
    echo "    â„¹ï¸  CLI Claude non disponible"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# SECTION 2: DÃ‰MARRAGE DU SERVEUR WEB
echo ""
echo "ğŸŒ DÃ©marrage du serveur web pour les widgets..."

# VÃ©rifier si un serveur est dÃ©jÃ  en cours
if [ -f /tmp/widget-server.pid ]; then
    OLD_PID=$(cat /tmp/widget-server.pid)
    if ps -p $OLD_PID > /dev/null 2>&1; then
        echo "â„¹ï¸  Serveur web dÃ©jÃ  actif (PID: $OLD_PID)"
        PORT=$(lsof -p $OLD_PID -P -n 2>/dev/null | grep LISTEN | awk '{print $9}' | cut -d':' -f2 | head -1)
        if [ ! -z "$PORT" ]; then
            echo "ğŸ“ Port $PORT : http://localhost:$PORT/widget-dsfr-ods/index.html"
        fi
    else
        rm -f /tmp/widget-server.pid
        # DÃ©marrer le serveur
        for port in 8080 8081 8082; do
            if ! lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
                nohup python3 -m http.server $port > /tmp/widget-server.log 2>&1 &
                echo $! > /tmp/widget-server.pid
                sleep 1
                echo "âœ… Serveur web dÃ©marrÃ© sur le port $port"
                echo "ğŸ“ http://localhost:$port/widget-dsfr-ods/index.html"
                break
            fi
        done
    fi
else
    # DÃ©marrer le serveur
    for port in 8080 8081 8082; do
        if ! lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
            nohup python3 -m http.server $port > /tmp/widget-server.log 2>&1 &
            echo $! > /tmp/widget-server.pid
            sleep 1
            echo "âœ… Serveur web dÃ©marrÃ© sur le port $port"
            echo "ğŸ“ http://localhost:$port/widget-dsfr-ods/index.html"
            break
        fi
    done
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âœ… Environnement prÃªt !"
echo ""
