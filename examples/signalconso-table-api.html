<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Table SignalConso API - DSFR</title>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/utility/icons/icons.min.css">
    
    <style>
        .widget-container {
            margin: 2rem 0;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .fr-table th {
            background-color: var(--background-alt-blue-france);
            color: var(--text-inverted-grey);
            white-space: nowrap;
        }
        .fr-table td {
            vertical-align: top;
        }
        .risk-cell {
            max-width: 300px;
        }
        .product-cell {
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="fr-container">
        <div class="fr-grid-row fr-grid-row--center">
            <div class="fr-col-12">
                <h1>Tableau des rappels produits SignalConso</h1>
                
                <!-- DÉBUT ZONE WIDGET signalconso-table-api-001 -->
                <div id="widget-signalconso-table-api-001" class="widget-container">
                    
                    <!-- Filtres -->
                    <div class="fr-search-bar fr-mb-3w" role="search">
                        <label class="fr-label" for="search-input">
                            Rechercher dans les rappels
                        </label>
                        <input class="fr-input" type="search" id="search-input" name="search-input" placeholder="Rechercher un produit, une marque...">
                        <button class="fr-btn" id="search-button" title="Rechercher">
                            Rechercher
                        </button>
                    </div>

                    <!-- Sélecteur de nombre de résultats -->
                    <div class="fr-select-group fr-mb-3w">
                        <label class="fr-label" for="items-per-page">
                            Nombre de résultats par page
                        </label>
                        <select class="fr-select" id="items-per-page" name="items-per-page">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>

                    <!-- Loading indicator -->
                    <div id="loading" class="loading">
                        <div class="fr-spinner fr-spinner--lg" aria-label="Chargement en cours">
                            <span class="fr-sr-only">Chargement en cours</span>
                        </div>
                    </div>
                    
                    <!-- Table container -->
                    <div id="table-container" style="display: none;">
                        <div class="fr-table fr-table--bordered">
                            <div class="fr-table__wrapper">
                                <div class="fr-table__container">
                                    <div class="fr-table__content">
                                        <table role="table" aria-label="Tableau des rappels de produits SignalConso">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Date</th>
                                                    <th scope="col">Catégorie</th>
                                                    <th scope="col">Produit</th>
                                                    <th scope="col">Marque</th>
                                                    <th scope="col">Risques</th>
                                                    <th scope="col">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="table-body">
                                                <!-- Data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <nav class="fr-pagination fr-mt-3w" role="navigation" aria-label="Pagination">
                            <ul class="fr-pagination__list">
                                <li>
                                    <button class="fr-pagination__link fr-pagination__link--prev" 
                                            id="prev-page"
                                            aria-label="Page précédente">
                                        Page précédente
                                    </button>
                                </li>
                                <li>
                                    <span class="fr-pagination__link" aria-current="page" id="current-page">1</span>
                                </li>
                                <li>
                                    <button class="fr-pagination__link fr-pagination__link--next"
                                            id="next-page"
                                            aria-label="Page suivante">
                                        Page suivante
                                    </button>
                                </li>
                            </ul>
                        </nav>
                        
                        <!-- Actions -->
                        <div class="fr-btns-group fr-btns-group--inline-sm fr-mt-3w">
                            <button class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-download-line"
                                    id="export-csv">
                                Exporter en CSV
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-refresh-line"
                                    id="refresh-data">
                                Actualiser
                            </button>
                        </div>

                        <!-- Statistiques -->
                        <div class="fr-callout fr-mt-3w">
                            <h3 class="fr-callout__title">Statistiques</h3>
                            <p class="fr-callout__text">
                                <span id="total-records">0</span> rappels trouvés • 
                                Page <span id="page-info">1</span> • 
                                Dernière mise à jour : <span id="last-update"></span>
                            </p>
                        </div>
                    </div>

                    <!-- Error message -->
                    <div id="error-container" class="fr-alert fr-alert--error" style="display: none;">
                        <h3 class="fr-alert__title">Erreur de chargement</h3>
                        <p id="error-message"></p>
                    </div>
                </div>
                <!-- FIN ZONE WIDGET signalconso-table-api-001 -->
                
                <!-- Alternative textuelle -->
                <div class="fr-notice fr-notice--info fr-mt-3w">
                    <div class="fr-container">
                        <div class="fr-notice__body">
                            <p class="fr-notice__title">Alternative textuelle</p>
                            <p>Ce tableau présente les rappels de produits publiés sur SignalConso. Les données sont récupérées en temps réel depuis l'API data.economie.gouv.fr.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- DSFR JS -->
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
    
    <!-- Application JavaScript -->
    <script>
        // Configuration API
        const API_BASE_URL = 'https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/rappelconso0/records';
        
        // État de l'application
        let currentPage = 0;
        let itemsPerPage = 10;
        let totalRecords = 0;
        let currentData = [];
        let searchQuery = '';

        // Fonction pour charger les données
        async function loadData() {
            const loading = document.getElementById('loading');
            const tableContainer = document.getElementById('table-container');
            const errorContainer = document.getElementById('error-container');
            
            loading.style.display = 'block';
            tableContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            
            try {
                // Construire l'URL avec les paramètres
                const params = new URLSearchParams({
                    limit: itemsPerPage,
                    offset: currentPage * itemsPerPage,
                    order_by: 'date_de_publication DESC'
                });
                
                if (searchQuery) {
                    params.append('where', `search(noms_des_modeles_ou_references, "${searchQuery}") OR search(marque_du_produit, "${searchQuery}")`);
                }
                
                const response = await fetch(`${API_BASE_URL}?${params}`);
                
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des données');
                }
                
                const data = await response.json();
                currentData = data.results || [];
                totalRecords = data.total_count || 0;
                
                displayData();
                updatePagination();
                updateStats();
                
                loading.style.display = 'none';
                tableContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Erreur:', error);
                loading.style.display = 'none';
                errorContainer.style.display = 'block';
                document.getElementById('error-message').textContent = 
                    'Impossible de charger les données. Veuillez réessayer plus tard.';
            }
        }

        // Fonction pour afficher les données dans le tableau
        function displayData() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            currentData.forEach(record => {
                const row = document.createElement('tr');
                
                // Date
                const dateCell = document.createElement('td');
                const date = new Date(record.date_de_publication);
                dateCell.textContent = date.toLocaleDateString('fr-FR');
                row.appendChild(dateCell);
                
                // Catégorie
                const categoryCell = document.createElement('td');
                categoryCell.textContent = record.categorie_de_produit || '-';
                row.appendChild(categoryCell);
                
                // Produit
                const productCell = document.createElement('td');
                productCell.className = 'product-cell';
                productCell.textContent = record.noms_des_modeles_ou_references || '-';
                row.appendChild(productCell);
                
                // Marque
                const brandCell = document.createElement('td');
                brandCell.textContent = record.marque_du_produit || '-';
                row.appendChild(brandCell);
                
                // Risques
                const riskCell = document.createElement('td');
                riskCell.className = 'risk-cell';
                riskCell.textContent = record.risques_encourus_par_le_consommateur || '-';
                row.appendChild(riskCell);
                
                // Actions
                const actionCell = document.createElement('td');
                const detailButton = document.createElement('button');
                detailButton.className = 'fr-btn fr-btn--sm fr-btn--secondary';
                detailButton.textContent = 'Détails';
                detailButton.setAttribute('aria-label', `Voir les détails du rappel ${record.noms_des_modeles_ou_references}`);
                detailButton.onclick = () => showDetails(record);
                actionCell.appendChild(detailButton);
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
        }

        // Fonction pour afficher les détails d'un rappel
        function showDetails(record) {
            const details = `
                Produit: ${record.noms_des_modeles_ou_references || 'Non spécifié'}
                Marque: ${record.marque_du_produit || 'Non spécifiée'}
                Catégorie: ${record.categorie_de_produit || 'Non spécifiée'}
                Risques: ${record.risques_encourus_par_le_consommateur || 'Non spécifiés'}
                Date: ${new Date(record.date_de_publication).toLocaleDateString('fr-FR')}
                ${record.numero_de_version ? `Version: ${record.numero_de_version}` : ''}
            `;
            alert(details);
        }

        // Fonction pour mettre à jour la pagination
        function updatePagination() {
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const currentPageSpan = document.getElementById('current-page');
            
            prevButton.disabled = currentPage === 0;
            nextButton.disabled = (currentPage + 1) * itemsPerPage >= totalRecords;
            currentPageSpan.textContent = currentPage + 1;
        }

        // Fonction pour mettre à jour les statistiques
        function updateStats() {
            document.getElementById('total-records').textContent = totalRecords;
            document.getElementById('page-info').textContent = `${currentPage + 1} / ${Math.ceil(totalRecords / itemsPerPage)}`;
            document.getElementById('last-update').textContent = new Date().toLocaleString('fr-FR');
        }

        // Fonction pour exporter en CSV
        function exportToCSV() {
            const headers = ['Date', 'Catégorie', 'Produit', 'Marque', 'Risques'];
            const rows = currentData.map(record => [
                new Date(record.date_de_publication).toLocaleDateString('fr-FR'),
                record.categorie_de_produit || '',
                record.noms_des_modeles_ou_references || '',
                record.marque_du_produit || '',
                record.risques_encourus_par_le_consommateur || ''
            ]);
            
            let csv = headers.join(';') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(';') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `rappels_signalconso_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Charger les données initiales
            loadData();
            
            // Recherche
            document.getElementById('search-button').addEventListener('click', () => {
                searchQuery = document.getElementById('search-input').value;
                currentPage = 0;
                loadData();
            });
            
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchQuery = e.target.value;
                    currentPage = 0;
                    loadData();
                }
            });
            
            // Changement du nombre d'items par page
            document.getElementById('items-per-page').addEventListener('change', (e) => {
                itemsPerPage = parseInt(e.target.value);
                currentPage = 0;
                loadData();
            });
            
            // Pagination
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    loadData();
                }
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                if ((currentPage + 1) * itemsPerPage < totalRecords) {
                    currentPage++;
                    loadData();
                }
            });
            
            // Export CSV
            document.getElementById('export-csv').addEventListener('click', exportToCSV);
            
            // Actualiser
            document.getElementById('refresh-data').addEventListener('click', loadData);
        });
    </script>
</body>
</html>