<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo ApiClient avec DataSync - Widget DSFR</title>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    
    <!-- ApiClient et Monitor -->
    <script src="../js/api-client.js"></script>
    <script src="../js/api-monitor.js"></script>
    
    <style>
        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        .sync-indicator.active {
            background: #10b981;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .update-flash {
            animation: flash 0.5s;
        }
        
        @keyframes flash {
            0% { background: rgba(16, 185, 129, 0.2); }
            100% { background: transparent; }
        }
    </style>
</head>
<body>
    <div class="fr-container fr-my-4w">
        <h1>D√©monstration ApiClient avec DataSync
            <span class="sync-indicator" id="sync-indicator"></span>
        </h1>
        
        <div class="fr-alert fr-alert--info fr-mb-3w">
            <h3 class="fr-alert__title">Fonctionnalit√©s d√©montr√©es</h3>
            <ul>
                <li>‚úÖ Cache centralis√© avec ApiClient</li>
                <li>‚úÖ Synchronisation temps r√©el avec DataSync</li>
                <li>‚úÖ D√©duplication automatique des requ√™tes</li>
                <li>‚úÖ Retry automatique en cas d'erreur</li>
                <li>‚úÖ Monitoring des performances</li>
            </ul>
        </div>
        
        <!-- Contr√¥les -->
        <div class="fr-btns-group fr-btns-group--inline fr-mb-3w">
            <button class="fr-btn" id="btn-load-signalconso">
                Charger SignalConso
            </button>
            <button class="fr-btn" id="btn-load-multiple">
                Charger 3 datasets
            </button>
            <button class="fr-btn" id="btn-subscribe">
                Activer auto-refresh
            </button>
            <button class="fr-btn" id="btn-unsubscribe" disabled>
                D√©sactiver auto-refresh
            </button>
            <button class="fr-btn fr-btn--secondary" id="btn-clear-cache">
                Vider le cache
            </button>
        </div>
        
        <!-- Statistiques -->
        <div class="fr-grid-row fr-grid-row--gutters fr-mb-3w">
            <div class="fr-col-12 fr-col-md-3">
                <div class="fr-tile">
                    <div class="fr-tile__body">
                        <h4 class="fr-tile__title">Requ√™tes totales</h4>
                        <p class="fr-tile__desc fr-text--bold" id="stat-requests">0</p>
                    </div>
                </div>
            </div>
            <div class="fr-col-12 fr-col-md-3">
                <div class="fr-tile">
                    <div class="fr-tile__body">
                        <h4 class="fr-tile__title">Taux de cache</h4>
                        <p class="fr-tile__desc fr-text--bold" id="stat-cache-rate">0%</p>
                    </div>
                </div>
            </div>
            <div class="fr-col-12 fr-col-md-3">
                <div class="fr-tile">
                    <div class="fr-tile__body">
                        <h4 class="fr-tile__title">Temps moyen</h4>
                        <p class="fr-tile__desc fr-text--bold" id="stat-avg-time">0ms</p>
                    </div>
                </div>
            </div>
            <div class="fr-col-12 fr-col-md-3">
                <div class="fr-tile">
                    <div class="fr-tile__body">
                        <h4 class="fr-tile__title">Erreurs</h4>
                        <p class="fr-tile__desc fr-text--bold" id="stat-errors">0</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Zone de donn√©es -->
        <div class="fr-tabs">
            <ul class="fr-tabs__list" role="tablist">
                <li role="presentation">
                    <button class="fr-tabs__tab" tabindex="0" role="tab" aria-selected="true" aria-controls="tab-panel-1">
                        SignalConso
                    </button>
                </li>
                <li role="presentation">
                    <button class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tab-panel-2">
                        Multi-datasets
                    </button>
                </li>
                <li role="presentation">
                    <button class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tab-panel-3">
                        Logs
                    </button>
                </li>
            </ul>
            
            <div id="tab-panel-1" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel">
                <div id="signalconso-data" class="data-container">
                    <p class="fr-text--sm fr-text-mention--grey">Cliquez sur "Charger SignalConso" pour afficher les donn√©es</p>
                </div>
            </div>
            
            <div id="tab-panel-2" class="fr-tabs__panel" role="tabpanel">
                <div id="multi-data" class="data-grid">
                    <p class="fr-text--sm fr-text-mention--grey">Cliquez sur "Charger 3 datasets" pour afficher les donn√©es</p>
                </div>
            </div>
            
            <div id="tab-panel-3" class="fr-tabs__panel" role="tabpanel">
                <div id="logs" style="max-height: 400px; overflow-y: auto; background: #f6f6f6; padding: 1rem; font-family: monospace; font-size: 0.875rem;">
                    <p>Logs d'activit√©...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize ApiClient with custom config
        const api = window.apiClient;
        api.config.debug = true;
        
        // Initialize monitor
        let monitor;
        
        // Subscription handle
        let subscription = null;
        
        // Logging
        function log(message, type = 'info') {
            const logsContainer = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.style.marginBottom = '0.5rem';
            
            const time = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üìù';
            
            entry.innerHTML = `<strong>[${time}]</strong> ${icon} ${message}`;
            logsContainer.appendChild(entry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        // Update statistics
        function updateStats() {
            const stats = api.getStats();
            document.getElementById('stat-requests').textContent = stats.requests;
            document.getElementById('stat-cache-rate').textContent = stats.cacheHitRate + '%';
            document.getElementById('stat-avg-time').textContent = stats.averageResponseTime + 'ms';
            document.getElementById('stat-errors').textContent = stats.errors;
        }
        
        // Display SignalConso data
        function displaySignalConso(data) {
            const container = document.getElementById('signalconso-data');
            container.classList.add('update-flash');
            
            let html = `
                <h3>SignalConso - ${data.total_count} enregistrements</h3>
                <div class="fr-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Cat√©gorie</th>
                                <th>R√©gion</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.results.slice(0, 10).forEach(record => {
                const fields = record.fields || record;
                html += `
                    <tr>
                        <td>${new Date(fields.creationdate).toLocaleDateString('fr-FR')}</td>
                        <td>${fields.category || 'N/A'}</td>
                        <td>${fields.reg_name || 'N/A'}</td>
                        <td><span class="fr-badge fr-badge--sm">${fields.status || 'N/A'}</span></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <p class="fr-text--xs fr-text-mention--grey fr-mt-2w">
                    Derni√®re mise √† jour : ${new Date().toLocaleTimeString()}
                </p>
            `;
            
            container.innerHTML = html;
            
            setTimeout(() => {
                container.classList.remove('update-flash');
            }, 500);
        }
        
        // Display multiple datasets
        function displayMultiDatasets(datasets) {
            const container = document.getElementById('multi-data');
            container.innerHTML = '';
            
            const datasetNames = ['SignalConso', 'Annuaire DGCCRF', 'Budget Vert'];
            
            datasets.forEach((data, index) => {
                const card = document.createElement('div');
                card.className = 'fr-card';
                card.innerHTML = `
                    <div class="fr-card__body">
                        <h4 class="fr-card__title">${datasetNames[index]}</h4>
                        <p class="fr-card__desc">
                            <strong>${data.total_count}</strong> enregistrements<br>
                            <span class="fr-text--sm">${data.results.length} affich√©s</span>
                        </p>
                        <div class="fr-card__end">
                            <p class="fr-text--xs fr-text-mention--grey">
                                Charg√© √† ${new Date().toLocaleTimeString()}
                            </p>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Event listeners for ApiClient
        api.on('request:start', (data) => {
            log(`üöÄ Requ√™te d√©marr√©e : ${data.url}`);
            document.getElementById('sync-indicator').classList.add('active');
        });
        
        api.on('request:success', (data) => {
            log(`‚úÖ Requ√™te r√©ussie en ${data.responseTime}ms`, 'success');
            updateStats();
            setTimeout(() => {
                document.getElementById('sync-indicator').classList.remove('active');
            }, 500);
        });
        
        api.on('cache:hit', (data) => {
            log(`üéØ Cache hit pour : ${data.key.split(':')[1]}`);
            updateStats();
        });
        
        api.on('request:error', (data) => {
            log(`‚ùå Erreur : ${data.error}`, 'error');
            updateStats();
        });
        
        api.on('request:retry', (data) => {
            log(`üîÑ Retry ${data.attempt} pour : ${data.url}`);
        });
        
        // Button handlers
        document.getElementById('btn-load-signalconso').addEventListener('click', async () => {
            const btn = document.getElementById('btn-load-signalconso');
            btn.classList.add('loading');
            btn.disabled = true;
            
            try {
                const data = await api.get('/api/explore/v2.1/catalog/datasets/signalconso/records', {
                    limit: 20
                });
                
                displaySignalConso(data);
                log('SignalConso charg√© avec succ√®s', 'success');
                
            } catch (error) {
                log(`Erreur lors du chargement : ${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        });
        
        document.getElementById('btn-load-multiple').addEventListener('click', async () => {
            const btn = document.getElementById('btn-load-multiple');
            btn.classList.add('loading');
            btn.disabled = true;
            
            try {
                // Charger 3 datasets en parall√®le
                const datasets = await api.batch([
                    '/api/explore/v2.1/catalog/datasets/signalconso/records?limit=10',
                    '/api/explore/v2.1/catalog/datasets/annuaire-dgccrf/records?limit=10',
                    '/api/explore/v2.1/catalog/datasets/budget-vert/records?limit=10'
                ]);
                
                displayMultiDatasets(datasets);
                log('3 datasets charg√©s en parall√®le', 'success');
                
                // Activer l'onglet multi-datasets
                document.querySelectorAll('.fr-tabs__tab')[1].click();
                
            } catch (error) {
                log(`Erreur lors du chargement multiple : ${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        });
        
        document.getElementById('btn-subscribe').addEventListener('click', () => {
            if (subscription) return;
            
            log('üîÑ Auto-refresh activ√© (30s)');
            
            // Subscribe to SignalConso updates
            subscription = api.dataSync.subscribe(
                '/api/explore/v2.1/catalog/datasets/signalconso/records?limit=20',
                (data) => {
                    displaySignalConso(data);
                    log('üîÑ Donn√©es mises √† jour automatiquement');
                }
            );
            
            // Set faster refresh for demo (10 seconds)
            api.dataSync.setUpdateInterval(10000);
            
            document.getElementById('btn-subscribe').disabled = true;
            document.getElementById('btn-unsubscribe').disabled = false;
        });
        
        document.getElementById('btn-unsubscribe').addEventListener('click', () => {
            if (subscription) {
                subscription();
                subscription = null;
                log('‚èπÔ∏è Auto-refresh d√©sactiv√©');
            }
            
            document.getElementById('btn-subscribe').disabled = false;
            document.getElementById('btn-unsubscribe').disabled = true;
        });
        
        document.getElementById('btn-clear-cache').addEventListener('click', () => {
            api.clearCache();
            log('üóëÔ∏è Cache vid√©');
            updateStats();
        });
        
        // Tab management
        document.querySelectorAll('.fr-tabs__tab').forEach((tab, index) => {
            tab.addEventListener('click', () => {
                // Reset all tabs
                document.querySelectorAll('.fr-tabs__tab').forEach(t => {
                    t.setAttribute('aria-selected', 'false');
                    t.setAttribute('tabindex', '-1');
                });
                document.querySelectorAll('.fr-tabs__panel').forEach(p => {
                    p.classList.remove('fr-tabs__panel--selected');
                });
                
                // Activate clicked tab
                tab.setAttribute('aria-selected', 'true');
                tab.setAttribute('tabindex', '0');
                document.querySelectorAll('.fr-tabs__panel')[index].classList.add('fr-tabs__panel--selected');
            });
        });
        
        // Initialize monitor
        document.addEventListener('DOMContentLoaded', () => {
            if (window.ApiMonitor) {
                monitor = new ApiMonitor({
                    position: 'bottom-right',
                    theme: 'light',
                    collapsed: false,
                    updateInterval: 1000
                });
            }
            
            // Update stats every second
            setInterval(updateStats, 1000);
            
            log('‚ú® ApiClient demo initialis√©');
            log('üìä Monitor visible en bas √† droite');
        });
    </script>
    
    <!-- DSFR JS -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>