<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Treemap</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0"></script>
    <style>
        .chart-container {
            position: relative;
            height: 500px;
            width: 90%;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <h1>Test Treemap Chart.js</h1>
    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        const ctx = document.getElementById('myChart').getContext('2d');
        
        const data = [
            {category: 'Commerce', subcategory: 'E-commerce', value: 4500},
            {category: 'Commerce', subcategory: 'Magasins', value: 3200},
            {category: 'Commerce', subcategory: 'SAV', value: 2100},
            {category: 'Services', subcategory: 'Téléphonie', value: 3800},
            {category: 'Services', subcategory: 'Énergie', value: 2900},
            {category: 'Services', subcategory: 'Banque', value: 3500},
            {category: 'Alimentation', subcategory: 'Restaurants', value: 2100},
            {category: 'Alimentation', subcategory: 'Livraison', value: 1900},
            {category: 'Immobilier', subcategory: 'Location', value: 2800},
            {category: 'Immobilier', subcategory: 'Vente', value: 1600},
            {category: 'Santé', subcategory: 'Pharmacie', value: 1100},
            {category: 'Santé', subcategory: 'Optique', value: 900}
        ];

        // Mapper les couleurs par catégorie
        const categoryColors = {
            'Commerce': '#000091',
            'Services': '#18753C',
            'Alimentation': '#CE0500',
            'Immobilier': '#B34000',
            'Santé': '#0063CB'
        };

        // Ajouter les couleurs aux données
        const treeData = data.map(item => ({
            ...item,
            _color: categoryColors[item.category]
        }));

        const config = {
            type: 'treemap',
            data: {
                datasets: [{
                    label: 'Signalements',
                    tree: treeData,
                    key: 'value',
                    groups: ['category', 'subcategory'],
                    backgroundColor: (ctx) => {
                        if (ctx.type !== 'data') return 'transparent';
                        const item = ctx.raw;
                        return item._color ? item._color + '80' : '#00009180';
                    },
                    borderColor: (ctx) => {
                        if (ctx.type !== 'data') return 'transparent';
                        const item = ctx.raw;
                        return item._color || '#000091';
                    },
                    borderWidth: 2,
                    spacing: 1,
                    labels: {
                        display: true,
                        color: 'white',
                        font: {
                            size: 11
                        },
                        formatter: (ctx) => {
                            const item = ctx.raw;
                            return [item.subcategory, item.value];
                        }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: (items) => {
                                const item = items[0].raw;
                                return item.category + ' > ' + item.subcategory;
                            },
                            label: (context) => {
                                const item = context.raw;
                                return 'Valeur: ' + item.value;
                            }
                        }
                    }
                }
            }
        };

        const myChart = new Chart(ctx, config);
        console.log('Treemap créé avec succès');
    </script>
</body>
</html>