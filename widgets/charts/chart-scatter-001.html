<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Widget graphique nuage de points DSFR - Corrélation entre données SignalConso">
    <title>Graphique nuage de points DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; font-family: Marianne, arial, sans-serif; }
        .fr-card__body { padding-bottom: 2rem !important; }
        .chart-container { position: relative; height: 400px; margin: 2rem 0; }
        .chart-controls { margin-bottom: 1rem; }
        .data-table { display: none; }
        .data-table.show { 
            display: block !important;
            width: 100% !important;
        }
        /* Caption DSFR en dehors du tableau */
        .fr-table__caption {
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f6f6f6;
            background-color: var(--background-contrast-grey, #f6f6f6);
            color: #161616;
            color: var(--text-title-grey, #161616);
            font-weight: 700;
            font-size: 1.125rem;
            text-align: left;
            border-left: 3px solid #000091;
            border-left: 3px solid var(--border-plain-blue-france, #000091);
        }
        .fr-table {
            width: 100% !important;
            margin-top: 2rem;
            display: block !important;
        }
        .fr-table table {
            width: 100% !important;
            table-layout: fixed;
        }
        /* Fix pour le chevauchement du caption */
        .fr-table caption {
            position: relative !important;
            padding: 1rem;
            background: #f5f5fe;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .chart-container { height: 300px; }
        }
        .export-buttons { margin-top: 1rem; }
    </style>
</head>
<body>

    <!-- Skip links pour l'accessibilité -->
    <div class="fr-skiplinks">
        <nav class="fr-container" role="navigation" aria-label="Accès rapide">
            <ul class="fr-skiplinks__list">
                <li><a class="fr-link" href="#content">Aller au contenu</a></li>
                <li><a class="fr-link" href="#fr-footer">Aller au pied de page</a></li>
            </ul>
        </nav>
    </div>


    <!-- Header DSFR -->
    <header role="banner" class="fr-header">
        <div class="fr-header__body">
            <div class="fr-container">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand fr-enlarge-link">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                                <p class="fr-logo">
                                    République
                                    <br>Française
                                </p>
                            </div>
                        </div>
                        <div class="fr-header__service">
                            <a href="/" title="Accueil - SignalConso">
                                <p class="fr-header__service-title">
                                    SignalConso
                                </p>
                            </a>
                            <p class="fr-header__service-tagline">Graphique de visualisation SignalConso - data.economie.gouv.fr</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <!-- Main content -->
    <main id="content" role="main">
        <div class="fr-container fr-py-6w">
            <div id="widget-chart-scatter-001" class="fr-container fr-py-3w">
        <div class="fr-grid-row">
            <div class="fr-col-12">
                <div class="fr-card">
                    <div class="fr-card__body">
                        <h2 class="fr-h4">Corrélation temps de résolution / satisfaction client</h2>
                        <p class="fr-text--sm">Analyse de la relation entre le temps de traitement et la satisfaction des consommateurs</p>
                        
                        <!-- Contrôles du graphique -->
                        <div class="chart-controls">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-select-group">
                                        <label class="fr-label" for="category-select">Catégorie</label>
                                        <select class="fr-select" id="category-select" onchange="updateCategory()">
                                            <option value="all">Toutes catégories</option>
                                            <option value="commerce">Commerce</option>
                                            <option value="services">Services</option>
                                            <option value="alimentation">Alimentation</option>
                                            <option value="transport">Transport</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-toggle">
                                        <input type="checkbox" class="fr-toggle__input" id="toggle-regression" onchange="toggleRegression()">
                                        <label class="fr-toggle__label" for="toggle-regression">
                                            Afficher la ligne de tendance
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="fr-grid-row fr-grid-row--gutters fr-mt-1w">
                                <div class="fr-col-12">
                                    <div class="fr-toggle">
                                        <input type="checkbox" class="fr-toggle__input" id="toggle-table">
                                        <label class="fr-toggle__label" for="toggle-table">
                                            Afficher le tableau de données
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graphique -->
                        <div class="chart-container">
                            <canvas id="scatterChart" role="img" aria-label="Graphique montrant la corrélation entre temps de résolution et satisfaction"></canvas>
                        </div>
                        
                        <!-- Boutons d'export -->
                        <div class="export-buttons">
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" id="exportchartaspng-btn">
                                Exporter en PNG
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" id="exportdataascsv-btn">
                                Exporter les données (CSV)
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" id="togglefullscreen-btn">
                                Plein écran
                            </button>
                        </div>
                        
                        <!-- Tableau de données alternatif (accessibilité) -->
                        <div class="data-table" id="data-table">
                            <div class="fr-table fr-table--bordered">
                                <div class="fr-table__caption">Données du graphique : Corrélation temps/satisfaction</div>
                                <div class="fr-table__wrapper">
                                    <div class="fr-table__container">
                                        <div class="fr-table__content">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Plage de temps (jours)</th>
                                                        <th scope="col">Nombre de cas</th>
                                                        <th scope="col">Satisfaction moyenne (%)</th>
                                                        <th scope="col">% du total</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="table-body">
                                                    <!-- Les données seront insérées ici -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistiques -->
                        <div class="fr-grid-row fr-grid-row--gutters fr-mt-3w">
                            <div class="fr-col-12 fr-col-md-3">
                                <div class="fr-tile">
                                    <div class="fr-tile__body">
                                        <p class="fr-tile__title">Corrélation</p>
                                        <p class="fr-tile__desc fr-text--lg fr-text--bold" id="correlation-value">0.72</p>
                                    </div>
                                </div>
                            </div>
                            <div class="fr-col-12 fr-col-md-3">
                                <div class="fr-tile">
                                    <div class="fr-tile__body">
                                        <p class="fr-tile__title">Temps moyen</p>
                                        <p class="fr-tile__desc fr-text--lg fr-text--bold" id="avg-time">15 jours</p>
                                    </div>
                                </div>
                            </div>
                            <div class="fr-col-12 fr-col-md-3">
                                <div class="fr-tile">
                                    <div class="fr-tile__body">
                                        <p class="fr-tile__title">Satisfaction moyenne</p>
                                        <p class="fr-tile__desc fr-text--lg fr-text--bold" id="avg-satisfaction">3.8/5</p>
                                    </div>
                                </div>
                            </div>
                            <div class="fr-col-12 fr-col-md-3">
                                <div class="fr-tile">
                                    <div class="fr-tile__body">
                                        <p class="fr-tile__title">Échantillon</p>
                                        <p class="fr-tile__desc fr-text--lg fr-text--bold" id="sample-size">500 cas</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Légende et informations -->
                        <div class="fr-alert fr-alert--info fr-mt-3w">
                            <p class="fr-alert__title">À propos de ces données</p>
                            <p>Ce graphique montre la corrélation entre le temps de résolution des signalements (en jours) 
                            et la satisfaction client (note sur 5). Chaque point représente un dossier traité.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN ZONE WIDGET CHART-SCATTER-001 -->
    
    <script>
        // Configuration des couleurs DSFR
        const dsfrColors = {
            primary: '#000091',
            primaryLight: '#6A6AF4',
            success: '#18753C',
            error: '#CE0500',
            warning: '#B34000',
            info: '#0063CB',
            grey: '#666666'
        };
        
        // Génération de données simulées
        const generateScatterData = (category = 'all') => {
            const numPoints = category === 'all' ? 500 : 100;
            const data = [];
            
            for (let i = 0; i < numPoints; i++) {
                // Temps de résolution (1-60 jours)
                const x = Math.random() * 59 + 1;
                // Satisfaction (1-5) - inversement corrélée au temps
                const baseY = 5 - (x / 60) * 3;
                const noise = (Math.random() - 0.5) * 2;
                const y = Math.max(1, Math.min(5, baseY + noise));
                
                data.push({
                    x: Math.round(x),
                    y: Math.round(y * 10) / 10
                });
            }
            
            return data;
        };
        
        // Calcul de la ligne de régression
        function calculateRegression(data) {
            const n = data.length;
            const sumX = data.reduce((sum, point) => sum + point.x, 0);
            const sumY = data.reduce((sum, point) => sum + point.y, 0);
            const sumXY = data.reduce((sum, point) => sum + point.x * point.y, 0);
            const sumX2 = data.reduce((sum, point) => sum + point.x * point.x, 0);
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // Calcul du coefficient de corrélation
            const meanX = sumX / n;
            const meanY = sumY / n;
            const numerator = data.reduce((sum, point) => 
                sum + (point.x - meanX) * (point.y - meanY), 0);
            const denomX = Math.sqrt(data.reduce((sum, point) => 
                sum + Math.pow(point.x - meanX, 2), 0));
            const denomY = Math.sqrt(data.reduce((sum, point) => 
                sum + Math.pow(point.y - meanY, 2), 0));
            const correlation = numerator / (denomX * denomY);
            
            return { slope, intercept, correlation };
        }
        
        // Données initiales
        let scatterData = generateScatterData();
        let regression = calculateRegression(scatterData);
        
        // Configuration du graphique
        const config = {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Signalements',
                    data: scatterData,
                    backgroundColor: dsfrColors.primary + '60',
                    borderColor: dsfrColors.primary,
                    borderWidth: 1,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'point'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 4,
                        callbacks: {
                            label: function(context) {
                                return `Temps: ${context.parsed.x} jours | Satisfaction: ${context.parsed.y}/5`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Temps de résolution (jours)',
                            color: dsfrColors.grey,
                            font: {
                                size: 14
                            }
                        },
                        grid: {
                            color: '#E5E5E5'
                        },
                        ticks: {
                            color: dsfrColors.grey
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Satisfaction client (note sur 5)',
                            color: dsfrColors.grey,
                            font: {
                                size: 14
                            }
                        },
                        min: 0,
                        max: 5,
                        grid: {
                            color: '#E5E5E5'
                        },
                        ticks: {
                            color: dsfrColors.grey
                        }
                    }
                }
            }
        };
        
        // Initialisation du graphique
        const ctx = document.getElementById('scatterChart').getContext('2d');
        const myChart = new Chart(ctx, config);
        
        // Mise à jour du tableau de données
        function updateDataTable() {
            const tableBody = document.getElementById('table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Grouper les données par plages de temps
            const ranges = [
                { min: 0, max: 7, label: '0-7 jours' },
                { min: 8, max: 15, label: '8-15 jours' },
                { min: 16, max: 30, label: '16-30 jours' },
                { min: 31, max: 60, label: '31-60 jours' }
            ];
            
            const totalPoints = scatterData.length;
            
            ranges.forEach(range => {
                const pointsInRange = scatterData.filter(p => p.x > range.min && p.x <= range.max);
                const count = pointsInRange.length;
                const avgSatisfaction = count > 0 
                    ? (pointsInRange.reduce((sum, p) => sum + p.y, 0) / count).toFixed(1)
                    : '-';
                const percentage = ((count / totalPoints) * 100).toFixed(1);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${range.label}</td>
                    <td>${count}</td>
                    <td>${avgSatisfaction}/5</td>
                    <td>${percentage}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Mise à jour des statistiques
        function updateStatistics() {
            document.getElementById('correlation-value').textContent = 
                regression.correlation.toFixed(2);
            
            const avgX = scatterData.reduce((sum, p) => sum + p.x, 0) / scatterData.length;
            const avgY = scatterData.reduce((sum, p) => sum + p.y, 0) / scatterData.length;
            
            document.getElementById('avg-time').textContent = 
                Math.round(avgX) + ' jours';
            document.getElementById('avg-satisfaction').textContent = 
                avgY.toFixed(1) + '/5';
            document.getElementById('sample-size').textContent = 
                scatterData.length + ' cas';
        }
        
        // Mise à jour de la catégorie
        function updateCategory() {
            const category = document.getElementById('category-select').value;
            scatterData = generateScatterData(category);
            regression = calculateRegression(scatterData);
            
            myChart.data.datasets[0].data = scatterData;
            
            // Supprimer la ligne de tendance si elle existe
            if (myChart.data.datasets.length > 1) {
                myChart.data.datasets.pop();
            }
            
            // Ré-ajouter si nécessaire
            if (document.getElementById('toggle-regression').checked) {
                addRegressionLine();
            }
            
            myChart.update();
            updateStatistics();
            updateDataTable();
        }
        
        // Ajouter la ligne de régression
        function addRegressionLine() {
            const minX = 0;
            const maxX = 60;
            
            const regressionLine = {
                label: 'Ligne de tendance',
                data: [
                    { x: minX, y: regression.intercept + regression.slope * minX },
                    { x: maxX, y: regression.intercept + regression.slope * maxX }
                ],
                type: 'line',
                borderColor: dsfrColors.error,
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                pointHoverRadius: 0
            };
            
            myChart.data.datasets.push(regressionLine);
        }
        
        // Toggle ligne de régression
        function toggleRegression() {
            const isChecked = document.getElementById('toggle-regression').checked;
            
            if (isChecked && myChart.data.datasets.length === 1) {
                addRegressionLine();
            } else if (!isChecked && myChart.data.datasets.length > 1) {
                myChart.data.datasets.pop();
            }
            
            myChart.update();
        }
        
        // Export en PNG
        function exportChartAsPNG() {
            const link = document.createElement('a');
            link.download = 'correlation-signalconso.png';
            link.href = myChart.toBase64Image();
            link.click();
        }
        
        // Export en CSV
        function exportDataAsCSV() {
            let csv = 'Temps de résolution (jours),Satisfaction client (note sur 5)\n';
            scatterData.forEach(point => {
                csv += `${point.x},${point.y}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'correlation-signalconso.csv';
            link.click();
        }
        
        // Mode plein écran
        function toggleFullscreen() {
            const container = document.getElementById('widget-chart-scatter-001');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error(`Erreur lors du passage en plein écran: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Initialisation
        updateStatistics();
        updateDataTable();
        
        // Toggle du tableau de données
        document.getElementById('toggle-table').addEventListener('change', function(e) {
            const table = document.getElementById('data-table');
            if (table) {
                table.classList.toggle('show', e.target.checked);
            }
        });
        
        // Adaptation responsive
        window.addEventListener('resize', () => {
            myChart.resize();
        });
    
        // Chargement des données depuis l'API
        async function loadDataFromAPI() {
            try {
                const response = await fetch('https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=500');
                const data = await response.json();
                
                
                // Créer des points pour le scatter plot
                const scatterData = [];
                data.records.forEach(record => {
                    if (record.fields.creationdate && record.fields.datecloture) {
                        const created = new Date(record.fields.creationdate);
                        const closed = new Date(record.fields.datecloture);
                        const delayDays = Math.floor((closed - created) / (1000 * 60 * 60 * 24));
                        
                        // Simuler un score de satisfaction basé sur le délai
                        const satisfaction = Math.max(0, Math.min(100, 100 - delayDays * 2));
                        
                        if (delayDays > 0 && delayDays < 180) {
                            scatterData.push({
                                x: delayDays,
                                y: satisfaction + (Math.random() - 0.5) * 20
                            });
                        }
                    }
                });
                
                // Si pas assez de données, générer des données de démo
                if (scatterData.length < 50) {
                    for (let i = 0; i < 100; i++) {
                        scatterData.push({
                            x: Math.random() * 90,
                            y: 100 - Math.random() * 50
                        });
                    }
                }
                
                // Mettre à jour le graphique
                updateChart(labels, values);
                
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                // Utiliser des données de démonstration en cas d'erreur
                useDefaultData();
            }
        }
        
        
        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', async function() {
            await loadDataFromAPI();
            
            // Ajouter les event listeners
            const buttons = document.querySelectorAll('button[id$="-btn"]');
            buttons.forEach(btn => {
                const funcName = btn.id.replace('-btn', '').replace(/-/g, '_');
                if (window[funcName]) {
                    btn.addEventListener('click', window[funcName]);
                }
            });
            
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
        </div>
    </main>

    <!-- Footer DSFR -->
    <footer class="fr-footer" role="contentinfo" id="fr-footer">
        <div class="fr-container">
            <div class="fr-footer__body">
                <div class="fr-footer__brand fr-enlarge-link">
                    <a href="/" title="Retour à l'accueil">
                        <p class="fr-logo">
                            République
                            <br>Française
                        </p>
                    </a>
                </div>
                <div class="fr-footer__content">
                    <p class="fr-footer__content-desc">
                        Graphique de visualisation SignalConso. Données issues de data.economie.gouv.fr
                    </p>
                    <ul class="fr-footer__content-list">
                        <li class="fr-footer__content-item">
                            <a class="fr-footer__content-link" target="_blank" href="https://data.economie.gouv.fr" rel="noopener external">data.economie.gouv.fr</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="fr-footer__bottom">
                <ul class="fr-footer__bottom-list">
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Accessibilité : conforme</a>
                    </li>
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Mentions légales</a>
                    </li>
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Données personnelles</a>
                    </li>
                </ul>
                <div class="fr-footer__bottom-copy">
                    <p>
                        Sauf mention contraire, tous les contenus de ce site sont sous
                        <a href="https://github.com/etalab/licence-ouverte/blob/master/LO.md" target="_blank" rel="noopener external">licence etalab-2.0</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

</body>
</html>