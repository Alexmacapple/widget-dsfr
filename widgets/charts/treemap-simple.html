<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treemap Simple avec Couleurs</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0"></script>
    <style>
        .chart-container {
            position: relative;
            height: 500px;
            margin: 2rem auto;
        }
        .data-table { display: none; }
        .data-table.show { display: table; }
    </style>
</head>
<body>
    <div class="fr-container fr-py-3w">
        <h1>Test Treemap avec Couleurs DSFR</h1>
        
        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>

        <!-- Légende -->
        <div class="fr-mt-2w">
            <p class="fr-text--sm fr-text--bold">Catégories :</p>
            <div id="legend"></div>
        </div>

        <!-- Bouton tableau DSFR -->
        <div class="fr-mt-3w">
            <button class="fr-btn fr-btn--tertiary" id="toggleBtn" aria-expanded="false">
                Afficher le tableau de données
            </button>
        </div>

        <!-- Tableau de données -->
        <table class="fr-table fr-table--bordered data-table" id="dataTable">
            <caption>Données du graphique</caption>
            <thead>
                <tr>
                    <th scope="col">Catégorie</th>
                    <th scope="col">Sous-catégorie</th>
                    <th scope="col">Valeur</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        // Couleurs DSFR
        const colors = [
            '#000091', // Bleu France
            '#18753C', // Vert émeraude
            '#CE0500', // Rouge Marianne
            '#B34000', // Orange terre battue
            '#0063CB'  // Bleu info
        ];

        // Données avec couleurs assignées par catégorie
        const categories = {
            'Commerce': { color: colors[0], items: [
                { name: 'E-commerce', value: 4500 },
                { name: 'Magasins', value: 3200 },
                { name: 'SAV', value: 2100 }
            ]},
            'Services': { color: colors[1], items: [
                { name: 'Téléphonie', value: 3800 },
                { name: 'Énergie', value: 2900 },
                { name: 'Banque', value: 3500 }
            ]},
            'Alimentation': { color: colors[2], items: [
                { name: 'Restaurants', value: 2100 },
                { name: 'Livraison', value: 1900 }
            ]},
            'Immobilier': { color: colors[3], items: [
                { name: 'Location', value: 2800 },
                { name: 'Vente', value: 1600 }
            ]},
            'Santé': { color: colors[4], items: [
                { name: 'Pharmacie', value: 1100 },
                { name: 'Optique', value: 900 }
            ]}
        };

        // Préparer les données pour le treemap
        const treeData = [];
        const bgColors = [];
        const borderColors = [];

        Object.entries(categories).forEach(([catName, catData]) => {
            catData.items.forEach(item => {
                treeData.push({
                    category: catName,
                    subcategory: item.name,
                    value: item.value
                });
                bgColors.push(catData.color + '80'); // Transparence
                borderColors.push(catData.color);
            });
        });

        // Configuration du graphique
        const ctx = document.getElementById('myChart').getContext('2d');
        const config = {
            type: 'treemap',
            data: {
                datasets: [{
                    label: 'Répartition',
                    tree: treeData,
                    backgroundColor: bgColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    spacing: 1,
                    key: 'value',
                    groups: ['category', 'subcategory'],
                    labels: {
                        display: true,
                        color: 'white',
                        font: { size: 11 },
                        formatter: (ctx) => {
                            return [ctx.raw.subcategory, ctx.raw.value];
                        }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: (items) => {
                                const item = items[0].raw;
                                return item.category + ' > ' + item.subcategory;
                            },
                            label: (context) => {
                                return 'Valeur: ' + context.raw.value;
                            }
                        }
                    }
                }
            }
        };

        const myChart = new Chart(ctx, config);

        // Créer la légende
        const legendDiv = document.getElementById('legend');
        Object.entries(categories).forEach(([catName, catData]) => {
            const span = document.createElement('span');
            span.style.display = 'inline-block';
            span.style.marginRight = '1rem';
            span.innerHTML = `
                <span style="display:inline-block;width:20px;height:12px;background:${catData.color};margin-right:0.5rem;vertical-align:middle;"></span>
                ${catName}
            `;
            legendDiv.appendChild(span);
        });

        // Remplir le tableau
        const tableBody = document.getElementById('tableBody');
        treeData.forEach(item => {
            const row = tableBody.insertRow();
            row.insertCell(0).textContent = item.category;
            row.insertCell(1).textContent = item.subcategory;
            row.insertCell(2).textContent = item.value;
        });

        // Toggle tableau avec bouton DSFR
        const toggleBtn = document.getElementById('toggleBtn');
        const dataTable = document.getElementById('dataTable');
        
        toggleBtn.addEventListener('click', function() {
            const isVisible = dataTable.classList.contains('show');
            
            if (isVisible) {
                dataTable.classList.remove('show');
                this.setAttribute('aria-expanded', 'false');
                this.textContent = 'Afficher le tableau de données';
            } else {
                dataTable.classList.add('show');
                this.setAttribute('aria-expanded', 'true');
                this.textContent = 'Masquer le tableau de données';
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>