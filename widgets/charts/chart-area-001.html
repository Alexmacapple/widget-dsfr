<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Widget graphique en aires DSFR - Évolution cumulative des signalements SignalConso">
    <title>Graphique en aires DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; font-family: Marianne, arial, sans-serif; }
        .fr-card__body { padding-bottom: 2rem !important; }
        .chart-container { position: relative; height: 400px; margin: 2rem 0; }
        .chart-controls { margin-bottom: 1rem; }
        .data-table { 
            display: none;
            margin-top: 2rem;
        }
        .data-table.show { 
            display: block !important;
        }
        /* Structure DSFR pour tableau responsive */
        .fr-table__wrapper {
            position: relative;
            overflow-x: auto;
        }
        .fr-table__container {
            min-width: 100%;
        }
        .fr-table__content {
            display: block;
        }
        .fr-table__content table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }
        /* Caption DSFR en dehors du tableau */
        .fr-table__caption {
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f6f6f6;
            background-color: var(--background-contrast-grey, #f6f6f6);
            color: #161616;
            color: var(--text-title-grey, #161616);
            font-weight: 700;
            font-size: 1.125rem;
            text-align: left;
            border-left: 3px solid #000091;
            border-left: 3px solid var(--border-plain-blue-france, #000091);
        }
        .fr-table__content th,
        .fr-table__content td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #dddddd;
            border: 1px solid var(--border-default-grey, #dddddd);
        }
        .fr-table__content thead {
            background-color: #f6f6f6;
            background-color: var(--background-contrast-grey, #f6f6f6);
        }
        .fr-table__content tbody tr:hover {
            background-color: #e5e5e5;
            background-color: var(--background-contrast-grey-hover, #e5e5e5);
        }
        /* Suppression du scroll si non nécessaire */
        .fr-table__wrapper--no-scroll {
            overflow-x: visible;
        }
        @media (max-width: 768px) {
            .chart-container { height: 300px; }
        }
        .export-buttons { margin-top: 1rem; }
    </style>
</head>
<body>
    <!-- DÉBUT ZONE WIDGET CHART-AREA-001 -->
    <div id="widget-chart-area-001" class="fr-container fr-py-3w">
        <div class="fr-grid-row">
            <div class="fr-col-12">
                <div class="fr-card">
                    <div class="fr-card__body">
                        <h2 class="fr-h4">Évolution cumulative par catégories</h2>
                        <p class="fr-text--sm">Visualisation des tendances par catégorie sur 12 mois</p>
                        
                        <!-- Contrôles du graphique -->
                        <div class="chart-controls">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-toggle">
                                        <input type="checkbox" class="fr-toggle__input" id="toggle-stacked" checked>
                                        <label class="fr-toggle__label" for="toggle-stacked">
                                            Aires empilées
                                        </label>
                                    </div>
                                </div>
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-toggle">
                                        <input type="checkbox" class="fr-toggle__input" id="toggle-table">
                                        <label class="fr-toggle__label" for="toggle-table">
                                            Afficher le tableau
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graphique -->
                        <div class="chart-container">
                            <canvas id="areaChart" role="img" aria-label="Graphique en aires montrant l'évolution cumulative"></canvas>
                        </div>
                        
                        <!-- Boutons d'export -->
                        <div class="export-buttons">
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" id="export-png">
                                Exporter en PNG
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" id="export-csv">
                                Exporter les données (CSV)
                            </button>
                        </div>
                        
                        <!-- Tableau de données alternatif (accessibilité) -->
                        <div class="data-table" id="data-table">
                            <div class="fr-table fr-table--bordered">
                                <div class="fr-table__caption">Données du graphique : Évolution par catégories</div>
                                <div class="fr-table__wrapper">
                                    <div class="fr-table__container">
                                        <div class="fr-table__content">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Mois</th>
                                                        <th scope="col">Commerce</th>
                                                        <th scope="col">Services</th>
                                                        <th scope="col">Transport</th>
                                                        <th scope="col">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="table-body">
                                                    <!-- Les données seront insérées ici -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN ZONE WIDGET CHART-AREA-001 -->
    
    <script>
        // Configuration des couleurs DSFR
        const dsfrColors = {
            primary: 'rgba(0, 0, 145, 0.6)',
            success: 'rgba(24, 117, 60, 0.6)',
            warning: 'rgba(179, 64, 0, 0.6)'
        };
        
        // Variables globales pour les données
        let months = [];
        let commerceData = [];
        let servicesData = [];
        let transportData = [];
        let myChart = null;
        
        // Chargement des données depuis l'API SignalConso
        async function loadDataFromAPI() {
            try {
                // Afficher un indicateur de chargement
                document.getElementById('areaChart').style.opacity = '0.5';
                
                // Récupérer les données depuis l'API avec facettes par catégorie et date
                const response = await fetch('https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=1000&facet=categoriedeprobleme&facet=creationdate');
                const data = await response.json();
                
                // Initialiser les structures de données
                const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
                const currentYear = new Date().getFullYear();
                const monthlyData = {};
                
                // Agréger les données par mois et catégorie
                data.records.forEach(record => {
                    if (record.fields.creationdate && record.fields.categoriedeprobleme) {
                        const date = new Date(record.fields.creationdate);
                        const monthIndex = date.getMonth();
                        const year = date.getFullYear();
                        
                        // Ne prendre que les données de l'année courante
                        if (year === currentYear) {
                            const monthKey = monthNames[monthIndex];
                            const category = record.fields.categoriedeprobleme;
                            
                            if (!monthlyData[monthKey]) {
                                monthlyData[monthKey] = {
                                    commerce: 0,
                                    services: 0,
                                    transport: 0
                                };
                            }
                            
                            // Catégoriser selon le type de problème
                            if (category.toLowerCase().includes('commerce') || 
                                category.toLowerCase().includes('achat') ||
                                category.toLowerCase().includes('produit')) {
                                monthlyData[monthKey].commerce++;
                            } else if (category.toLowerCase().includes('service') ||
                                       category.toLowerCase().includes('prestation')) {
                                monthlyData[monthKey].services++;
                            } else if (category.toLowerCase().includes('transport') ||
                                       category.toLowerCase().includes('voyage')) {
                                monthlyData[monthKey].transport++;
                            } else {
                                // Par défaut, classer dans services
                                monthlyData[monthKey].services++;
                            }
                        }
                    }
                });
                
                // Remplir les tableaux avec les données agrégées
                months = [];
                commerceData = [];
                servicesData = [];
                transportData = [];
                
                monthNames.forEach(month => {
                    if (monthlyData[month]) {
                        months.push(month);
                        commerceData.push(monthlyData[month].commerce);
                        servicesData.push(monthlyData[month].services);
                        transportData.push(monthlyData[month].transport);
                    }
                });
                
                // Si pas assez de données, utiliser les 12 derniers mois
                if (months.length < 6) {
                    months = monthNames;
                    commerceData = new Array(12).fill(0);
                    servicesData = new Array(12).fill(0);
                    transportData = new Array(12).fill(0);
                    
                    // Répartir les données sur les 12 mois
                    data.records.forEach(record => {
                        if (record.fields.creationdate) {
                            const date = new Date(record.fields.creationdate);
                            const monthIndex = date.getMonth();
                            const category = record.fields.categoriedeprobleme || '';
                            
                            if (category.toLowerCase().includes('commerce') || 
                                category.toLowerCase().includes('achat')) {
                                commerceData[monthIndex]++;
                            } else if (category.toLowerCase().includes('service')) {
                                servicesData[monthIndex]++;
                            } else if (category.toLowerCase().includes('transport')) {
                                transportData[monthIndex]++;
                            } else {
                                servicesData[monthIndex]++;
                            }
                        }
                    });
                }
                
                // Restaurer l'opacité
                document.getElementById('areaChart').style.opacity = '1';
                
                // Initialiser le graphique avec les données réelles
                initChart();
                
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                document.getElementById('areaChart').style.opacity = '1';
                alert('Erreur lors du chargement des données. Veuillez réessayer.');
            }
        }
        
        // Configuration du graphique
        const config = {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Commerce',
                        data: commerceData,
                        backgroundColor: dsfrColors.primary,
                        borderColor: '#000091',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Services',
                        data: servicesData,
                        backgroundColor: dsfrColors.success,
                        borderColor: '#18753C',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Transport',
                        data: transportData,
                        backgroundColor: dsfrColors.warning,
                        borderColor: '#B34000',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('fr-FR');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            footer: function(tooltipItems) {
                                let sum = 0;
                                tooltipItems.forEach(function(tooltipItem) {
                                    sum += tooltipItem.parsed.y;
                                });
                                return 'Total: ' + sum.toLocaleString('fr-FR');
                            }
                        }
                    }
                }
            }
        };
        
        // Fonction d'initialisation du graphique
        function initChart() {
            const ctx = document.getElementById('areaChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }
            
            // Mise à jour de la configuration avec les nouvelles données
            config.data.labels = months;
            config.data.datasets[0].data = commerceData;
            config.data.datasets[1].data = servicesData;
            config.data.datasets[2].data = transportData;
            
            myChart = new Chart(ctx, config);
        }
        
        // Basculer empilé/non empilé
        function toggleStacked() {
            const isStacked = document.getElementById('toggle-stacked').checked;
            myChart.options.scales.y.stacked = isStacked;
            myChart.update();
        }
        
        // Mise à jour du tableau
        function updateDataTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            months.forEach((month, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = month;
                row.insertCell(1).textContent = commerceData[index].toLocaleString('fr-FR');
                row.insertCell(2).textContent = servicesData[index].toLocaleString('fr-FR');
                row.insertCell(3).textContent = transportData[index].toLocaleString('fr-FR');
                const total = commerceData[index] + servicesData[index] + transportData[index];
                row.insertCell(4).textContent = total.toLocaleString('fr-FR');
            });
        }
        
        // Afficher/masquer le tableau
        function toggleDataTable() {
            const table = document.getElementById('data-table');
            const isChecked = document.getElementById('toggle-table').checked;
            
            if (isChecked) {
                table.classList.add('show');
                updateDataTable();
            } else {
                table.classList.remove('show');
            }
        }
        
        // Export en PNG
        function exportChartAsPNG() {
            const link = document.createElement('a');
            link.download = 'signalconso-area.png';
            link.href = myChart.toBase64Image();
            link.click();
        }
        
        // Export en CSV
        function exportDataAsCSV() {
            let csv = 'Mois,Commerce,Services,Transport,Total\n';
            months.forEach((month, index) => {
                const total = commerceData[index] + servicesData[index] + transportData[index];
                csv += `${month},${commerceData[index]},${servicesData[index]},${transportData[index]},${total}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'signalconso-area.csv';
            link.click();
        }
        
        // Chargement initial des données au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromAPI();
            
            // Ajouter les event listeners
            document.getElementById('toggle-stacked').addEventListener('change', toggleStacked);
            document.getElementById('toggle-table').addEventListener('change', toggleDataTable);
            document.getElementById('export-png').addEventListener('click', exportChartAsPNG);
            document.getElementById('export-csv').addEventListener('click', exportDataAsCSV);
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>