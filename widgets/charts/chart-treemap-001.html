<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Widget graphique treemap DSFR - Répartition hiérarchique des signalements SignalConso">
    <title>Graphique treemap DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0"></script>
    <style>
        body { margin: 0; font-family: Marianne, arial, sans-serif; }
        .fr-card__body { padding-bottom: 2rem !important; }
        .chart-container { position: relative; height: 500px; margin: 2rem 0; }
        .chart-controls { margin-bottom: 1rem; }
        .data-table { 
            display: none;
            margin-top: 2rem;
        }
        .data-table.show { 
            display: block !important;
        }
        /* Alignement des colonnes du tableau */
        .fr-table th,
        .fr-table td {
            text-align: left;
            padding: 0.75rem;
        }
        .fr-table th:last-child,
        .fr-table td:last-child {
            text-align: right;
        }
        @media (max-width: 768px) {
            .chart-container { height: 400px; }
        }
        .export-buttons { margin-top: 1rem; }
        .legend-item {
            display: inline-block;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 12px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <!-- DÉBUT ZONE WIDGET CHART-TREEMAP-001 -->
    <div id="widget-chart-treemap-001" class="fr-container fr-py-3w">
        <div class="fr-grid-row">
            <div class="fr-col-12">
                <div class="fr-card">
                    <div class="fr-card__body">
                        <h2 class="fr-h4">Répartition hiérarchique des signalements par catégorie</h2>
                        <p class="fr-text--sm">Vue d'ensemble de la distribution des signalements selon leur type et sous-catégorie</p>
                        
                        <!-- Contrôles du graphique -->
                        <div class="chart-controls">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-select-group">
                                        <label class="fr-label" for="view-select">Mode d'affichage</label>
                                        <select class="fr-select" id="view-select" onchange="updateView()">
                                            <option value="volume">Volume (nombre de signalements)</option>
                                            <option value="resolution">Taux de résolution (%)</option>
                                            <option value="satisfaction">Satisfaction moyenne</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-toggle">
                                        <input type="checkbox" class="fr-toggle__input" id="toggle-labels" checked onchange="toggleLabels()">
                                        <label class="fr-toggle__label" for="toggle-labels">
                                            Afficher les étiquettes
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graphique -->
                        <div class="chart-container">
                            <canvas id="treemapChart" role="img" aria-label="Graphique treemap montrant la répartition des signalements"></canvas>
                        </div>
                        
                        <!-- Légende personnalisée -->
                        <div class="fr-mt-2w" id="custom-legend">
                            <p class="fr-text--sm fr-text--bold">Catégories principales :</p>
                            <div id="legend-items"></div>
                        </div>
                        
                        <!-- Boutons d'export -->
                        <div class="export-buttons">
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="exportChartAsPNG()">
                                Exporter en PNG
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="exportDataAsCSV()">
                                Exporter les données (CSV)
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="toggleFullscreen()">
                                Plein écran
                            </button>
                        </div>
                        
                        <!-- Tableau de données alternatif (accessibilité) -->
                        <div class="fr-mt-3w">
                            <button class="fr-btn fr-btn--tertiary" id="toggle-table-btn" aria-expanded="false">
                                Afficher le tableau de données
                            </button>
                        </div>
                        
                        <div class="data-table" id="data-table">
                            <div class="fr-table fr-table--bordered">
                                <div class="fr-table__caption">Données du graphique : Répartition des signalements</div>
                                <div class="fr-table__wrapper">
                                    <div class="fr-table__container">
                                        <div class="fr-table__content">
                                            <table>
                                <thead>
                                    <tr>
                                        <th scope="col">Catégorie</th>
                                        <th scope="col">Sous-catégorie</th>
                                        <th scope="col">Nombre</th>
                                        <th scope="col" style="text-align: right;">%</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <!-- Les données seront insérées ici -->
                                </tbody>
                            </table>
                                        </div>
                                    </div>
                                </div>
                        </div>
                        
                        <!-- Légende et informations -->
                        <div class="fr-alert fr-alert--info fr-mt-3w">
                            <p class="fr-alert__title">À propos de ces données</p>
                            <p>Le treemap représente la hiérarchie des signalements. La taille de chaque rectangle est proportionnelle 
                            au nombre de signalements dans cette catégorie. Les couleurs distinguent les catégories principales.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN ZONE WIDGET CHART-TREEMAP-001 -->
    
    <script>
        // Configuration des couleurs DSFR
        const dsfrColors = {
            primary: '#000091',
            primaryLight: '#6A6AF4',
            success: '#18753C',
            successLight: '#B8FEC9',
            error: '#CE0500',
            errorLight: '#FFE9E9',
            warning: '#B34000',
            warningLight: '#FFE9E6',
            info: '#0063CB',
            infoLight: '#E8EDFF',
            grey: '#666666'
        };
        
        // Palette de couleurs pour les catégories
        const categoryColors = [
            dsfrColors.primary,
            dsfrColors.success,
            dsfrColors.error,
            dsfrColors.warning,
            dsfrColors.info,
            '#9C27B0',
            '#00BCD4',
            '#FF9800'
        ];
        
        // Génération de données hiérarchiques
        const generateTreemapData = () => {
            const categories = {
                'Commerce': {
                    'E-commerce': 4500,
                    'Magasins physiques': 3200,
                    'Services après-vente': 2100,
                    'Promotions trompeuses': 1800
                },
                'Services': {
                    'Téléphonie': 3800,
                    'Énergie': 2900,
                    'Banque/Assurance': 3500,
                    'Transport': 2200
                },
                'Alimentation': {
                    'Restaurants': 2100,
                    'Livraison': 1900,
                    'Hygiène': 1500,
                    'Étiquetage': 1200
                },
                'Immobilier': {
                    'Location': 2800,
                    'Vente': 1600,
                    'Syndic': 1400,
                    'Travaux': 900
                },
                'Santé': {
                    'Pharmacie': 1100,
                    'Optique': 900,
                    'Cosmétiques': 1300,
                    'Compléments': 800
                }
            };
            
            const data = [];
            let colorIndex = 0;
            
            Object.entries(categories).forEach(([category, subcategories]) => {
                const color = categoryColors[colorIndex % categoryColors.length];
                colorIndex++;
                
                Object.entries(subcategories).forEach(([subcategory, value]) => {
                    data.push({
                        category: category,
                        subcategory: subcategory,
                        value: value,
                        color: color,
                        resolution: 60 + Math.random() * 35,
                        satisfaction: 2.5 + Math.random() * 2.5
                    });
                });
            });
            
            return data;
        };
        
        // Données
        let treemapData = generateTreemapData();
        
        // Configuration du graphique
        const config = {
            type: 'treemap',
            data: {
                datasets: [{
                    label: 'Signalements',
                    tree: [],
                    key: 'value',
                    groups: ['category', 'subcategory'],
                    backgroundColor: [],  // Sera rempli avec un tableau de couleurs
                    borderColor: [],  // Sera rempli avec un tableau de couleurs
                    borderWidth: 2,
                    spacing: 1,
                    labels: {
                        display: true,
                        color: 'white',
                        font: {
                            size: 11
                        },
                        formatter: function(ctx) {
                            if (!ctx.raw) return '';
                            const value = ctx.raw.value || 0;
                            return [ctx.raw.subcategory || '', value.toLocaleString('fr-FR')];
                        }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 4,
                        callbacks: {
                            title: function(items) {
                                if (!items[0] || !items[0].raw) return '';
                                const item = items[0].raw;
                                return (item.category || '') + ' > ' + (item.subcategory || '');
                            },
                            label: function(context) {
                                if (!context.raw) return [];
                                const item = context.raw;
                                const result = [];
                                result.push('Signalements: ' + (item._originalValue || item.value || 0).toLocaleString('fr-FR'));
                                if (item._resolution !== undefined) {
                                    result.push('Résolution: ' + item._resolution.toFixed(1) + '%');
                                }
                                if (item._satisfaction !== undefined) {
                                    result.push('Satisfaction: ' + item._satisfaction.toFixed(1) + '/5');
                                }
                                return result;
                            }
                        }
                    }
                }
            }
        };
        
        // Fonction pour préparer les données du treemap
        function prepareTreemapData(mode = 'volume') {
            const groupedData = [];
            
            treemapData.forEach(item => {
                let value;
                switch(mode) {
                    case 'resolution':
                        value = item.resolution;
                        break;
                    case 'satisfaction':
                        value = item.satisfaction * 20; // Normalisation sur 100
                        break;
                    default:
                        value = item.value;
                }
                
                // Structure simple pour chartjs-chart-treemap
                groupedData.push({
                    category: item.category,
                    subcategory: item.subcategory,
                    value: value,
                    _color: item.color,  // Couleur directe
                    _originalValue: item.value,
                    _resolution: item.resolution,
                    _satisfaction: item.satisfaction
                });
            });
            
            return groupedData;
        }
        
        // Préparer les couleurs comme tableaux
        function prepareColors() {
            const bgColors = [];
            const borderColors = [];
            treemapData.forEach(item => {
                bgColors.push(item.color + '80');
                borderColors.push(item.color);
            });
            return { bgColors, borderColors };
        }
        
        // Initialisation du graphique
        const ctx = document.getElementById('treemapChart').getContext('2d');
        const treeDataInit = prepareTreemapData();
        const colorsInit = prepareColors();
        config.data.datasets[0].tree = treeDataInit;
        config.data.datasets[0].backgroundColor = colorsInit.bgColors;
        config.data.datasets[0].borderColor = colorsInit.borderColors;
        const myChart = new Chart(ctx, config);
        
        // Création de la légende personnalisée
        function createLegend() {
            const legendContainer = document.getElementById('legend-items');
            legendContainer.innerHTML = '';
            
            const categories = [...new Set(treemapData.map(item => item.category))];
            
            categories.forEach((category, index) => {
                const color = categoryColors[index % categoryColors.length];
                const item = document.createElement('span');
                item.className = 'legend-item';
                item.innerHTML = `
                    <span class="legend-color" style="background-color: ${color}"></span>
                    ${category}
                `;
                legendContainer.appendChild(item);
            });
        }
        
        // Mise à jour de la vue
        function updateView() {
            const mode = document.getElementById('view-select').value;
            const treeData = prepareTreemapData(mode);
            const colors = prepareColors();
            myChart.data.datasets[0].tree = treeData;
            myChart.data.datasets[0].backgroundColor = colors.bgColors;
            myChart.data.datasets[0].borderColor = colors.borderColors;
            
            // Mise à jour du formatter selon le mode
            myChart.data.datasets[0].labels.formatter = function(ctx) {
                if (!ctx.raw || !ctx.raw._data) return '';
                const item = ctx.raw._data;
                let value;
                switch(mode) {
                    case 'resolution':
                        value = (item.resolution || 0).toFixed(1) + '%';
                        break;
                    case 'satisfaction':
                        value = (item.satisfaction || 0).toFixed(1) + '/5';
                        break;
                    default:
                        value = (item.value || 0).toLocaleString('fr-FR');
                }
                return [item.subcategory || '', value];
            };
            
            myChart.update();
        }
        
        // Toggle des étiquettes
        function toggleLabels() {
            const showLabels = document.getElementById('toggle-labels').checked;
            myChart.data.datasets[0].labels.display = showLabels;
            myChart.update();
        }
        
        // Mise à jour du tableau de données
        function updateDataTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            // Calcul du total
            const total = treemapData.reduce((sum, item) => sum + item.value, 0);
            
            // Tri par catégorie puis sous-catégorie
            const sortedData = [...treemapData].sort((a, b) => {
                if (a.category !== b.category) {
                    return a.category.localeCompare(b.category);
                }
                return b.value - a.value;
            });
            
            sortedData.forEach(item => {
                const row = tableBody.insertRow();
                const cellCategory = row.insertCell(0);
                const cellSubcategory = row.insertCell(1);
                const cellValue = row.insertCell(2);
                const cellPercent = row.insertCell(3);
                
                cellCategory.textContent = item.category;
                cellSubcategory.textContent = item.subcategory;
                cellValue.textContent = item.value.toLocaleString('fr-FR');
                cellPercent.textContent = ((item.value / total) * 100).toFixed(1) + '%';
            });
        }
        
        // Toggle du tableau de données
        function toggleDataTable() {
            const table = document.getElementById('data-table');
            const button = document.getElementById('toggle-table-btn');
            
            if (table.classList.contains('show')) {
                table.classList.remove('show');
                button.setAttribute('aria-expanded', 'false');
                button.textContent = 'Afficher le tableau de données';
            } else {
                table.classList.add('show');
                updateDataTable();
                button.setAttribute('aria-expanded', 'true');
                button.textContent = 'Masquer le tableau de données';
            }
        }
        
        // Export en PNG
        function exportChartAsPNG() {
            const link = document.createElement('a');
            link.download = 'treemap-signalconso.png';
            link.href = myChart.toBase64Image();
            link.click();
        }
        
        // Export en CSV
        function exportDataAsCSV() {
            let csv = 'Catégorie,Sous-catégorie,Nombre,Taux de résolution (%),Satisfaction (sur 5)\n';
            
            const sortedData = [...treemapData].sort((a, b) => {
                if (a.category !== b.category) {
                    return a.category.localeCompare(b.category);
                }
                return b.value - a.value;
            });
            
            sortedData.forEach(item => {
                csv += `"${item.category}","${item.subcategory}",${item.value},${item.resolution.toFixed(1)},${item.satisfaction.toFixed(1)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'treemap-signalconso.csv';
            link.click();
        }
        
        // Mode plein écran
        function toggleFullscreen() {
            const container = document.getElementById('widget-chart-treemap-001');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error(`Erreur lors du passage en plein écran: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Initialisation
        createLegend();
        
        // Event listener pour le bouton
        document.getElementById('toggle-table-btn').addEventListener('click', toggleDataTable);
        
        // Adaptation responsive
        window.addEventListener('resize', () => {
            myChart.resize();
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>