<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Widget graphique en ligne DSFR - Évolution temporelle des données SignalConso">
    <title>Graphique en ligne DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; font-family: Marianne, arial, sans-serif; }
        .chart-container { position: relative; height: 400px; margin: 2rem 0; }
        .chart-controls { margin-bottom: 1rem; }
        .data-table { display: none; }
        .data-table.show { display: table; }
        @media (max-width: 768px) {
            .chart-container { height: 300px; }
        }
        .fr-table { margin-top: 2rem; }
        .export-buttons { margin-top: 1rem; }
    </style>
</head>
<body>
    <!-- DÉBUT ZONE WIDGET CHART-LINE-001 -->
    <div id="widget-chart-line-001" class="fr-container fr-py-3w">
        <div class="fr-grid-row">
            <div class="fr-col-12">
                <div class="fr-card">
                    <div class="fr-card__body">
                        <h2 class="fr-h4">Évolution mensuelle des signalements SignalConso</h2>
                        <p class="fr-text--sm">Nombre de signalements par mois sur les 12 derniers mois</p>
                        
                        <!-- Contrôles du graphique -->
                        <div class="chart-controls">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-select-group">
                                        <label class="fr-label" for="period-select">Période</label>
                                        <select class="fr-select" id="period-select" onchange="updatePeriod()">
                                            <option value="12">12 derniers mois</option>
                                            <option value="6">6 derniers mois</option>
                                            <option value="3">3 derniers mois</option>
                                            <option value="24">24 derniers mois</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-toggle">
                                        <input type="checkbox" class="fr-toggle__input" id="toggle-table" onchange="toggleDataTable()">
                                        <label class="fr-toggle__label" for="toggle-table">
                                            Afficher le tableau de données
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graphique -->
                        <div class="chart-container">
                            <canvas id="lineChart" role="img" aria-label="Graphique montrant l'évolution mensuelle des signalements"></canvas>
                        </div>
                        
                        <!-- Boutons d'export -->
                        <div class="export-buttons">
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="exportChartAsPNG()">
                                Exporter en PNG
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="exportDataAsCSV()">
                                Exporter les données (CSV)
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="toggleFullscreen()">
                                Plein écran
                            </button>
                        </div>
                        
                        <!-- Tableau de données alternatif (accessibilité) -->
                        <table class="fr-table data-table" id="data-table">
                            <caption>Données du graphique : Évolution mensuelle des signalements</caption>
                            <thead>
                                <tr>
                                    <th scope="col">Mois</th>
                                    <th scope="col">Nombre de signalements</th>
                                    <th scope="col">Variation (%)</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- Les données seront insérées ici -->
                            </tbody>
                        </table>
                        
                        <!-- Légende et informations -->
                        <div class="fr-alert fr-alert--info fr-mt-3w">
                            <p class="fr-alert__title">À propos de ces données</p>
                            <p>Les données proviennent de SignalConso, la plateforme de signalement des anomalies de consommation. 
                            Les valeurs sont mises à jour quotidiennement depuis data.economie.gouv.fr.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN ZONE WIDGET CHART-LINE-001 -->
    
    <script>
        // Configuration des couleurs DSFR
        const dsfrColors = {
            primary: '#000091',
            primaryLight: '#6A6AF4',
            success: '#18753C',
            error: '#CE0500',
            warning: '#B34000',
            info: '#0063CB',
            grey: '#666666'
        };
        
        // Données simulées (en production, elles viendraient de l'API)
        const generateMonthlyData = (months) => {
            const data = [];
            const labels = [];
            const currentDate = new Date();
            
            for (let i = months - 1; i >= 0; i--) {
                const date = new Date();
                date.setMonth(currentDate.getMonth() - i);
                const monthName = date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
                labels.push(monthName);
                
                // Simulation de données avec tendance et variation
                const baseValue = 25000;
                const trend = (months - i) * 200;
                const variation = Math.random() * 5000 - 2500;
                data.push(Math.round(baseValue + trend + variation));
            }
            
            return { labels, data };
        };
        
        // Configuration initiale du graphique
        let chartData = generateMonthlyData(12);
        
        const config = {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Nombre de signalements',
                    data: chartData.data,
                    borderColor: dsfrColors.primary,
                    backgroundColor: dsfrColors.primaryLight + '20',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: dsfrColors.primary,
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 4,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return 'Signalements: ' + context.parsed.y.toLocaleString('fr-FR');
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: dsfrColors.grey,
                            font: {
                                size: 12
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#E5E5E5'
                        },
                        ticks: {
                            color: dsfrColors.grey,
                            font: {
                                size: 12
                            },
                            callback: function(value) {
                                return value.toLocaleString('fr-FR');
                            }
                        }
                    }
                }
            }
        };
        
        // Initialisation du graphique
        const ctx = document.getElementById('lineChart').getContext('2d');
        const myChart = new Chart(ctx, config);
        
        // Mise à jour du tableau de données
        function updateDataTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            chartData.labels.forEach((label, index) => {
                const row = tableBody.insertRow();
                const cellMonth = row.insertCell(0);
                const cellValue = row.insertCell(1);
                const cellVariation = row.insertCell(2);
                
                cellMonth.textContent = label;
                cellValue.textContent = chartData.data[index].toLocaleString('fr-FR');
                
                // Calcul de la variation
                if (index > 0) {
                    const variation = ((chartData.data[index] - chartData.data[index - 1]) / chartData.data[index - 1] * 100).toFixed(1);
                    cellVariation.textContent = (variation > 0 ? '+' : '') + variation + '%';
                    cellVariation.style.color = variation > 0 ? dsfrColors.success : dsfrColors.error;
                } else {
                    cellVariation.textContent = '-';
                }
            });
        }
        
        // Mise à jour de la période
        function updatePeriod() {
            const period = parseInt(document.getElementById('period-select').value);
            chartData = generateMonthlyData(period);
            
            myChart.data.labels = chartData.labels;
            myChart.data.datasets[0].data = chartData.data;
            myChart.update();
            
            updateDataTable();
        }
        
        // Afficher/masquer le tableau
        function toggleDataTable() {
            const table = document.getElementById('data-table');
            const isChecked = document.getElementById('toggle-table').checked;
            
            if (isChecked) {
                table.classList.add('show');
                updateDataTable();
            } else {
                table.classList.remove('show');
            }
        }
        
        // Export en PNG
        function exportChartAsPNG() {
            const link = document.createElement('a');
            link.download = 'signalconso-evolution.png';
            link.href = myChart.toBase64Image();
            link.click();
        }
        
        // Export en CSV
        function exportDataAsCSV() {
            let csv = 'Mois,Nombre de signalements\n';
            chartData.labels.forEach((label, index) => {
                csv += `"${label}",${chartData.data[index]}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'signalconso-evolution.csv';
            link.click();
        }
        
        // Mode plein écran
        function toggleFullscreen() {
            const container = document.getElementById('widget-chart-line-001');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error(`Erreur lors du passage en plein écran: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Adaptation responsive
        window.addEventListener('resize', () => {
            myChart.resize();
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>