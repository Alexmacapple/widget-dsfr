<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Widget graphique en barres DSFR - Comparaison des données SignalConso par région">
    <title>Graphique en barres DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; font-family: Marianne, arial, sans-serif; }
        .chart-container { position: relative; height: 400px; margin: 2rem 0; }
        .chart-controls { margin-bottom: 1rem; }
        .data-table { display: none; }
        .data-table.show { display: table; }
        @media (max-width: 768px) {
            .chart-container { height: 500px; } /* Plus haut en mobile pour les labels */
        }
        .fr-table { margin-top: 2rem; }
        .export-buttons { margin-top: 1rem; }
        .stats-cards { margin-top: 2rem; }
    </style>
</head>
<body>
    <!-- DÉBUT ZONE WIDGET CHART-BAR-001 -->
    <div id="widget-chart-bar-001" class="fr-container fr-py-3w">
        <div class="fr-grid-row">
            <div class="fr-col-12">
                <div class="fr-card">
                    <div class="fr-card__body">
                        <h2 class="fr-h4">Répartition des signalements par région</h2>
                        <p class="fr-text--sm">Comparaison du nombre de signalements entre les régions françaises</p>
                        
                        <!-- Contrôles du graphique -->
                        <div class="chart-controls">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-4">
                                    <div class="fr-select-group">
                                        <label class="fr-label" for="chart-type">Type de graphique</label>
                                        <select class="fr-select" id="chart-type" onchange="changeChartType()">
                                            <option value="bar">Barres verticales</option>
                                            <option value="horizontalBar">Barres horizontales</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="fr-col-12 fr-col-md-4">
                                    <div class="fr-select-group">
                                        <label class="fr-label" for="sort-select">Tri</label>
                                        <select class="fr-select" id="sort-select" onchange="sortData()">
                                            <option value="alpha">Alphabétique</option>
                                            <option value="asc">Croissant</option>
                                            <option value="desc">Décroissant</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="fr-col-12 fr-col-md-4">
                                    <div class="fr-toggle">
                                        <input type="checkbox" class="fr-toggle__input" id="toggle-table" onchange="toggleDataTable()">
                                        <label class="fr-toggle__label" for="toggle-table">
                                            Afficher le tableau
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graphique -->
                        <div class="chart-container">
                            <canvas id="barChart" role="img" aria-label="Graphique en barres montrant la répartition par région"></canvas>
                        </div>
                        
                        <!-- Statistiques rapides -->
                        <div class="stats-cards">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-4">
                                    <div class="fr-callout">
                                        <p class="fr-callout__title">Région la plus active</p>
                                        <p class="fr-callout__text" id="max-region">-</p>
                                    </div>
                                </div>
                                <div class="fr-col-12 fr-col-md-4">
                                    <div class="fr-callout">
                                        <p class="fr-callout__title">Moyenne nationale</p>
                                        <p class="fr-callout__text" id="average">-</p>
                                    </div>
                                </div>
                                <div class="fr-col-12 fr-col-md-4">
                                    <div class="fr-callout">
                                        <p class="fr-callout__title">Total signalements</p>
                                        <p class="fr-callout__text" id="total">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Boutons d'export -->
                        <div class="export-buttons">
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="exportChartAsPNG()">
                                Exporter en PNG
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="exportDataAsCSV()">
                                Exporter les données (CSV)
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="toggleFullscreen()">
                                Plein écran
                            </button>
                        </div>
                        
                        <!-- Tableau de données alternatif (accessibilité) -->
                        <table class="fr-table data-table" id="data-table">
                            <caption>Données du graphique : Répartition par région</caption>
                            <thead>
                                <tr>
                                    <th scope="col">Région</th>
                                    <th scope="col">Nombre de signalements</th>
                                    <th scope="col">Pourcentage</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- Les données seront insérées ici -->
                            </tbody>
                        </table>
                        
                        <!-- Légende et informations -->
                        <div class="fr-alert fr-alert--info fr-mt-3w">
                            <p class="fr-alert__title">À propos de ces données</p>
                            <p>Répartition géographique des signalements SignalConso par région administrative. 
                            Les données sont agrégées sur les 12 derniers mois et mises à jour quotidiennement.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN ZONE WIDGET CHART-BAR-001 -->
    
    <script>
        // Configuration des couleurs DSFR
        const dsfrColors = {
            primary: '#000091',
            primaryLight: '#6A6AF4',
            success: '#18753C',
            successLight: '#27A658',
            error: '#CE0500',
            warning: '#B34000',
            info: '#0063CB',
            grey: '#666666',
            palette: [
                '#000091', '#18753C', '#CE0500', '#B34000', '#0063CB',
                '#6A6AF4', '#27A658', '#E94539', '#FC5D00', '#0088CE',
                '#313178', '#2DB783', '#F95C5E', '#FF7638', '#00A9CE'
            ]
        };
        
        // Données des régions françaises (simulées)
        const regionData = {
            'Île-de-France': 45000,
            'Auvergne-Rhône-Alpes': 32000,
            'Nouvelle-Aquitaine': 28000,
            'Occitanie': 26000,
            'Hauts-de-France': 24000,
            'Provence-Alpes-Côte d\'Azur': 23000,
            'Grand Est': 21000,
            'Pays de la Loire': 19000,
            'Bretagne': 18000,
            'Normandie': 16000,
            'Bourgogne-Franche-Comté': 14000,
            'Centre-Val de Loire': 12000,
            'Corse': 3000
        };
        
        // Préparation des données initiales
        let chartLabels = Object.keys(regionData);
        let chartValues = Object.values(regionData);
        
        // Configuration du graphique
        const config = {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Nombre de signalements',
                    data: chartValues,
                    backgroundColor: dsfrColors.primary,
                    borderColor: dsfrColors.primary,
                    borderWidth: 1,
                    hoverBackgroundColor: dsfrColors.primaryLight
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'x',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 4,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y || context.parsed.x;
                                const total = chartValues.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return [
                                    'Signalements: ' + value.toLocaleString('fr-FR'),
                                    'Part: ' + percentage + '%'
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: dsfrColors.grey,
                            font: {
                                size: 11
                            },
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#E5E5E5'
                        },
                        ticks: {
                            color: dsfrColors.grey,
                            font: {
                                size: 12
                            },
                            callback: function(value) {
                                return value.toLocaleString('fr-FR');
                            }
                        }
                    }
                }
            }
        };
        
        // Initialisation du graphique
        const ctx = document.getElementById('barChart').getContext('2d');
        const myChart = new Chart(ctx, config);
        
        // Mise à jour des statistiques
        function updateStats() {
            const total = chartValues.reduce((a, b) => a + b, 0);
            const average = Math.round(total / chartValues.length);
            const maxIndex = chartValues.indexOf(Math.max(...chartValues));
            const maxRegion = chartLabels[maxIndex];
            const maxValue = chartValues[maxIndex];
            
            document.getElementById('max-region').textContent = 
                `${maxRegion} (${maxValue.toLocaleString('fr-FR')})`;
            document.getElementById('average').textContent = 
                average.toLocaleString('fr-FR') + ' signalements';
            document.getElementById('total').textContent = 
                total.toLocaleString('fr-FR') + ' signalements';
        }
        
        // Changement de type de graphique
        function changeChartType() {
            const chartType = document.getElementById('chart-type').value;
            
            if (chartType === 'horizontalBar') {
                myChart.config.options.indexAxis = 'y';
                // Ajuster les options pour les barres horizontales
                myChart.config.options.scales.x.ticks.maxRotation = 0;
                myChart.config.options.scales.x.ticks.minRotation = 0;
            } else {
                myChart.config.options.indexAxis = 'x';
                myChart.config.options.scales.x.ticks.maxRotation = 45;
                myChart.config.options.scales.x.ticks.minRotation = 45;
            }
            
            myChart.update();
        }
        
        // Tri des données
        function sortData() {
            const sortType = document.getElementById('sort-select').value;
            let combined = chartLabels.map((label, index) => ({
                label: label,
                value: chartValues[index]
            }));
            
            switch(sortType) {
                case 'asc':
                    combined.sort((a, b) => a.value - b.value);
                    break;
                case 'desc':
                    combined.sort((a, b) => b.value - a.value);
                    break;
                case 'alpha':
                default:
                    combined.sort((a, b) => a.label.localeCompare(b.label));
            }
            
            chartLabels = combined.map(item => item.label);
            chartValues = combined.map(item => item.value);
            
            myChart.data.labels = chartLabels;
            myChart.data.datasets[0].data = chartValues;
            myChart.update();
            
            updateDataTable();
        }
        
        // Mise à jour du tableau de données
        function updateDataTable() {
            const tableBody = document.getElementById('table-body');
            const total = chartValues.reduce((a, b) => a + b, 0);
            tableBody.innerHTML = '';
            
            chartLabels.forEach((label, index) => {
                const row = tableBody.insertRow();
                const cellRegion = row.insertCell(0);
                const cellValue = row.insertCell(1);
                const cellPercent = row.insertCell(2);
                
                cellRegion.textContent = label;
                cellValue.textContent = chartValues[index].toLocaleString('fr-FR');
                cellPercent.textContent = ((chartValues[index] / total) * 100).toFixed(1) + '%';
            });
        }
        
        // Afficher/masquer le tableau
        function toggleDataTable() {
            const table = document.getElementById('data-table');
            const isChecked = document.getElementById('toggle-table').checked;
            
            if (isChecked) {
                table.classList.add('show');
                updateDataTable();
            } else {
                table.classList.remove('show');
            }
        }
        
        // Export en PNG
        function exportChartAsPNG() {
            const link = document.createElement('a');
            link.download = 'signalconso-regions.png';
            link.href = myChart.toBase64Image();
            link.click();
        }
        
        // Export en CSV
        function exportDataAsCSV() {
            let csv = 'Région,Nombre de signalements,Pourcentage\n';
            const total = chartValues.reduce((a, b) => a + b, 0);
            
            chartLabels.forEach((label, index) => {
                const percentage = ((chartValues[index] / total) * 100).toFixed(1);
                csv += `"${label}",${chartValues[index]},${percentage}%\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'signalconso-regions.csv';
            link.click();
        }
        
        // Mode plein écran
        function toggleFullscreen() {
            const container = document.getElementById('widget-chart-bar-001');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error(`Erreur lors du passage en plein écran: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Initialisation
        updateStats();
        
        // Adaptation responsive
        window.addEventListener('resize', () => {
            myChart.resize();
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>