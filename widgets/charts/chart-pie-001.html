<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Widget graphique camembert DSFR - Répartition des signalements SignalConso par catégorie">
    <title>Graphique camembert DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; font-family: Marianne, arial, sans-serif; }
        .fr-card__body { padding-bottom: 2rem !important; }
        .chart-container { position: relative; height: 400px; margin: 2rem 0; }
        .chart-controls { margin-bottom: 1rem; }
        .data-table { 
            display: none;
            margin-top: 2rem;
        }
        .data-table.show { 
            display: block !important;
        }
        /* Caption DSFR en dehors du tableau */
        .fr-table__caption {
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f6f6f6;
            background-color: var(--background-contrast-grey, #f6f6f6);
            color: #161616;
            color: var(--text-title-grey, #161616);
            font-weight: 700;
            font-size: 1.125rem;
            text-align: left;
            border-left: 3px solid #000091;
            border-left: 3px solid var(--border-plain-blue-france, #000091);
        }
        .legend-container { 
            margin-top: 1rem;
            display: block;
        }
        @media (max-width: 768px) {
            .chart-container { height: 350px; }
        }
        .export-buttons { margin-top: 1rem; }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }
        .legend-color {
            width: 1rem;
            height: 1rem;
            margin-right: 0.75rem;
            border-radius: 2px;
            flex-shrink: 0;
            display: block;
        }
        .legend-item .fr-text--sm {
            line-height: 1rem;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- DÉBUT ZONE WIDGET CHART-PIE-001 -->
    <div id="widget-chart-pie-001" class="fr-container fr-py-3w">
        <div class="fr-grid-row">
            <div class="fr-col-12">
                <div class="fr-card">
                    <div class="fr-card__body">
                        <h2 class="fr-h4">Répartition des signalements par catégorie</h2>
                        <p class="fr-text--sm">Distribution en pourcentage des différentes catégories de signalements</p>
                        
                        <!-- Contrôles du graphique -->
                        <div class="chart-controls">
                            <div class="fr-grid-row fr-grid-row--gutters">
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-select-group">
                                        <label class="fr-label" for="data-type">Données à afficher</label>
                                        <select class="fr-select" id="data-type" onchange="changeDataType()">
                                            <option value="category">Par catégorie</option>
                                            <option value="status">Par statut</option>
                                            <option value="region">Top 5 régions</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="fr-col-12 fr-col-md-6">
                                    <div class="fr-toggle">
                                        <input type="checkbox" class="fr-toggle__input" id="toggle-legend" checked onchange="toggleLegend()">
                                        <label class="fr-toggle__label" for="toggle-legend">
                                            Afficher la légende
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graphique et légende -->
                        <div class="fr-grid-row fr-grid-row--gutters">
                            <div class="fr-col-12 fr-col-lg-8">
                                <div class="chart-container">
                                    <canvas id="pieChart" role="img" aria-label="Graphique camembert montrant la répartition par catégorie"></canvas>
                                </div>
                            </div>
                            <div class="fr-col-12 fr-col-lg-4">
                                <div class="legend-container" id="custom-legend">
                                    <!-- La légende sera générée ici -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Boutons d'export -->
                        <div class="export-buttons">
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="exportChartAsPNG()">
                                Exporter en PNG
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="exportDataAsCSV()">
                                Exporter les données (CSV)
                            </button>
                            <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="toggleFullscreen()">
                                Plein écran
                            </button>
                        </div>
                        
                        <!-- Tableau de données alternatif (accessibilité) -->
                        <div class="fr-mt-3w">
                            <button class="fr-btn fr-btn--tertiary" id="toggle-table-btn" aria-expanded="false" onclick="toggleDataTable()">
                                Afficher le tableau de données
                            </button>
                        </div>
                        
                        <div class="data-table" id="data-table">
                            <div class="fr-table fr-table--bordered">
                                <div class="fr-table__caption">Données du graphique : Répartition par catégorie</div>
                                <div class="fr-table__wrapper">
                                    <div class="fr-table__container">
                                        <div class="fr-table__content">
                                            <table>
                                <thead>
                                    <tr>
                                        <th scope="col">Catégorie</th>
                                        <th scope="col">Nombre</th>
                                        <th scope="col">Pourcentage</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <!-- Les données seront insérées ici -->
                                </tbody>
                            </table>
                                        </div>
                                    </div>
                                </div>
                        </div>
                        
                        <!-- Légende et informations -->
                        <div class="fr-alert fr-alert--info fr-mt-3w">
                            <p class="fr-alert__title">À propos de ces données</p>
                            <p>Répartition des signalements SignalConso par type d'anomalie constatée. 
                            Ces statistiques permettent d'identifier les problématiques de consommation les plus fréquentes.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN ZONE WIDGET CHART-PIE-001 -->
    
    <script>
        // Configuration des couleurs DSFR
        const dsfrColors = {
            palette: [
                '#000091', // Bleu France
                '#18753C', // Vert
                '#CE0500', // Rouge
                '#B34000', // Orange
                '#0063CB', // Bleu clair
                '#6A6AF4', // Violet
                '#27A658', // Vert clair
                '#E94539', // Rouge clair
                '#FC5D00', // Orange vif
                '#0088CE', // Cyan
                '#313178', // Bleu foncé
                '#2DB783'  // Vert menthe
            ]
        };
        
        // Données simulées
        const dataSets = {
            category: {
                labels: [
                    'Téléphonie - Internet - TV',
                    'Voyage - Loisirs',
                    'Produits - Objets',
                    'Voiture / Véhicule',
                    'Travaux - Rénovation',
                    'Santé - Beauté',
                    'Services aux particuliers',
                    'Autres'
                ],
                data: [28500, 24200, 18900, 16500, 14300, 11200, 8900, 7500]
            },
            status: {
                labels: [
                    'Non consulté',
                    'Transmis',
                    'Promesse action',
                    'Infondé',
                    'Mal orienté'
                ],
                data: [45000, 35000, 25000, 15000, 10000]
            },
            region: {
                labels: [
                    'Île-de-France',
                    'Auvergne-Rhône-Alpes',
                    'Nouvelle-Aquitaine',
                    'Occitanie',
                    'Hauts-de-France'
                ],
                data: [45000, 32000, 28000, 26000, 24000]
            }
        };
        
        let currentDataType = 'category';
        
        // Configuration du graphique
        const config = {
            type: 'pie',
            data: {
                labels: dataSets[currentDataType].labels,
                datasets: [{
                    data: dataSets[currentDataType].data,
                    backgroundColor: dsfrColors.palette.slice(0, dataSets[currentDataType].labels.length),
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // On utilise une légende personnalisée
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 4,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return [
                                    label,
                                    'Valeur: ' + value.toLocaleString('fr-FR'),
                                    'Part: ' + percentage + '%'
                                ];
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: false
                }
            }
        };
        
        // Initialisation du graphique
        const ctx = document.getElementById('pieChart').getContext('2d');
        const myChart = new Chart(ctx, config);
        
        // Génération de la légende personnalisée
        function generateCustomLegend() {
            const legendContainer = document.getElementById('custom-legend');
            const data = myChart.data;
            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
            let legendHTML = '<h3 class="fr-h6">Légende</h3>';
            
            data.labels.forEach((label, index) => {
                const value = data.datasets[0].data[index];
                const percentage = ((value / total) * 100).toFixed(1);
                const color = data.datasets[0].backgroundColor[index];
                
                legendHTML += `
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: ${color}"></span>
                        <span class="fr-text--sm">
                            ${label}: ${percentage}%
                        </span>
                    </div>
                `;
            });
            
            legendContainer.innerHTML = legendHTML;
        }
        
        // Changement de type de données
        function changeDataType() {
            currentDataType = document.getElementById('data-type').value;
            const newData = dataSets[currentDataType];
            
            myChart.data.labels = newData.labels;
            myChart.data.datasets[0].data = newData.data;
            myChart.data.datasets[0].backgroundColor = dsfrColors.palette.slice(0, newData.labels.length);
            myChart.update();
            
            generateCustomLegend();
            updateDataTable();
        }
        
        // Afficher/masquer la légende
        function toggleLegend() {
            const legendContainer = document.getElementById('custom-legend');
            const isChecked = document.getElementById('toggle-legend').checked;
            legendContainer.style.display = isChecked ? 'block' : 'none';
        }
        
        // Mise à jour du tableau de données
        function updateDataTable() {
            const tableBody = document.getElementById('table-body');
            const data = myChart.data.datasets[0].data;
            const labels = myChart.data.labels;
            const total = data.reduce((a, b) => a + b, 0);
            
            tableBody.innerHTML = '';
            
            labels.forEach((label, index) => {
                const row = tableBody.insertRow();
                const cellLabel = row.insertCell(0);
                const cellValue = row.insertCell(1);
                const cellPercent = row.insertCell(2);
                
                cellLabel.textContent = label;
                cellValue.textContent = data[index].toLocaleString('fr-FR');
                cellPercent.textContent = ((data[index] / total) * 100).toFixed(1) + '%';
            });
        }
        
        // Afficher/masquer le tableau
        function toggleDataTable() {
            const table = document.getElementById('data-table');
            const button = document.getElementById('toggle-table-btn');
            
            if (table.classList.contains('show')) {
                table.classList.remove('show');
                button.setAttribute('aria-expanded', 'false');
                button.textContent = 'Afficher le tableau de données';
            } else {
                table.classList.add('show');
                updateDataTable();
                button.setAttribute('aria-expanded', 'true');
                button.textContent = 'Masquer le tableau de données';
            }
        }
        
        // Export en PNG
        function exportChartAsPNG() {
            const link = document.createElement('a');
            link.download = 'signalconso-repartition.png';
            link.href = myChart.toBase64Image();
            link.click();
        }
        
        // Export en CSV
        function exportDataAsCSV() {
            const data = myChart.data.datasets[0].data;
            const labels = myChart.data.labels;
            const total = data.reduce((a, b) => a + b, 0);
            
            let csv = 'Catégorie,Nombre,Pourcentage\n';
            labels.forEach((label, index) => {
                const percentage = ((data[index] / total) * 100).toFixed(1);
                csv += `"${label}",${data[index]},${percentage}%\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'signalconso-repartition.csv';
            link.click();
        }
        
        // Mode plein écran
        function toggleFullscreen() {
            const container = document.getElementById('widget-chart-pie-001');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error(`Erreur lors du passage en plein écran: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Initialisation
        generateCustomLegend();
        
        // Adaptation responsive
        window.addEventListener('resize', () => {
            myChart.resize();
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>