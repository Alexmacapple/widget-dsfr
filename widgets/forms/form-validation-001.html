<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Widget validation temps réel DSFR pour SignalConso">
    <title>Validation temps réel DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <style>
        body { margin: 0; font-family: Marianne, arial, sans-serif; }
        
        /* Styles de validation */
        .fr-input-group--valid .fr-input {
            border-color: #18753C;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2318753C' stroke-width='2'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        .fr-input-group--error .fr-input {
            border-color: #CE0500;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23CE0500' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='12' y1='8' x2='12' y2='12'%3E%3C/line%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        .fr-input-group--warning .fr-input {
            border-color: #B34000;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23B34000' stroke-width='2'%3E%3Cpath d='M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z'%3E%3C/path%3E%3Cline x1='12' y1='9' x2='12' y2='13'%3E%3C/line%3E%3Cline x1='12' y1='17' x2='12.01' y2='17'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        /* Messages de validation */
        .fr-message {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }
        
        .fr-message.show {
            display: flex;
        }
        
        .fr-message--valid {
            color: #18753C;
        }
        
        .fr-message--error {
            color: #CE0500;
        }
        
        .fr-message--warning {
            color: #B34000;
        }
        
        .fr-message--info {
            color: #0063CB;
        }
        
        /* Indicateur de force du mot de passe */
        .password-strength {
            margin-top: 0.5rem;
        }
        
        .password-strength-bar {
            height: 4px;
            background: #e5e5e5;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .password-strength-fill {
            height: 100%;
            transition: width 0.3s, background-color 0.3s;
        }
        
        .strength-weak {
            width: 33%;
            background: #CE0500;
        }
        
        .strength-medium {
            width: 66%;
            background: #B34000;
        }
        
        .strength-strong {
            width: 100%;
            background: #18753C;
        }
        
        .password-requirements {
            font-size: 0.75rem;
            color: #161616;
            margin-top: 0.5rem;
        }
        
        .requirement {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .requirement.met {
            color: #18753C;
        }
        
        .requirement-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        
        /* Compteur de caractères */
        .char-counter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #161616;
        }
        
        .char-counter.warning {
            color: #B34000;
        }
        
        .char-counter.error {
            color: #CE0500;
        }
        
        /* Indicateur de saisie en cours */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #0063CB;
        }
        
        .typing-indicator.show {
            display: flex;
        }
        
        .typing-indicator::after {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #0063CB;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Validation en temps réel pour les champs spéciaux */
        .validation-feedback {
            background: #f6f6f6;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .validation-feedback.show {
            display: block;
        }
        
        .validation-feedback-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #161616;
        }
        
        .validation-feedback-content {
            font-size: 0.875rem;
            color: #161616;
        }
        
        /* Exemples de sections */
        .example-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #e5e5e5;
        }
        
        /* Indicateur de validation asynchrone */
        .async-validation {
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #0063CB;
        }
        
        .async-validation.show {
            display: flex;
        }
        
        .async-validation-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #0063CB;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Format des badges */
        .format-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #e5e5fe;
            color: #000091;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .example-section {
                padding: 1rem;
            }
        }
    </style>
    <script src="../js/wrapper-api.js"></script>
</head>
<body>

    <!-- Skip links pour l'accessibilité -->
    <div class="fr-skiplinks">
        <nav class="fr-container" role="navigation" aria-label="Accès rapide">
            <ul class="fr-skiplinks__list">
                <li><a class="fr-link" href="#content">Aller au contenu</a></li>
                <li><a class="fr-link" href="#fr-footer">Aller au pied de page</a></li>
            </ul>
        </nav>
    </div>


    <!-- Header DSFR -->
    <header role="banner" class="fr-header">
        <div class="fr-header__body">
            <div class="fr-container">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand fr-enlarge-link">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                                <p class="fr-logo">
                                    République
                                    <br>Française
                                </p>
                            </div>
                        </div>
                        <div class="fr-header__service">
                            <a href="/" title="Accueil - SignalConso">
                                <p class="fr-header__service-title">
                                    SignalConso
                                </p>
                            </a>
                            <p class="fr-header__service-tagline">Formulaire de saisie SignalConso - data.economie.gouv.fr</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <!-- Main content -->
    <main id="content" role="main">
        <div class="fr-container fr-py-6w">
            <div id="widget-form-validation-001" class="fr-container fr-py-3w">
        <h1 class="fr-h3">Validation temps réel des formulaires</h1>
        <p class="fr-text--lead">Validation instantanée avec messages contextuels pour SignalConso</p>
        
        <!-- Section 1: Validation basique -->
        <div class="example-section">
            <h2 class="fr-h4">Validation des informations personnelles</h2>
            <p class="fr-text--sm">Les champs sont validés en temps réel pendant la saisie</p>
            
            <form class="fr-form" novalidate>
                <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-12 fr-col-md-6">
                        <div class="fr-input-group" id="group-prenom">
                            <label class="fr-label" for="prenom">
                                Prénom
                                <span class="fr-hint-text">Minimum 2 caractères</span>
                            </label>
                            <input 
                                class="fr-input" 
                                type="text" 
                                id="prenom" 
                                name="prenom"
                                data-validation="name"
                                data-min-length="2"
                                required>
                            <span class="fr-message fr-message--error">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                </svg>
                                <span class="message-text">Le prénom est trop court</span>
                            </span>
                            <span class="fr-message fr-message--valid">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                <span class="message-text">Prénom valide</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="fr-col-12 fr-col-md-6">
                        <div class="fr-input-group" id="group-nom">
                            <label class="fr-label" for="nom">
                                Nom
                                <span class="fr-hint-text">Minimum 2 caractères</span>
                            </label>
                            <input 
                                class="fr-input" 
                                type="text" 
                                id="nom" 
                                name="nom"
                                data-validation="name"
                                data-min-length="2"
                                required>
                            <span class="fr-message fr-message--error">
                                <span class="message-text">Le nom est trop court</span>
                            </span>
                            <span class="fr-message fr-message--valid">
                                <span class="message-text">Nom valide</span>
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="fr-input-group" id="group-email">
                    <label class="fr-label" for="email">
                        Adresse électronique
                        <span class="fr-hint-text">Format : nom@exemple.fr</span>
                    </label>
                    <input 
                        class="fr-input" 
                        type="email" 
                        id="email" 
                        name="email"
                        data-validation="email"
                        required>
                    <span class="fr-message fr-message--error">
                        <span class="message-text">Format d'email invalide</span>
                    </span>
                    <span class="fr-message fr-message--valid">
                        <span class="message-text">Email valide</span>
                    </span>
                    <span class="fr-message fr-message--info">
                        <span class="message-text">Nous vérifierons que cette adresse existe</span>
                    </span>
                    <div class="async-validation" id="email-check">
                        <div class="async-validation-spinner"></div>
                        <span>Vérification de l'adresse email...</span>
                    </div>
                </div>
                
                <div class="fr-input-group" id="group-telephone">
                    <label class="fr-label" for="telephone">
                        Téléphone
                        <span class="fr-hint-text">Format : 06 12 34 56 78</span>
                    </label>
                    <input 
                        class="fr-input" 
                        type="tel" 
                        id="telephone" 
                        name="telephone"
                        data-validation="phone"
                        placeholder="06 12 34 56 78">
                    <span class="fr-message fr-message--error">
                        <span class="message-text">Format de téléphone invalide</span>
                    </span>
                    <span class="fr-message fr-message--valid">
                        <span class="message-text">Numéro valide</span>
                    </span>
                    <span class="fr-message fr-message--warning">
                        <span class="message-text">Ce numéro semble être un fixe</span>
                    </span>
                </div>
            </form>
        </div>
        
        <!-- Section 2: Validation avancée -->
        <div class="example-section">
            <h2 class="fr-h4">Validation avancée</h2>
            <p class="fr-text--sm">Validation de formats spécifiques avec retour visuel détaillé</p>
            
            <form class="fr-form" novalidate>
                <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-12 fr-col-md-6">
                        <div class="fr-input-group" id="group-siret">
                            <label class="fr-label" for="siret">
                                SIRET
                                <span class="fr-hint-text">14 chiffres</span>
                                <span class="format-badge">Format: 123 456 789 01234</span>
                            </label>
                            <input 
                                class="fr-input" 
                                type="text" 
                                id="siret" 
                                name="siret"
                                data-validation="siret"
                                placeholder="123 456 789 01234"
                                maxlength="18">
                            <span class="fr-message fr-message--error">
                                <span class="message-text">SIRET invalide</span>
                            </span>
                            <span class="fr-message fr-message--valid">
                                <span class="message-text">SIRET valide</span>
                            </span>
                            <div class="validation-feedback" id="siret-feedback">
                                <div class="validation-feedback-title">Information entreprise</div>
                                <div class="validation-feedback-content"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fr-col-12 fr-col-md-6">
                        <div class="fr-input-group" id="group-codepostal">
                            <label class="fr-label" for="codepostal">
                                Code postal
                                <span class="fr-hint-text">5 chiffres</span>
                            </label>
                            <input 
                                class="fr-input" 
                                type="text" 
                                id="codepostal" 
                                name="codepostal"
                                data-validation="postalcode"
                                placeholder="75001"
                                maxlength="5">
                            <span class="fr-message fr-message--error">
                                <span class="message-text">Code postal invalide</span>
                            </span>
                            <span class="fr-message fr-message--valid">
                                <span class="message-text">Code postal valide</span>
                            </span>
                            <div class="validation-feedback" id="postalcode-feedback">
                                <div class="validation-feedback-title">Commune détectée</div>
                                <div class="validation-feedback-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-12 fr-col-md-6">
                        <div class="fr-input-group" id="group-iban">
                            <label class="fr-label" for="iban">
                                IBAN
                                <span class="fr-hint-text">Format international</span>
                            </label>
                            <input 
                                class="fr-input" 
                                type="text" 
                                id="iban" 
                                name="iban"
                                data-validation="iban"
                                placeholder="FR76 1234 5678 9012 3456 7890 123">
                            <span class="fr-message fr-message--error">
                                <span class="message-text">IBAN invalide</span>
                            </span>
                            <span class="fr-message fr-message--valid">
                                <span class="message-text">IBAN valide</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="fr-col-12 fr-col-md-6">
                        <div class="fr-input-group" id="group-url">
                            <label class="fr-label" for="url">
                                Site web
                                <span class="fr-hint-text">URL complète</span>
                            </label>
                            <input 
                                class="fr-input" 
                                type="url" 
                                id="url" 
                                name="url"
                                data-validation="url"
                                placeholder="https://www.exemple.fr">
                            <span class="fr-message fr-message--error">
                                <span class="message-text">URL invalide</span>
                            </span>
                            <span class="fr-message fr-message--valid">
                                <span class="message-text">URL valide</span>
                            </span>
                            <span class="fr-message fr-message--warning">
                                <span class="message-text">Attention : pas de HTTPS</span>
                            </span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Section 3: Mot de passe et sécurité -->
        <div class="example-section">
            <h2 class="fr-h4">Validation de mot de passe</h2>
            <p class="fr-text--sm">Indicateur de force et validation des critères de sécurité</p>
            
            <form class="fr-form" novalidate>
                <div class="fr-input-group" id="group-password">
                    <label class="fr-label" for="password">
                        Mot de passe
                        <span class="fr-hint-text">Minimum 8 caractères</span>
                    </label>
                    <input 
                        class="fr-input" 
                        type="password" 
                        id="password" 
                        name="password"
                        data-validation="password">
                    <div class="password-strength">
                        <div class="password-strength-bar">
                            <div class="password-strength-fill" id="password-strength"></div>
                        </div>
                        <div class="password-requirements">
                            <div class="requirement" data-requirement="length">
                                <span class="requirement-icon">○</span>
                                <span>Au moins 8 caractères</span>
                            </div>
                            <div class="requirement" data-requirement="uppercase">
                                <span class="requirement-icon">○</span>
                                <span>Une lettre majuscule</span>
                            </div>
                            <div class="requirement" data-requirement="lowercase">
                                <span class="requirement-icon">○</span>
                                <span>Une lettre minuscule</span>
                            </div>
                            <div class="requirement" data-requirement="number">
                                <span class="requirement-icon">○</span>
                                <span>Un chiffre</span>
                            </div>
                            <div class="requirement" data-requirement="special">
                                <span class="requirement-icon">○</span>
                                <span>Un caractère spécial</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fr-input-group" id="group-password-confirm">
                    <label class="fr-label" for="password-confirm">
                        Confirmation du mot de passe
                        <span class="fr-hint-text">Saisissez à nouveau votre mot de passe</span>
                    </label>
                    <input 
                        class="fr-input" 
                        type="password" 
                        id="password-confirm" 
                        name="password-confirm"
                        data-validation="password-confirm">
                    <span class="fr-message fr-message--error">
                        <span class="message-text">Les mots de passe ne correspondent pas</span>
                    </span>
                    <span class="fr-message fr-message--valid">
                        <span class="message-text">Les mots de passe correspondent</span>
                    </span>
                </div>
            </form>
        </div>
        
        <!-- Section 4: Champs texte avec compteur -->
        <div class="example-section">
            <h2 class="fr-h4">Champs texte avec validation de longueur</h2>
            <p class="fr-text--sm">Compteur de caractères et validation en temps réel</p>
            
            <form class="fr-form" novalidate>
                <div class="fr-input-group" id="group-titre">
                    <label class="fr-label" for="titre">
                        Titre du signalement
                        <span class="fr-hint-text">Entre 10 et 100 caractères</span>
                    </label>
                    <input 
                        class="fr-input" 
                        type="text" 
                        id="titre" 
                        name="titre"
                        data-validation="text"
                        data-min-length="10"
                        data-max-length="100">
                    <div class="char-counter">
                        <span class="char-count">0 / 100 caractères</span>
                        <span class="char-status"></span>
                    </div>
                    <span class="typing-indicator">
                        <span>En cours de saisie</span>
                    </span>
                </div>
                
                <div class="fr-input-group" id="group-description">
                    <label class="fr-label" for="description">
                        Description détaillée
                        <span class="fr-hint-text">Entre 50 et 2000 caractères</span>
                    </label>
                    <textarea 
                        class="fr-input" 
                        id="description" 
                        name="description"
                        rows="6"
                        data-validation="text"
                        data-min-length="50"
                        data-max-length="2000"></textarea>
                    <div class="char-counter">
                        <span class="char-count">0 / 2000 caractères</span>
                        <span class="char-status"></span>
                    </div>
                    <span class="fr-message fr-message--error">
                        <span class="message-text">Description trop courte (minimum 50 caractères)</span>
                    </span>
                    <span class="fr-message fr-message--valid">
                        <span class="message-text">Description valide</span>
                    </span>
                </div>
            </form>
        </div>
        
        <!-- Bouton de soumission avec récapitulatif -->
        <div class="fr-card fr-mt-3w">
            <div class="fr-card__body">
                <h3 class="fr-h5">Récapitulatif de validation</h3>
                <div id="validation-summary">
                    <p class="fr-text--sm">Remplissez le formulaire pour voir le récapitulatif</p>
                </div>
                <button class="fr-btn fr-mt-2w" onclick="validateAll()">
                    Valider tous les champs
                </button>
            </div>
        </div>
    </div>
    <!-- FIN ZONE WIDGET FORM-VALIDATION-001 -->
    
    <script>
        // Configuration de validation
        const validationRules = {
            name: {
                pattern: /^[a-zA-ZÀ-ÿ\s\-']+$/,
                minLength: 2,
                message: {
                    error: 'Le nom doit contenir au moins 2 caractères alphabétiques',
                    valid: 'Nom valide'
                }
            },
            email: {
                pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                async: true,
                message: {
                    error: 'Format d\'email invalide',
                    valid: 'Email valide'
                }
            },
            phone: {
                pattern: /^(?:(?:\+|00)33|0)\s*[1-9](?:[\s.-]*\d{2}){4}$/,
                format: (value) => {
                    return value.replace(/(\d{2})(?=\d)/g, '$1 ').trim();
                },
                message: {
                    error: 'Format de téléphone invalide',
                    valid: 'Numéro valide',
                    warning: 'Ce numéro semble être un fixe'
                }
            },
            siret: {
                pattern: /^\d{14}$/,
                format: (value) => {
                    const clean = value.replace(/\s/g, '');
                    return clean.replace(/(\d{3})(\d{3})(\d{3})(\d{5})/, '$1 $2 $3 $4');
                },
                validate: (value) => {
                    const clean = value.replace(/\s/g, '');
                    if (clean.length !== 14) return false;
                    // Algorithme de Luhn pour SIRET
                    let sum = 0;
                    for (let i = 0; i < 14; i++) {
                        let digit = parseInt(clean[i]);
                        if (i % 2 === 0) digit *= 2;
                        if (digit > 9) digit -= 9;
                        sum += digit;
                    }
                    return sum % 10 === 0;
                },
                message: {
                    error: 'SIRET invalide',
                    valid: 'SIRET valide'
                }
            },
            postalcode: {
                pattern: /^\d{5}$/,
                async: true,
                message: {
                    error: 'Code postal invalide',
                    valid: 'Code postal valide'
                }
            },
            iban: {
                pattern: /^[A-Z]{2}\d{2}[\s]?([A-Z0-9]{4}[\s]?){5}[A-Z0-9]{1,3}$/,
                format: (value) => {
                    const clean = value.replace(/\s/g, '').toUpperCase();
                    return clean.replace(/(.{4})/g, '$1 ').trim();
                },
                message: {
                    error: 'IBAN invalide',
                    valid: 'IBAN valide'
                }
            },
            url: {
                pattern: /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/,
                message: {
                    error: 'URL invalide',
                    valid: 'URL valide',
                    warning: 'Attention : pas de HTTPS'
                }
            },
            password: {
                validate: (value) => {
                    const requirements = {
                        length: value.length >= 8,
                        uppercase: /[A-Z]/.test(value),
                        lowercase: /[a-z]/.test(value),
                        number: /\d/.test(value),
                        special: /[!@#$%^&*(),.?":{}|<>]/.test(value)
                    };
                    return requirements;
                }
            },
            text: {
                validate: (value, element) => {
                    const minLength = parseInt(element.dataset.minLength) || 0;
                    const maxLength = parseInt(element.dataset.maxLength) || Infinity;
                    return value.length >= minLength && value.length <= maxLength;
                }
            }
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            setupValidation();
        });
        
        // Configuration de la validation
        function setupValidation() {
            // Parcourir tous les champs avec validation
            document.querySelectorAll('[data-validation]').forEach(input => {
                const validationType = input.dataset.validation;
                
                // Validation en temps réel
                input.addEventListener('input', debounce(() => {
                    validateField(input, validationType);
                }, 300));
                
                // Validation sur blur
                input.addEventListener('blur', () => {
                    validateField(input, validationType);
                });
                
                // Formatage automatique
                if (validationRules[validationType]?.format) {
                    input.addEventListener('input', () => {
                        const formatted = validationRules[validationType].format(input.value);
                        if (formatted !== input.value) {
                            input.value = formatted;
                        }
                    });
                }
                
                // Compteur de caractères
                if (validationType === 'text') {
                    setupCharCounter(input);
                }
                
                // Mot de passe
                if (validationType === 'password') {
                    setupPasswordValidation(input);
                }
                
                // Confirmation mot de passe
                if (validationType === 'password-confirm') {
                    setupPasswordConfirm(input);
                }
            });
        }
        
        // Validation d'un champ
        async function validateField(input, validationType) {
            const group = input.closest('.fr-input-group');
            const rule = validationRules[validationType];
            
            if (!rule || !input.value) {
                resetValidation(group);
                return;
            }
            
            let isValid = false;
            let validationResult = null;
            
            // Validation personnalisée
            if (rule.validate) {
                validationResult = rule.validate(input.value, input);
                isValid = typeof validationResult === 'boolean' ? validationResult : true;
            }
            // Validation par pattern
            else if (rule.pattern) {
                isValid = rule.pattern.test(input.value);
            }
            
            // Validation asynchrone
            if (rule.async && isValid) {
                await performAsyncValidation(input, validationType);
                return;
            }
            
            // Appliquer le résultat
            if (isValid) {
                showValid(group, rule.message?.valid);
            } else {
                showError(group, rule.message?.error);
            }
            
            // Cas spéciaux
            handleSpecialCases(input, validationType, isValid);
        }
        
        // Validation asynchrone
        async function performAsyncValidation(input, validationType) {
            const group = input.closest('.fr-input-group');
            const asyncIndicator = group.querySelector('.async-validation');
            
            if (asyncIndicator) {
                asyncIndicator.classList.add('show');
            }
            
            // Simulation d'appel API
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (asyncIndicator) {
                asyncIndicator.classList.remove('show');
            }
            
            // Validation spécifique
            if (validationType === 'email') {
                // Vérifier si l'email existe (simulation)
                const exists = Math.random() > 0.3;
                if (exists) {
                    showValid(group, 'Email valide et disponible');
                } else {
                    showError(group, 'Cette adresse email est déjà utilisée');
                }
            } else if (validationType === 'postalcode') {
                // Récupérer la commune
                const response = await fetchCompat(`https://geo.api.gouv.fr/communes?codePostal=${input.value}&fields=nom`);
                const data = await response.json();
                
                if (data.length > 0) {
                    showValid(group, 'Code postal valide');
                    const feedback = document.getElementById('postalcode-feedback');
                    if (feedback) {
                        feedback.classList.add('show');
                        feedback.querySelector('.validation-feedback-content').textContent = 
                            data.map(c => c.nom).join(', ');
                    }
                } else {
                    showError(group, 'Code postal invalide');
                }
            }
        }
        
        // Cas spéciaux de validation
        function handleSpecialCases(input, validationType, isValid) {
            const group = input.closest('.fr-input-group');
            
            // SIRET - Récupérer info entreprise
            if (validationType === 'siret' && isValid) {
                const feedback = document.getElementById('siret-feedback');
                if (feedback) {
                    feedback.classList.add('show');
                    feedback.querySelector('.validation-feedback-content').innerHTML = `
                        <strong>Entreprise trouvée:</strong><br>
                        EXEMPLE SARL<br>
                        123 rue de la République<br>
                        75001 PARIS
                    `;
                }
            }
            
            // URL - Vérifier HTTPS
            if (validationType === 'url' && isValid) {
                if (!input.value.startsWith('https://')) {
                    showWarning(group, 'Attention : connexion non sécurisée (pas de HTTPS)');
                }
            }
            
            // Téléphone - Détecter le type
            if (validationType === 'phone' && isValid) {
                const cleanPhone = input.value.replace(/\D/g, '');
                if (cleanPhone.startsWith('01') || cleanPhone.startsWith('02') || 
                    cleanPhone.startsWith('03') || cleanPhone.startsWith('04') || 
                    cleanPhone.startsWith('05')) {
                    showWarning(group, 'Ce numéro semble être un fixe');
                }
            }
        }
        
        // Configuration du compteur de caractères
        function setupCharCounter(input) {
            const group = input.closest('.fr-input-group');
            const counter = group.querySelector('.char-counter');
            const typingIndicator = group.querySelector('.typing-indicator');
            
            if (!counter) return;
            
            const minLength = parseInt(input.dataset.minLength) || 0;
            const maxLength = parseInt(input.dataset.maxLength) || Infinity;
            
            let typingTimeout;
            
            input.addEventListener('input', () => {
                const length = input.value.length;
                const countElement = counter.querySelector('.char-count');
                
                if (maxLength !== Infinity) {
                    countElement.textContent = `${length} / ${maxLength} caractères`;
                } else {
                    countElement.textContent = `${length} caractères`;
                }
                
                // Couleur du compteur
                counter.classList.remove('warning', 'error');
                if (length > maxLength) {
                    counter.classList.add('error');
                } else if (length > maxLength * 0.9) {
                    counter.classList.add('warning');
                }
                
                // Indicateur de saisie
                if (typingIndicator) {
                    typingIndicator.classList.add('show');
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        typingIndicator.classList.remove('show');
                    }, 1000);
                }
                
                // Validation
                if (length >= minLength && length <= maxLength) {
                    showValid(group, 'Longueur correcte');
                } else if (length < minLength) {
                    showError(group, `Minimum ${minLength} caractères requis`);
                } else {
                    showError(group, `Maximum ${maxLength} caractères autorisés`);
                }
            });
        }
        
        // Configuration validation mot de passe
        function setupPasswordValidation(input) {
            const group = input.closest('.fr-input-group');
            const strengthBar = document.getElementById('password-strength');
            const requirements = group.querySelectorAll('.requirement');
            
            input.addEventListener('input', () => {
                const value = input.value;
                const validation = validationRules.password.validate(value);
                
                // Mise à jour des critères
                Object.keys(validation).forEach(key => {
                    const req = group.querySelector(`[data-requirement="${key}"]`);
                    if (req) {
                        if (validation[key]) {
                            req.classList.add('met');
                            req.querySelector('.requirement-icon').textContent = '✓';
                        } else {
                            req.classList.remove('met');
                            req.querySelector('.requirement-icon').textContent = '○';
                        }
                    }
                });
                
                // Calcul de la force
                const metCount = Object.values(validation).filter(v => v).length;
                const strength = (metCount / 5) * 100;
                
                if (strengthBar) {
                    strengthBar.className = 'password-strength-fill';
                    if (strength <= 40) {
                        strengthBar.classList.add('strength-weak');
                    } else if (strength <= 70) {
                        strengthBar.classList.add('strength-medium');
                    } else {
                        strengthBar.classList.add('strength-strong');
                    }
                }
                
                // Validation globale
                if (metCount === 5) {
                    showValid(group, 'Mot de passe fort');
                } else if (metCount >= 3) {
                    showWarning(group, 'Mot de passe moyen');
                } else {
                    showError(group, 'Mot de passe faible');
                }
            });
        }
        
        // Configuration confirmation mot de passe
        function setupPasswordConfirm(input) {
            const group = input.closest('.fr-input-group');
            const passwordInput = document.getElementById('password');
            
            input.addEventListener('input', () => {
                if (input.value === passwordInput.value && input.value) {
                    showValid(group, 'Les mots de passe correspondent');
                } else if (input.value) {
                    showError(group, 'Les mots de passe ne correspondent pas');
                } else {
                    resetValidation(group);
                }
            });
        }
        
        // Affichage des états
        function showValid(group, message) {
            resetValidation(group);
            group.classList.add('fr-input-group--valid');
            const validMessage = group.querySelector('.fr-message--valid');
            if (validMessage && message) {
                validMessage.querySelector('.message-text').textContent = message;
                validMessage.classList.add('show');
            }
        }
        
        function showError(group, message) {
            resetValidation(group);
            group.classList.add('fr-input-group--error');
            const errorMessage = group.querySelector('.fr-message--error');
            if (errorMessage && message) {
                errorMessage.querySelector('.message-text').textContent = message;
                errorMessage.classList.add('show');
            }
        }
        
        function showWarning(group, message) {
            resetValidation(group);
            group.classList.add('fr-input-group--warning');
            const warningMessage = group.querySelector('.fr-message--warning');
            if (warningMessage && message) {
                warningMessage.querySelector('.message-text').textContent = message;
                warningMessage.classList.add('show');
            }
        }
        
        function resetValidation(group) {
            group.classList.remove('fr-input-group--valid', 'fr-input-group--error', 'fr-input-group--warning');
            group.querySelectorAll('.fr-message').forEach(msg => msg.classList.remove('show'));
        }
        
        // Validation globale
        function validateAll() {
            const summary = document.getElementById('validation-summary');
            const results = [];
            
            document.querySelectorAll('[data-validation]').forEach(input => {
                const validationType = input.dataset.validation;
                validateField(input, validationType);
                
                const group = input.closest('.fr-input-group');
                const label = group.querySelector('.fr-label').textContent.trim();
                const isValid = group.classList.contains('fr-input-group--valid');
                const hasError = group.classList.contains('fr-input-group--error');
                
                results.push({
                    label: label.split('\n')[0],
                    status: isValid ? 'valid' : hasError ? 'error' : 'empty',
                    value: input.value
                });
            });
            
            // Afficher le récapitulatif
            const validCount = results.filter(r => r.status === 'valid').length;
            const errorCount = results.filter(r => r.status === 'error').length;
            const emptyCount = results.filter(r => r.status === 'empty').length;
            
            summary.innerHTML = `
                <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-4">
                        <span class="fr-text--bold" style="color: #18753C">✓ ${validCount} valides</span>
                    </div>
                    <div class="fr-col-4">
                        <span class="fr-text--bold" style="color: #CE0500">✗ ${errorCount} erreurs</span>
                    </div>
                    <div class="fr-col-4">
                        <span class="fr-text--bold" style="color: #161616">○ ${emptyCount} vides</span>
                    </div>
                </div>
                <div class="fr-mt-2w">
                    ${results.map(r => `
                        <div class="fr-mb-1w">
                            <span style="color: ${r.status === 'valid' ? '#18753C' : r.status === 'error' ? '#CE0500' : '#161616'}">
                                ${r.status === 'valid' ? '✓' : r.status === 'error' ? '✗' : '○'}
                            </span>
                            <strong>${r.label}:</strong> ${r.value || 'Non renseigné'}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Utilitaire debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
        </div>
    </main>

    <!-- Footer DSFR -->
    <footer class="fr-footer" role="contentinfo" id="fr-footer">
        <div class="fr-container">
            <div class="fr-footer__body">
                <div class="fr-footer__brand fr-enlarge-link">
                    <a href="/" title="Retour à l'accueil">
                        <p class="fr-logo">
                            République
                            <br>Française
                        </p>
                    </a>
                </div>
                <div class="fr-footer__content">
                    <p class="fr-footer__content-desc">
                        Formulaire de saisie SignalConso. Données issues de data.economie.gouv.fr
                    </p>
                    <ul class="fr-footer__content-list">
                        <li class="fr-footer__content-item">
                            <a class="fr-footer__content-link" target="_blank" href="https://data.economie.gouv.fr" rel="noopener external">data.economie.gouv.fr</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="fr-footer__bottom">
                <ul class="fr-footer__bottom-list">
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Accessibilité : conforme</a>
                    </li>
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Mentions légales</a>
                    </li>
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Données personnelles</a>
                    </li>
                </ul>
                <div class="fr-footer__bottom-copy">
                    <p>
                        Sauf mention contraire, tous les contenus de ce site sont sous
                        <a href="https://github.com/etalab/licence-ouverte/blob/master/LO.md" target="_blank" rel="noopener external">licence etalab-2.0</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>


    <script>
        // Configuration du wrapper API
        if (window.fetchCompat) {
            fetchCompat.configure({
                enableCache: true,
                enableMonitoring: true,
                debug: window.location.hostname === 'localhost'
            });
        }
    </script>
</body>
</html>