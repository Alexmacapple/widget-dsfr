<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Widget zone de téléversement DSFR pour SignalConso">
    <title>Zone de téléversement DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <style>
        body { margin: 0; font-family: Marianne, arial, sans-serif; }
        
        /* Zone de téléversement principale */
        .upload-zone {
            border: 2px dashed #000091;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            background: #f6f6f6;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-zone:hover {
            background: #e5e5fe;
            border-color: #6A6AF4;
        }
        
        .upload-zone.dragover {
            background: #e5e5fe;
            border-color: #000091;
            border-width: 3px;
            transform: scale(1.02);
        }
        
        .upload-zone.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .upload-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            color: #000091;
        }
        
        /* Liste des fichiers */
        .file-list {
            margin-top: 2rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .file-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .file-icon {
            width: 48px;
            height: 48px;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f6f6f6;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .file-icon svg {
            width: 24px;
            height: 24px;
        }
        
        .file-icon.pdf { background: #fff0f0; color: #CE0500; }
        .file-icon.image { background: #f0fff0; color: #18753C; }
        .file-icon.doc { background: #f0f0ff; color: #000091; }
        .file-icon.other { background: #fff5e6; color: #B34000; }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 600;
            color: #161616;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #666;
        }
        
        .file-size {
            display: flex;
            align-items: center;
        }
        
        .file-status {
            display: flex;
            align-items: center;
        }
        
        .file-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        /* Barre de progression */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e5e5;
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #000091;
            border-radius: 2px;
            transition: width 0.3s;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }
        
        /* Aperçu des images */
        .file-preview {
            width: 80px;
            height: 80px;
            margin-right: 1rem;
            border-radius: 8px;
            overflow: hidden;
            background: #f6f6f6;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* États des fichiers */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-uploading {
            background: #e5e5fe;
            color: #000091;
        }
        
        .status-success {
            background: #d4f4dd;
            color: #18753C;
        }
        
        .status-error {
            background: #ffe9e6;
            color: #CE0500;
        }
        
        /* Zone de téléversement multiple */
        .multi-upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .upload-tile {
            aspect-ratio: 1;
            border: 2px dashed #e5e5e5;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .upload-tile:hover {
            border-color: #000091;
            background: #f6f6f6;
        }
        
        .upload-tile.has-file {
            border-style: solid;
            cursor: default;
        }
        
        /* Statistiques */
        .upload-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #000091;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* Modal de prévisualisation */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .preview-modal.show {
            display: flex;
        }
        
        .preview-content {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .preview-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #000091;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1;
        }
        
        .preview-close:hover {
            background: #000091;
            color: white;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 80vh;
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .upload-zone {
                padding: 2rem;
            }
            
            .file-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .file-preview {
                width: 100%;
                height: 150px;
                margin-right: 0;
                margin-bottom: 1rem;
            }
            
            .file-actions {
                width: 100%;
                justify-content: space-between;
                margin-top: 1rem;
            }
        }
    </style>
    <script src="../js/wrapper-api.js"></script>
</head>
<body>

    <!-- Skip links pour l'accessibilité -->
    <div class="fr-skiplinks">
        <nav class="fr-container" role="navigation" aria-label="Accès rapide">
            <ul class="fr-skiplinks__list">
                <li><a class="fr-link" href="#content">Aller au contenu</a></li>
                <li><a class="fr-link" href="#fr-footer">Aller au pied de page</a></li>
            </ul>
        </nav>
    </div>


    <!-- Header DSFR -->
    <header role="banner" class="fr-header">
        <div class="fr-header__body">
            <div class="fr-container">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand fr-enlarge-link">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                                <p class="fr-logo">
                                    République
                                    <br>Française
                                </p>
                            </div>
                        </div>
                        <div class="fr-header__service">
                            <a href="/" title="Accueil - SignalConso">
                                <p class="fr-header__service-title">
                                    SignalConso
                                </p>
                            </a>
                            <p class="fr-header__service-tagline">Formulaire de saisie SignalConso - data.economie.gouv.fr</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <!-- Main content -->
    <main id="content" role="main">
        <div class="fr-container fr-py-6w">
            <div id="widget-form-upload-001" class="fr-container fr-py-3w">
        <h1 class="fr-h3">Zone de téléversement de documents</h1>
        <p class="fr-text--lead">Ajoutez vos pièces justificatives pour votre signalement SignalConso</p>
        
        <!-- Zone de téléversement principale -->
        <div class="fr-card">
            <div class="fr-card__body">
                <h2 class="fr-h4">Téléverser des documents</h2>
                <p class="fr-text--sm">Glissez-déposez vos fichiers ou cliquez pour parcourir</p>
                
                <div class="upload-zone" id="mainUploadZone">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p class="fr-text--lg fr-text--bold">Glissez vos fichiers ici</p>
                    <p class="fr-text--sm fr-mb-2w">ou</p>
                    <button type="button" class="fr-btn fr-btn--secondary">
                        Parcourir les fichiers
                    </button>
                    <input type="file" id="mainFileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" style="display:none">
                    <p class="fr-text--xs fr-mt-2w fr-mb-0">
                        Formats acceptés : PDF, JPG, PNG, DOC, DOCX, XLS, XLSX<br>
                        Taille max : 10 MB par fichier | 50 MB au total
                    </p>
                </div>
                
                <!-- Statistiques d'upload -->
                <div class="upload-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalFiles">0</div>
                        <div class="stat-label">Fichiers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalSize">0 MB</div>
                        <div class="stat-label">Taille totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="uploadProgress">0%</div>
                        <div class="stat-label">Progression</div>
                    </div>
                </div>
                
                <!-- Liste des fichiers -->
                <div class="file-list" id="fileList"></div>
                
                <!-- Actions globales -->
                <div class="fr-grid-row fr-grid-row--right fr-mt-3w">
                    <div class="fr-col-auto">
                        <button type="button" class="fr-btn fr-btn--secondary" id="clearAllBtn" style="display:none">
                            Tout supprimer
                        </button>
                    </div>
                    <div class="fr-col-auto">
                        <button type="button" class="fr-btn" id="uploadAllBtn" style="display:none">
                            Tout téléverser
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Zone de téléversement par catégorie -->
        <div class="fr-card fr-mt-3w">
            <div class="fr-card__body">
                <h2 class="fr-h4">Téléversement par type de document</h2>
                <p class="fr-text--sm">Organisez vos documents par catégorie</p>
                
                <div class="fr-tabs">
                    <ul class="fr-tabs__list" role="tablist" aria-label="Types de documents">
                        <li role="presentation">
                            <button class="fr-tabs__tab" id="tab-factures" tabindex="0" role="tab" aria-selected="true" aria-controls="tabpanel-factures">
                                Factures
                            </button>
                        </li>
                        <li role="presentation">
                            <button class="fr-tabs__tab" id="tab-contrats" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-contrats">
                                Contrats
                            </button>
                        </li>
                        <li role="presentation">
                            <button class="fr-tabs__tab" id="tab-courriers" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-courriers">
                                Courriers
                            </button>
                        </li>
                        <li role="presentation">
                            <button class="fr-tabs__tab" id="tab-photos" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-photos">
                                Photos
                            </button>
                        </li>
                    </ul>
                    
                    <div id="tabpanel-factures" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel" tabindex="0">
                        <div class="upload-zone" data-category="factures">
                            <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            <p class="fr-text--sm">Glissez vos factures ici</p>
                            <button type="button" class="fr-btn fr-btn--sm fr-btn--tertiary">
                                Ajouter des factures
                            </button>
                            <input type="file" class="category-input" data-category="factures" multiple accept=".pdf,.jpg,.jpeg,.png" style="display:none">
                        </div>
                        <div class="file-list" id="factures-list"></div>
                    </div>
                    
                    <div id="tabpanel-contrats" class="fr-tabs__panel" role="tabpanel" tabindex="0">
                        <div class="upload-zone" data-category="contrats">
                            <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <path d="M12 18v-6"></path>
                                <path d="M9 15l3-3 3 3"></path>
                            </svg>
                            <p class="fr-text--sm">Glissez vos contrats ici</p>
                            <button type="button" class="fr-btn fr-btn--sm fr-btn--tertiary">
                                Ajouter des contrats
                            </button>
                            <input type="file" class="category-input" data-category="contrats" multiple accept=".pdf,.doc,.docx" style="display:none">
                        </div>
                        <div class="file-list" id="contrats-list"></div>
                    </div>
                    
                    <div id="tabpanel-courriers" class="fr-tabs__panel" role="tabpanel" tabindex="0">
                        <div class="upload-zone" data-category="courriers">
                            <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                            <p class="fr-text--sm">Glissez vos courriers ici</p>
                            <button type="button" class="fr-btn fr-btn--sm fr-btn--tertiary">
                                Ajouter des courriers
                            </button>
                            <input type="file" class="category-input" data-category="courriers" multiple accept=".pdf,.jpg,.jpeg,.png" style="display:none">
                        </div>
                        <div class="file-list" id="courriers-list"></div>
                    </div>
                    
                    <div id="tabpanel-photos" class="fr-tabs__panel" role="tabpanel" tabindex="0">
                        <div class="upload-zone" data-category="photos">
                            <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <p class="fr-text--sm">Glissez vos photos ici</p>
                            <button type="button" class="fr-btn fr-btn--sm fr-btn--tertiary">
                                Ajouter des photos
                            </button>
                            <input type="file" class="category-input" data-category="photos" multiple accept=".jpg,.jpeg,.png,.gif,.webp" style="display:none">
                        </div>
                        <div class="file-list" id="photos-list"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alertes et messages -->
        <div id="alerts"></div>
        
        <!-- Modal de prévisualisation -->
        <div class="preview-modal" id="previewModal">
            <div class="preview-content">
                <button class="preview-close" onclick="closePreview()">×</button>
                <img class="preview-image" id="previewImage" alt="Aperçu du document">
            </div>
        </div>
    </div>
    <!-- FIN ZONE WIDGET FORM-UPLOAD-001 -->
    
    <script>
        // État global
        const uploadState = {
            files: new Map(),
            totalSize: 0,
            maxFileSize: 10 * 1024 * 1024, // 10 MB
            maxTotalSize: 50 * 1024 * 1024, // 50 MB
            allowedTypes: {
                'application/pdf': 'pdf',
                'image/jpeg': 'image',
                'image/jpg': 'image',
                'image/png': 'image',
                'image/gif': 'image',
                'image/webp': 'image',
                'application/msword': 'doc',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'doc',
                'application/vnd.ms-excel': 'doc',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'doc'
            }
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            setupMainUploadZone();
            setupCategoryUploadZones();
            setupTabs();
            updateStats();
        });
        
        // Configuration de la zone principale
        function setupMainUploadZone() {
            const zone = document.getElementById('mainUploadZone');
            const input = document.getElementById('mainFileInput');
            const button = zone.querySelector('button');
            
            // Click pour ouvrir le sélecteur
            button.addEventListener('click', () => input.click());
            zone.addEventListener('click', (e) => {
                if (e.target === zone || e.target.parentElement === zone) {
                    input.click();
                }
            });
            
            // Sélection de fichiers
            input.addEventListener('change', (e) => {
                handleFiles(Array.from(e.target.files));
                input.value = '';
            });
            
            // Drag and drop
            setupDragAndDrop(zone, (files) => handleFiles(files));
            
            // Boutons d'action
            document.getElementById('clearAllBtn').addEventListener('click', clearAllFiles);
            document.getElementById('uploadAllBtn').addEventListener('click', uploadAllFiles);
        }
        
        // Configuration des zones par catégorie
        function setupCategoryUploadZones() {
            document.querySelectorAll('.upload-zone[data-category]').forEach(zone => {
                const category = zone.dataset.category;
                const input = zone.parentElement.querySelector('.category-input');
                const button = zone.querySelector('button');
                
                button.addEventListener('click', () => input.click());
                
                input.addEventListener('change', (e) => {
                    handleFiles(Array.from(e.target.files), category);
                    input.value = '';
                });
                
                setupDragAndDrop(zone, (files) => handleFiles(files, category));
            });
        }
        
        // Configuration des onglets
        function setupTabs() {
            const tabs = document.querySelectorAll('.fr-tabs__tab');
            const panels = document.querySelectorAll('.fr-tabs__panel');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Désactiver tous les onglets
                    tabs.forEach(t => {
                        t.setAttribute('aria-selected', 'false');
                        t.setAttribute('tabindex', '-1');
                    });
                    panels.forEach(p => p.classList.remove('fr-tabs__panel--selected'));
                    
                    // Activer l'onglet cliqué
                    tab.setAttribute('aria-selected', 'true');
                    tab.setAttribute('tabindex', '0');
                    const panel = document.getElementById(tab.getAttribute('aria-controls'));
                    panel.classList.add('fr-tabs__panel--selected');
                });
            });
        }
        
        // Drag and drop
        function setupDragAndDrop(zone, callback) {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                callback(files);
            });
        }
        
        // Gestion des fichiers
        function handleFiles(files, category = null) {
            files.forEach(file => {
                if (validateFile(file)) {
                    addFile(file, category);
                }
            });
            
            updateStats();
            updateButtons();
        }
        
        // Validation des fichiers
        function validateFile(file) {
            // Vérifier le type
            if (!uploadState.allowedTypes[file.type]) {
                showAlert(`Le fichier "${file.name}" n'est pas dans un format accepté`, 'error');
                return false;
            }
            
            // Vérifier la taille
            if (file.size > uploadState.maxFileSize) {
                showAlert(`Le fichier "${file.name}" dépasse la taille maximale de 10 MB`, 'error');
                return false;
            }
            
            // Vérifier la taille totale
            if (uploadState.totalSize + file.size > uploadState.maxTotalSize) {
                showAlert('La taille totale des fichiers dépasse 50 MB', 'error');
                return false;
            }
            
            // Vérifier les doublons
            if (uploadState.files.has(file.name)) {
                showAlert(`Le fichier "${file.name}" est déjà dans la liste`, 'warning');
                return false;
            }
            
            return true;
        }
        
        // Ajouter un fichier
        function addFile(file, category = null) {
            const fileId = generateId();
            const fileData = {
                id: fileId,
                file: file,
                name: file.name,
                size: file.size,
                type: uploadState.allowedTypes[file.type],
                category: category,
                status: 'pending',
                progress: 0,
                preview: null
            };
            
            uploadState.files.set(file.name, fileData);
            uploadState.totalSize += file.size;
            
            // Créer l'aperçu pour les images
            if (fileData.type === 'image') {
                createImagePreview(fileData);
            }
            
            // Ajouter à la liste
            const listId = category ? `${category}-list` : 'fileList';
            const listElement = document.getElementById(listId);
            if (listElement) {
                listElement.appendChild(createFileElement(fileData));
            }
        }
        
        // Créer l'élément de fichier
        function createFileElement(fileData) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.id = `file-${fileData.id}`;
            
            // Icône ou aperçu
            if (fileData.preview) {
                div.innerHTML = `
                    <div class="file-preview" onclick="showPreview('${fileData.name}')">
                        <img src="${fileData.preview}" alt="${fileData.name}">
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="file-icon ${fileData.type}">
                        ${getFileIcon(fileData.type)}
                    </div>
                `;
            }
            
            // Informations du fichier
            div.innerHTML += `
                <div class="file-info">
                    <div class="file-name" title="${fileData.name}">${fileData.name}</div>
                    <div class="file-meta">
                        <span class="file-size">${formatFileSize(fileData.size)}</span>
                        <span class="file-status">
                            <span class="status-badge status-${fileData.status}" id="status-${fileData.id}">
                                ${getStatusText(fileData.status)}
                            </span>
                        </span>
                    </div>
                    <div class="progress-bar" id="progress-${fileData.id}" style="display:none">
                        <div class="progress-fill" style="width:0%"></div>
                    </div>
                </div>
                <div class="file-actions">
                    ${fileData.status === 'pending' ? `
                        <button class="fr-btn fr-btn--tertiary-no-outline fr-btn--sm" onclick="uploadFile('${fileData.name}')">
                            Téléverser
                        </button>
                    ` : ''}
                    <button class="fr-btn fr-btn--tertiary-no-outline fr-btn--sm" onclick="removeFile('${fileData.name}')">
                        Supprimer
                    </button>
                </div>
            `;
            
            return div;
        }
        
        // Créer un aperçu d'image
        function createImagePreview(fileData) {
            const reader = new FileReader();
            reader.onload = (e) => {
                fileData.preview = e.target.result;
                const element = document.getElementById(`file-${fileData.id}`);
                if (element) {
                    const icon = element.querySelector('.file-icon');
                    if (icon) {
                        const preview = document.createElement('div');
                        preview.className = 'file-preview';
                        preview.onclick = () => showPreview(fileData.name);
                        preview.innerHTML = `<img src="${fileData.preview}" alt="${fileData.name}">`;
                        icon.replaceWith(preview);
                    }
                }
            };
            reader.readAsDataURL(fileData.file);
        }
        
        // Afficher l'aperçu
        function showPreview(fileName) {
            const fileData = uploadState.files.get(fileName);
            if (fileData && fileData.preview) {
                document.getElementById('previewImage').src = fileData.preview;
                document.getElementById('previewModal').classList.add('show');
            }
        }
        
        // Fermer l'aperçu
        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
        }
        
        // Upload d'un fichier
        async function uploadFile(fileName) {
            const fileData = uploadState.files.get(fileName);
            if (!fileData) return;
            
            fileData.status = 'uploading';
            updateFileStatus(fileData);
            
            const formData = new FormData();
            formData.append('file', fileData.file);
            formData.append('category', fileData.category || 'general');
            
            // Afficher la barre de progression
            const progressBar = document.getElementById(`progress-${fileData.id}`);
            const progressFill = progressBar.querySelector('.progress-fill');
            progressBar.style.display = 'block';
            
            try {
                // Simulation d'upload avec progression
                await simulateUpload(fileData, progressFill);
                
                // En production, utiliser l'API SignalConso
                // const response = await fetchCompat('https://api.signalconso.gouv.fr/upload', {
                //     method: 'POST',
                //     body: formData
                // });
                
                fileData.status = 'success';
                showAlert(`Fichier "${fileData.name}" téléversé avec succès`, 'success');
                
            } catch (error) {
                fileData.status = 'error';
                showAlert(`Erreur lors du téléversement de "${fileData.name}"`, 'error');
                console.error('Erreur upload:', error);
            }
            
            progressBar.style.display = 'none';
            updateFileStatus(fileData);
            updateStats();
        }
        
        // Simulation d'upload avec progression
        function simulateUpload(fileData, progressFill) {
            return new Promise((resolve) => {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        resolve();
                    }
                    fileData.progress = progress;
                    progressFill.style.width = progress + '%';
                    updateStats();
                }, 200);
            });
        }
        
        // Upload de tous les fichiers
        async function uploadAllFiles() {
            const pendingFiles = Array.from(uploadState.files.values())
                .filter(f => f.status === 'pending');
            
            for (const fileData of pendingFiles) {
                await uploadFile(fileData.name);
            }
        }
        
        // Supprimer un fichier
        function removeFile(fileName) {
            const fileData = uploadState.files.get(fileName);
            if (!fileData) return;
            
            const element = document.getElementById(`file-${fileData.id}`);
            if (element) {
                element.remove();
            }
            
            uploadState.totalSize -= fileData.size;
            uploadState.files.delete(fileName);
            
            updateStats();
            updateButtons();
        }
        
        // Supprimer tous les fichiers
        function clearAllFiles() {
            if (!confirm('Voulez-vous vraiment supprimer tous les fichiers ?')) {
                return;
            }
            
            uploadState.files.clear();
            uploadState.totalSize = 0;
            
            document.querySelectorAll('.file-list').forEach(list => {
                list.innerHTML = '';
            });
            
            updateStats();
            updateButtons();
        }
        
        // Mise à jour du statut d'un fichier
        function updateFileStatus(fileData) {
            const statusElement = document.getElementById(`status-${fileData.id}`);
            if (statusElement) {
                statusElement.className = `status-badge status-${fileData.status}`;
                statusElement.textContent = getStatusText(fileData.status);
            }
            
            // Mettre à jour les boutons
            const element = document.getElementById(`file-${fileData.id}`);
            if (element) {
                const actions = element.querySelector('.file-actions');
                if (fileData.status !== 'pending') {
                    const uploadBtn = actions.querySelector('button:first-child');
                    if (uploadBtn && uploadBtn.textContent.includes('Téléverser')) {
                        uploadBtn.remove();
                    }
                }
            }
        }
        
        // Mise à jour des statistiques
        function updateStats() {
            const files = Array.from(uploadState.files.values());
            const uploaded = files.filter(f => f.status === 'success').length;
            const totalProgress = files.length > 0 
                ? Math.round((uploaded / files.length) * 100)
                : 0;
            
            document.getElementById('totalFiles').textContent = files.length;
            document.getElementById('totalSize').textContent = formatFileSize(uploadState.totalSize);
            document.getElementById('uploadProgress').textContent = totalProgress + '%';
        }
        
        // Mise à jour des boutons
        function updateButtons() {
            const hasFiles = uploadState.files.size > 0;
            const hasPending = Array.from(uploadState.files.values()).some(f => f.status === 'pending');
            
            document.getElementById('clearAllBtn').style.display = hasFiles ? 'block' : 'none';
            document.getElementById('uploadAllBtn').style.display = hasPending ? 'block' : 'none';
        }
        
        // Utilitaires
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function getFileIcon(type) {
            const icons = {
                pdf: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18.5,9H13V3.5L18.5,9M6,20V4H11V10H18V20H6Z"/></svg>',
                image: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21,3H3C2,3 1,4 1,5V19A2,2 0 0,0 3,21H21C22,21 23,20 23,19V5C23,4 22,3 21,3M5,17L8.5,12.5L11,15.5L14.5,11L19,17H5Z"/></svg>',
                doc: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>',
                other: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2Z"/></svg>'
            };
            return icons[type] || icons.other;
        }
        
        function getStatusText(status) {
            const texts = {
                pending: 'En attente',
                uploading: 'Téléversement...',
                success: 'Téléversé',
                error: 'Erreur'
            };
            return texts[status] || status;
        }
        
        // Affichage des alertes
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `fr-alert fr-alert--${type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success'} fr-mb-2w`;
            alert.innerHTML = `
                <p class="fr-alert__title">${type === 'error' ? 'Erreur' : type === 'warning' ? 'Attention' : 'Succès'}</p>
                <p>${message}</p>
            `;
            
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Connexion à l'API SignalConso (exemple)
        async function connectToSignalConso() {
            try {
                const response = await fetchCompat('https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=1');
                const data = await response.json();
                console.log('Connexion SignalConso OK:', data.nhits, 'enregistrements');
            } catch (error) {
                console.error('Erreur connexion SignalConso:', error);
            }
        }
        
        // Test de connexion au chargement
        connectToSignalConso();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
        </div>
    </main>

    <!-- Footer DSFR -->
    <footer class="fr-footer" role="contentinfo" id="fr-footer">
        <div class="fr-container">
            <div class="fr-footer__body">
                <div class="fr-footer__brand fr-enlarge-link">
                    <a href="/" title="Retour à l'accueil">
                        <p class="fr-logo">
                            République
                            <br>Française
                        </p>
                    </a>
                </div>
                <div class="fr-footer__content">
                    <p class="fr-footer__content-desc">
                        Formulaire de saisie SignalConso. Données issues de data.economie.gouv.fr
                    </p>
                    <ul class="fr-footer__content-list">
                        <li class="fr-footer__content-item">
                            <a class="fr-footer__content-link" target="_blank" href="https://data.economie.gouv.fr" rel="noopener external">data.economie.gouv.fr</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="fr-footer__bottom">
                <ul class="fr-footer__bottom-list">
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Accessibilité : conforme</a>
                    </li>
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Mentions légales</a>
                    </li>
                    <li class="fr-footer__bottom-item">
                        <a class="fr-footer__bottom-link" href="#">Données personnelles</a>
                    </li>
                </ul>
                <div class="fr-footer__bottom-copy">
                    <p>
                        Sauf mention contraire, tous les contenus de ce site sont sous
                        <a href="https://github.com/etalab/licence-ouverte/blob/master/LO.md" target="_blank" rel="noopener external">licence etalab-2.0</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>


    <script>
        // Configuration du wrapper API
        if (window.fetchCompat) {
            fetchCompat.configure({
                enableCache: true,
                enableMonitoring: true,
                debug: window.location.hostname === 'localhost'
            });
        }
    </script>
</body>
</html>