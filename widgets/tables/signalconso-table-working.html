<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Table SignalConso DSFR - Données réelles">
    <title>Table SignalConso - Version Fonctionnelle</title>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
    
    <!-- ODS Widgets CSS -->
    <link rel="stylesheet" href="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.css">
    
    <style>
        .table-container {
            overflow-x: auto;
            margin: 2rem 0;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.875rem;
            font-weight: bold;
            display: inline-block;
        }
        .status-badge.na { background: #e5e5e5; color: #666; }
        .status-badge.nonconsulte { background: #ffe9e6; color: #ce0500; }
        .status-badge.promesseaction { background: #d4f4dd; color: #18753c; }
        .status-badge.infonde { background: #fff4e6; color: #b34000; }
        .export-controls {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body ng-app="ods-widgets">
    <!-- DÉBUT ZONE WIDGET SIGNALCONSO-TABLE-WORKING -->
    <div id="widget-signalconso-table-working" class="fr-container fr-py-3w">
        
        <h1 class="fr-h3">Signalements consommateurs</h1>
        <p class="fr-text--sm">Données en temps réel depuis data.economie.gouv.fr</p>
        
        <!-- Contexte ODS avec les bons paramètres -->
        <ods-dataset-context 
            context="signalconso"
            signalconso-domain="data.economie.gouv.fr"
            signalconso-dataset="signalconso"
            signalconso-parameters="{'rows': 20, 'sort': 'creationdate'}">
            
            <!-- Statistiques -->
            <div class="fr-callout fr-my-3w">
                <h3 class="fr-callout__title">Statistiques</h3>
                <p class="fr-callout__text">
                    Total des signalements : <strong>{{ signalconso.nhits | number }}</strong>
                </p>
            </div>
            
            <!-- Filtres -->
            <div class="fr-grid-row fr-grid-row--gutters fr-mb-3w">
                <div class="fr-col-12 fr-col-md-4">
                    <div class="fr-select-group">
                        <label class="fr-label" for="filter-category">Catégorie</label>
                        <select class="fr-select" id="filter-category"
                                ng-model="filterCategory"
                                ng-change="signalconso.parameters['refine.category'] = filterCategory">
                            <option value="">Toutes les catégories</option>
                            <option value="AchatInternet">Achat Internet</option>
                            <option value="AchatMagasinInternet">Achat Magasin/Internet</option>
                            <option value="TelephonieFaiMedias">Téléphonie/FAI/Médias</option>
                            <option value="TravauxRenovations">Travaux/Rénovations</option>
                            <option value="EauGazElectricite">Eau/Gaz/Électricité</option>
                            <option value="IntoxicationAlimentaire">Intoxication Alimentaire</option>
                        </select>
                    </div>
                </div>
                
                <div class="fr-col-12 fr-col-md-4">
                    <div class="fr-select-group">
                        <label class="fr-label" for="filter-status">Statut</label>
                        <select class="fr-select" id="filter-status"
                                ng-model="filterStatus"
                                ng-change="signalconso.parameters['refine.status'] = filterStatus">
                            <option value="">Tous les statuts</option>
                            <option value="NA">Non applicable</option>
                            <option value="NonConsulte">Non consulté</option>
                            <option value="PromesseAction">Promesse d'action</option>
                            <option value="Infonde">Infondé</option>
                        </select>
                    </div>
                </div>
                
                <div class="fr-col-12 fr-col-md-4">
                    <div class="fr-select-group">
                        <label class="fr-label" for="filter-region">Région</label>
                        <select class="fr-select" id="filter-region"
                                ng-model="filterRegion"
                                ng-change="signalconso.parameters['refine.reg_name'] = filterRegion">
                            <option value="">Toutes les régions</option>
                            <option value="Île-de-France">Île-de-France</option>
                            <option value="Provence-Alpes-Côte d'Azur">Provence-Alpes-Côte d'Azur</option>
                            <option value="Auvergne-Rhône-Alpes">Auvergne-Rhône-Alpes</option>
                            <option value="Nouvelle-Aquitaine">Nouvelle-Aquitaine</option>
                            <option value="Occitanie">Occitanie</option>
                            <option value="Grand Est">Grand Est</option>
                            <option value="Hauts-de-France">Hauts-de-France</option>
                            <option value="Normandie">Normandie</option>
                            <option value="Bretagne">Bretagne</option>
                            <option value="Pays de la Loire">Pays de la Loire</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Boutons d'export -->
            <div class="export-controls">
                <a class="fr-btn fr-btn--secondary fr-btn--sm"
                   href="https://data.economie.gouv.fr/api/records/1.0/download/?dataset=signalconso&format=csv"
                   download="signalconso.csv">
                    Exporter CSV
                </a>
                <a class="fr-btn fr-btn--secondary fr-btn--sm"
                   href="https://data.economie.gouv.fr/api/records/1.0/download/?dataset=signalconso&format=xls"
                   download="signalconso.xls">
                    Exporter Excel
                </a>
                <button class="fr-btn fr-btn--secondary fr-btn--sm" onclick="window.print()">
                    Imprimer
                </button>
            </div>
            
            <!-- Table des données -->
            <div class="table-container">
                <table class="fr-table fr-table--bordered">
                    <thead>
                        <tr>
                            <th scope="col">Date création</th>
                            <th scope="col">Catégorie</th>
                            <th scope="col">Département</th>
                            <th scope="col">Région</th>
                            <th scope="col">Statut</th>
                            <th scope="col">Tags</th>
                            <th scope="col">Transmis</th>
                            <th scope="col">Lu</th>
                            <th scope="col">Réponse</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="record in signalconso.records">
                            <td>{{ record.fields.creationdate | date:'dd/MM/yyyy' }}</td>
                            <td>
                                <span class="fr-badge fr-badge--sm">
                                    {{ record.fields.category }}
                                </span>
                            </td>
                            <td>{{ record.fields.dep_name }} ({{ record.fields.dep_code }})</td>
                            <td>{{ record.fields.reg_name }}</td>
                            <td>
                                <span class="status-badge" 
                                      ng-class="{'na': record.fields.status == 'NA',
                                                 'nonconsulte': record.fields.status == 'NonConsulte',
                                                 'promesseaction': record.fields.status == 'PromesseAction',
                                                 'infonde': record.fields.status == 'Infonde'}">
                                    {{ record.fields.status }}
                                </span>
                            </td>
                            <td>
                                <span ng-if="record.fields.tags">
                                    {{ record.fields.tags }}
                                </span>
                                <span ng-if="!record.fields.tags" class="fr-text--sm">-</span>
                            </td>
                            <td>
                                <span ng-if="record.fields.signalement_transmis == 1" style="color: green;">✓</span>
                                <span ng-if="record.fields.signalement_transmis == 0" style="color: red;">✗</span>
                            </td>
                            <td>
                                <span ng-if="record.fields.signalement_lu == 1" style="color: green;">✓</span>
                                <span ng-if="record.fields.signalement_lu == 0" style="color: red;">✗</span>
                            </td>
                            <td>
                                <span ng-if="record.fields.signalement_reponse == 1" style="color: green;">✓</span>
                                <span ng-if="record.fields.signalement_reponse == 0" style="color: red;">✗</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Message si pas de données -->
            <div ng-if="!signalconso.records || signalconso.records.length === 0" 
                 class="fr-alert fr-alert--info">
                <p>Chargement des données en cours...</p>
            </div>
            
            <!-- Pagination -->
            <nav class="fr-pagination" aria-label="Pagination" ng-if="signalconso.nhits > 20">
                <ul class="fr-pagination__list">
                    <li>
                        <button class="fr-pagination__link fr-pagination__link--prev"
                                ng-click="signalconso.parameters['start'] = (signalconso.parameters['start'] || 0) - 20"
                                ng-disabled="!signalconso.parameters['start'] || signalconso.parameters['start'] <= 0">
                            Page précédente
                        </button>
                    </li>
                    <li>
                        <span class="fr-pagination__link" aria-current="page">
                            Page {{ ((signalconso.parameters['start'] || 0) / 20) + 1 | number:0 }} / 
                            {{ (signalconso.nhits / 20) | number:0 }}
                        </span>
                    </li>
                    <li>
                        <button class="fr-pagination__link fr-pagination__link--next"
                                ng-click="signalconso.parameters['start'] = (signalconso.parameters['start'] || 0) + 20"
                                ng-disabled="(signalconso.parameters['start'] || 0) + 20 >= signalconso.nhits">
                            Page suivante
                        </button>
                    </li>
                </ul>
            </nav>
            
        </ods-dataset-context>
    </div>
    <!-- FIN ZONE WIDGET SIGNALCONSO-TABLE-WORKING -->
    
    <!-- Scripts Angular et ODS Widgets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-sanitize/1.8.3/angular-sanitize.min.js"></script>
    <script src="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.js"></script>
    
    <!-- Script DSFR -->
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js"></script>
    
    <!-- Script de debug -->
    <script>
        // Debug Angular et ODS
        angular.module('ods-widgets').run(['$rootScope', '$timeout', function($rootScope, $timeout) {
            console.log('=== DEBUG ODS WIDGETS ===');
            console.log('Angular version:', angular.version.full);
            
            // Écouter les événements ODS
            $rootScope.$on('ods-widgets.context.error', function(event, error) {
                console.error('❌ ODS Context Error:', error);
            });
            
            $rootScope.$on('ods-widgets.context.ready', function(event, context) {
                console.log('✅ ODS Context Ready:', context);
            });
            
            $rootScope.$on('ods-widgets.context.updated', function(event, context) {
                console.log('📊 ODS Context Updated:', context);
            });
            
            // Vérifier le contexte après chargement
            $timeout(function() {
                const scope = angular.element(document.querySelector('[ng-controller]')).scope();
                if (scope) {
                    console.log('🔍 Scope found:', scope);
                    if (scope.signalconso) {
                        console.log('📌 SignalConso context:', {
                            domain: scope.signalconso.domain,
                            dataset: scope.signalconso.dataset,
                            nhits: scope.signalconso.nhits,
                            records: scope.signalconso.records,
                            parameters: scope.signalconso.parameters,
                            error: scope.signalconso.error
                        });
                    } else {
                        console.error('❌ SignalConso context not found in scope');
                    }
                }
            }, 2000);
            
            // Test API direct
            console.log('🔗 Testing direct API call...');
            fetch('https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=1')
                .then(r => r.json())
                .then(data => {
                    console.log('✅ Direct API Response:', data);
                })
                .catch(err => {
                    console.error('❌ Direct API Error:', err);
                });
        }]);
        
        // Intercepter les erreurs réseau
        window.addEventListener('error', function(e) {
            console.error('Window Error:', e);
        });
        
        // Log des requêtes XHR
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url) {
            console.log('📡 XHR Request:', method, url);
            this.addEventListener('load', function() {
                if (url.includes('data.economie.gouv.fr')) {
                    console.log('📥 XHR Response from data.economie.gouv.fr:', this.status, this.responseText?.substring(0, 200));
                }
            });
            this.addEventListener('error', function() {
                console.error('❌ XHR Error for:', url);
            });
            return originalOpen.apply(this, arguments);
        };
    </script>
</body>
</html>