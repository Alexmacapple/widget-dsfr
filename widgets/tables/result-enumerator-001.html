<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Result Enumerator DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
    <style>
        body { overflow-x: hidden; }
        .card-grid { margin: 2rem 0; }
        .status-badge { padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.875rem; }
        .status-NA { background: #e5e5e5; color: #666; }
        .status-NonConsulte { background: #ffe9e6; color: #ce0500; }
        .status-PromesseAction { background: #d4f4dd; color: #18753c; }
        .status-Infonde { background: #fff4e6; color: #b34000; }
        
        /* Styles pour la modal DSFR */
        dialog#modal-details {
            padding: 0;
            border: none;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 48rem;
            max-height: 90vh;
            background: transparent;
        }
        
        dialog#modal-details::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        dialog#modal-details[open] {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fr-modal__body {
            background: white;
            border-radius: 0.5rem;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 1.5rem rgba(0, 0, 0, 0.3);
        }
        
        .fr-modal__header {
            position: relative;
            padding: 0;
            margin: 0;
            height: 3rem;
        }
        
        .fr-modal__content {
            padding: 1rem 2rem 2rem 2rem;
        }
        
        /* Bouton fermeture conforme DSFR */
        .fr-btn--close {
            position: absolute;
            top: 0;
            right: 0;
            width: 3rem;
            height: 3rem;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-action-high-grey, #161616);
            transition: all 0.3s;
            border-radius: 0 0.5rem 0 0;
        }
        
        .fr-btn--close:hover {
            background-color: var(--background-contrast-grey, #e5e5e5);
            color: var(--text-action-high-blue-france, #000091);
        }
        
        .fr-btn--close:active {
            background-color: var(--background-contrast-grey-active, #d2d2d2);
        }
        
        .fr-btn--close::before,
        .fr-btn--close::after {
            content: '';
            position: absolute;
            width: 1.25rem;
            height: 2px;
            background-color: currentColor;
            transition: transform 0.3s;
        }
        
        .fr-btn--close::before {
            transform: rotate(45deg);
        }
        
        .fr-btn--close::after {
            transform: rotate(-45deg);
        }
        
        .fr-btn--close:hover::before {
            transform: rotate(45deg) scale(1.1);
        }
        
        .fr-btn--close:hover::after {
            transform: rotate(-45deg) scale(1.1);
        }
        
        /* Texte accessible pour les lecteurs d'écran */
        .fr-sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        dl.fr-list dt {
            font-weight: 700;
            margin-top: 1rem;
            color: #161616;
        }
        dl.fr-list dd {
            margin-left: 0;
            margin-bottom: 0.5rem;
            color: #3a3a3a;
        }
    </style>
</head>
<body>
    <!-- DÉBUT ZONE WIDGET RESULT-ENUMERATOR-001 -->
    <div id="widget-result-enumerator-001" class="fr-container fr-py-3w">
        <h1 class="fr-h3">Liste de résultats paginée</h1>
        <p class="fr-text--sm">Affichage en cartes avec pagination</p>
        
        <div class="fr-mb-3w">
            <span class="fr-badge fr-badge--info">
                <span id="total-count">0</span> résultats
            </span>
            • Page <span id="current-page">1</span> / <span id="total-pages">1</span>
        </div>
        
        <div id="cards-container" class="fr-grid-row fr-grid-row--gutters card-grid">
            <!-- Les cartes seront générées ici -->
        </div>
        
        <nav role="navigation" class="fr-pagination fr-mt-3w" aria-label="Pagination" id="pagination">
            <ul class="fr-pagination__list" id="pagination-list">
                <!-- La pagination sera générée dynamiquement -->
            </ul>
        </nav>
    </div>
    <!-- FIN ZONE WIDGET RESULT-ENUMERATOR-001 -->
    
    <!-- Modal DSFR pour les détails -->
    <dialog id="modal-details" aria-labelledby="modal-details-title">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-10 fr-col-lg-8">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-btn--close fr-btn" 
                                    type="button"
                                    title="Fermer la fenêtre modale" 
                                    aria-label="Fermer la fenêtre modale"
                                    aria-controls="modal-details"
                                    onclick="closeDetailsModal()">
                                <span class="fr-sr-only">Fermer</span>
                            </button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="modal-details-title" class="fr-modal__title">
                                Détails du signalement
                            </h1>
                            <div id="modal-details-content">
                                <!-- Le contenu sera injecté ici -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js"></script>
    <script>
        let allData = [];
        let currentPage = 0;
        const itemsPerPage = 10;
        
        async function loadData() {
            try {
                console.log('Chargement des données...');
                const response = await fetch('https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=100&sort=-creationdate');
                const data = await response.json();
                
                allData = data.records || [];
                document.getElementById('total-count').textContent = data.nhits.toLocaleString('fr-FR');
                
                console.log(`${allData.length} enregistrements chargés`);
                displayCards();
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('cards-container').innerHTML = 
                    '<div class="fr-alert fr-alert--error"><p>Erreur de chargement des données</p></div>';
            }
        }
        
        function displayCards() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            if (allData.length === 0) {
                container.innerHTML = '<div class="fr-alert fr-alert--info"><p>Aucun résultat trouvé</p></div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            const start = currentPage * itemsPerPage;
            const end = Math.min(start + itemsPerPage, allData.length);
            const displayedData = allData.slice(start, end);
            
            displayedData.forEach(record => {
                const fields = record.fields || {};
                const cardCol = document.createElement('div');
                cardCol.className = 'fr-col-12 fr-col-md-6';
                
                const statusClass = `status-${fields.status}`;
                const truncatedSubcategories = fields.subcategories ? 
                    (fields.subcategories.length > 150 ? fields.subcategories.substring(0, 150) + '...' : fields.subcategories) 
                    : 'Aucune description';
                
                cardCol.innerHTML = `
                    <div class="fr-card fr-card--horizontal">
                        <div class="fr-card__body">
                            <div class="fr-card__content">
                                <h3 class="fr-card__title">
                                    <span class="fr-badge">${fields.category || 'Catégorie inconnue'}</span>
                                </h3>
                                <p class="fr-card__desc">
                                    ${truncatedSubcategories}
                                </p>
                                <div class="fr-card__start">
                                    <p class="fr-card__detail">
                                        <span class="fr-icon-map-pin-2-line" aria-hidden="true"></span>
                                        ${fields.dep_name || 'Département inconnu'} (${fields.dep_code || '??'})
                                    </p>
                                    <p class="fr-card__detail">
                                        <span class="fr-icon-calendar-line" aria-hidden="true"></span>
                                        ${fields.creationdate ? new Date(fields.creationdate).toLocaleDateString('fr-FR') : 'Date inconnue'}
                                    </p>
                                    <p class="fr-card__detail">
                                        <span class="status-badge ${statusClass}">${fields.status || 'NA'}</span>
                                    </p>
                                </div>
                            </div>
                            <div class="fr-card__footer">
                                <ul class="fr-btns-group fr-btns-group--inline-reverse fr-btns-group--inline-lg">
                                    <li>
                                        <button class="fr-btn fr-btn--secondary btn-details" 
                                                data-recordid="${record.recordid}"
                                                title="Voir les détails du signalement" 
                                                aria-label="Voir les détails">
                                            Voir détails
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(cardCol);
            });
            
            updatePagination();
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            document.getElementById('current-page').textContent = currentPage + 1;
            document.getElementById('total-pages').textContent = totalPages;
            
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            document.getElementById('pagination').style.display = 'block';
            
            const paginationList = document.getElementById('pagination-list');
            paginationList.innerHTML = '';
            
            // Première page
            const firstLi = document.createElement('li');
            firstLi.innerHTML = `
                <a class="fr-pagination__link fr-pagination__link--first ${currentPage === 0 ? 'fr-pagination__link--first-disabled' : ''}" 
                   ${currentPage === 0 ? 'aria-disabled="true"' : ''}
                   href="#" 
                   title="Aller à la première page"
                   aria-label="Aller à la première page"
                   onclick="return goToPage(0);">
                    Première page
                </a>
            `;
            paginationList.appendChild(firstLi);
            
            // Page précédente
            const prevLi = document.createElement('li');
            const prevPageNum = currentPage > 0 ? currentPage : 1;
            prevLi.innerHTML = `
                <a class="fr-pagination__link fr-pagination__link--prev ${currentPage === 0 ? 'fr-pagination__link--prev-disabled' : ''}" 
                   ${currentPage === 0 ? 'aria-disabled="true"' : ''}
                   href="#" 
                   title="Aller à la page ${prevPageNum}"
                   aria-label="Aller à la page précédente (page ${prevPageNum})"
                   onclick="return previousPage();">
                    Page précédente
                </a>
            `;
            paginationList.appendChild(prevLi);
            
            // Numéros de pages
            const maxPages = 5;
            const startPage = Math.max(0, currentPage - Math.floor(maxPages / 2));
            const endPage = Math.min(totalPages, startPage + maxPages);
            
            if (startPage > 0) {
                const li = document.createElement('li');
                li.innerHTML = `<span aria-hidden="true">...</span>`;
                paginationList.appendChild(li);
            }
            
            for (let i = startPage; i < endPage; i++) {
                const li = document.createElement('li');
                const pageNum = i + 1;
                
                if (i === currentPage) {
                    li.innerHTML = `
                        <a class="fr-pagination__link" 
                           aria-current="page" 
                           title="Page courante, page ${pageNum}"
                           aria-label="Page ${pageNum} - Page courante">
                            ${pageNum}
                        </a>
                    `;
                } else {
                    li.innerHTML = `
                        <a class="fr-pagination__link" 
                           href="#" 
                           title="Aller à la page ${pageNum}"
                           aria-label="Aller à la page ${pageNum}"
                           onclick="return goToPage(${i});">
                            ${pageNum}
                        </a>
                    `;
                }
                paginationList.appendChild(li);
            }
            
            if (endPage < totalPages) {
                const li = document.createElement('li');
                li.innerHTML = `<span aria-hidden="true">...</span>`;
                paginationList.appendChild(li);
            }
            
            // Page suivante
            const nextLi = document.createElement('li');
            const nextPageNum = currentPage < totalPages - 1 ? currentPage + 2 : totalPages;
            nextLi.innerHTML = `
                <a class="fr-pagination__link fr-pagination__link--next ${currentPage >= totalPages - 1 ? 'fr-pagination__link--next-disabled' : ''}" 
                   ${currentPage >= totalPages - 1 ? 'aria-disabled="true"' : ''}
                   href="#" 
                   title="Aller à la page ${nextPageNum}"
                   aria-label="Aller à la page suivante (page ${nextPageNum})"
                   onclick="return nextPage();">
                    Page suivante
                </a>
            `;
            paginationList.appendChild(nextLi);
            
            // Dernière page
            const lastLi = document.createElement('li');
            lastLi.innerHTML = `
                <a class="fr-pagination__link fr-pagination__link--last ${currentPage >= totalPages - 1 ? 'fr-pagination__link--last-disabled' : ''}" 
                   ${currentPage >= totalPages - 1 ? 'aria-disabled="true"' : ''}
                   href="#" 
                   title="Aller à la dernière page (page ${totalPages})"
                   aria-label="Aller à la dernière page (page ${totalPages})"
                   onclick="return goToLastPage();">
                    Dernière page
                </a>
            `;
            paginationList.appendChild(lastLi);
        }
        
        function goToPage(page) {
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            currentPage = Math.max(0, Math.min(page, totalPages - 1));
            displayCards();
            window.scrollTo(0, 0);
            return false;
        }
        
        function previousPage() {
            if (currentPage > 0) {
                goToPage(currentPage - 1);
            }
            return false;
        }
        
        function nextPage() {
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            if (currentPage < totalPages - 1) {
                goToPage(currentPage + 1);
            }
            return false;
        }
        
        function goToLastPage() {
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            goToPage(totalPages - 1);
            return false;
        }
        
        // Rendre les fonctions de pagination accessibles globalement
        window.goToPage = goToPage;
        window.previousPage = previousPage;
        window.nextPage = nextPage;
        window.goToLastPage = goToLastPage;
        
        function openDetailsModal(recordId) {
            const record = allData.find(r => r.recordid === recordId);
            if (record) {
                const fields = record.fields;
                const content = document.getElementById('modal-details-content');
                content.innerHTML = `
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12">
                            <dl class="fr-list">
                                <dt>Identifiant</dt>
                                <dd>${recordId}</dd>
                                
                                <dt>Date de création</dt>
                                <dd>${fields.creationdate ? new Date(fields.creationdate).toLocaleDateString('fr-FR', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }) : 'Non renseignée'}</dd>
                                
                                <dt>Catégorie</dt>
                                <dd><span class="fr-badge">${fields.category || 'Non renseignée'}</span></dd>
                                
                                <dt>Sous-catégories</dt>
                                <dd>${fields.subcategories || 'Aucune sous-catégorie'}</dd>
                                
                                <dt>Localisation</dt>
                                <dd>
                                    <strong>${fields.dep_name || 'Département inconnu'}</strong> (${fields.dep_code || '??'})<br>
                                    Région: ${fields.reg_name || 'Non renseignée'}
                                </dd>
                                
                                <dt>Statut actuel</dt>
                                <dd><span class="status-badge status-${fields.status}">${fields.status || 'NA'}</span></dd>
                                
                                <dt>Suivi du signalement</dt>
                                <dd>
                                    <ul class="fr-list">
                                        <li>Signalement transmis: ${fields.signalement_transmis == 1 ? '✓ Oui' : '✗ Non'}</li>
                                        <li>Signalement lu: ${fields.signalement_lu == 1 ? '✓ Oui' : '✗ Non'}</li>
                                        <li>Réponse apportée: ${fields.signalement_reponse == 1 ? '✓ Oui' : '✗ Non'}</li>
                                    </ul>
                                </dd>
                            </dl>
                        </div>
                    </div>
                `;
                
                const modalElement = document.getElementById('modal-details');
                modalElement.showModal();
                modalElement.style.display = 'flex';
            }
        }
        
        function closeDetailsModal() {
            const modalElement = document.getElementById('modal-details');
            modalElement.close();
        }
        
        function viewDetails(recordId) {
            openDetailsModal(recordId);
        }
        
        // Rendre les fonctions accessibles globalement
        window.viewDetails = viewDetails;
        window.closeDetailsModal = closeDetailsModal;
        
        // Event delegation pour les boutons détails
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('btn-details')) {
                e.preventDefault();
                const recordId = e.target.getAttribute('data-recordid');
                console.log('Button clicked, recordId:', recordId);
                if (recordId) {
                    viewDetails(recordId);
                }
            }
        });
        
        // Polyfill pour dialog si nécessaire
        function setupDialogPolyfill() {
            const modal = document.getElementById('modal-details');
            if (modal && typeof modal.showModal !== 'function') {
                modal.showModal = function() {
                    this.style.display = 'block';
                    this.style.position = 'fixed';
                    this.style.top = '50%';
                    this.style.left = '50%';
                    this.style.transform = 'translate(-50%, -50%)';
                    this.style.zIndex = '9999';
                    this.setAttribute('open', '');
                };
                modal.close = function() {
                    this.style.display = 'none';
                    this.removeAttribute('open');
                };
            }
        }
        
        // Au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            setupDialogPolyfill();
        });
        
        // Charger les données au démarrage
        loadData();
    </script>
</body>
</html>