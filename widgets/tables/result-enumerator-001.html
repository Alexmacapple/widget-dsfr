<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Result Enumerator DSFR - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
    <style>
        body { overflow-x: hidden; }
        .card-grid { margin: 2rem 0; }
        .status-badge { padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.875rem; }
        .status-NA { background: #e5e5e5; color: #666; }
        .status-NonConsulte { background: #ffe9e6; color: #ce0500; }
        .status-PromesseAction { background: #d4f4dd; color: #18753c; }
        .status-Infonde { background: #fff4e6; color: #b34000; }
        
        /* Styles pour la modal DSFR */
        dialog#modal-details {
            padding: 0;
            border: none;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 48rem;
            max-height: 90vh;
            background: transparent;
        }
        
        dialog#modal-details::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        dialog#modal-details[open] {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fr-modal__body {
            background: white;
            border-radius: 0.5rem;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 1.5rem rgba(0, 0, 0, 0.3);
        }
        
        .fr-modal__header {
            position: relative;
            padding: 0;
            margin: 0;
            height: 3rem;
        }
        
        .fr-modal__content {
            padding: 1rem 2rem 2rem 2rem;
        }
        
        /* Bouton fermeture conforme DSFR */
        .fr-btn--close {
            position: absolute;
            top: 0;
            right: 0;
            width: 3rem;
            height: 3rem;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-action-high-grey, #161616);
            transition: all 0.3s;
            border-radius: 0 0.5rem 0 0;
        }
        
        .fr-btn--close:hover {
            background-color: var(--background-contrast-grey, #e5e5e5);
            color: var(--text-action-high-blue-france, #000091);
        }
        
        .fr-btn--close:active {
            background-color: var(--background-contrast-grey-active, #d2d2d2);
        }
        
        .fr-btn--close::before,
        .fr-btn--close::after {
            content: '';
            position: absolute;
            width: 1.25rem;
            height: 2px;
            background-color: currentColor;
            transition: transform 0.3s;
        }
        
        .fr-btn--close::before {
            transform: rotate(45deg);
        }
        
        .fr-btn--close::after {
            transform: rotate(-45deg);
        }
        
        .fr-btn--close:hover::before {
            transform: rotate(45deg) scale(1.1);
        }
        
        .fr-btn--close:hover::after {
            transform: rotate(-45deg) scale(1.1);
        }
        
        /* Texte accessible pour les lecteurs d'écran */
        .fr-sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        dl.fr-list dt {
            font-weight: 700;
            margin-top: 1rem;
            color: #161616;
        }
        dl.fr-list dd {
            margin-left: 0;
            margin-bottom: 0.5rem;
            color: #3a3a3a;
        }
        
        /* Styles pour les cartes d'info dans la modale */
        .modal-info-card {
            background: #f6f6f6;
            padding: 1.25rem;
            border-radius: 0.375rem;
            margin-bottom: 1.5rem;
        }
        
        .modal-info-card h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #161616;
        }
        
        .modal-info-grid {
            display: grid;
            gap: 1rem;
        }
        
        .modal-field-group {
            display: grid;
            grid-template-columns: 140px 1fr;
            align-items: center;
            gap: 1rem;
        }
        
        .modal-field-label {
            font-size: 0.875rem;
            color: #666;
            font-weight: 500;
        }
        
        .modal-field-value {
            font-size: 1rem;
        }
        
        /* Styles pour la modale style DSFR */
        dialog {
            padding: 0;
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 90vw;
            max-height: 90vh;
            width: 800px;
        }
        
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-wrapper {
            background: white;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .modal-header-content {
            flex: 1;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #161616;
        }
        
        .btn-close-modal {
            background: white;
            border: 2px solid #000091;
            color: #000091;
            border-radius: 0.25rem;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            min-width: 2.5rem;
            height: 2.5rem;
        }
        
        .btn-close-modal:hover {
            background: #000091;
            color: white;
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- DÉBUT ZONE WIDGET RESULT-ENUMERATOR-001 -->
    <div id="widget-result-enumerator-001" class="fr-container fr-py-3w">
        <h1 class="fr-h3">Liste de résultats paginée</h1>
        <p class="fr-text--sm">Affichage en cartes avec pagination</p>
        
        <!-- Compteurs de résultats DSFR -->
        <div class="fr-grid-row fr-grid-row--gutters fr-mb-3w">
            <div class="fr-col-12 fr-col-sm-4">
                <div class="fr-tile fr-tile--sm">
                    <div class="fr-tile__body">
                        <h3 class="fr-tile__title">Total résultats</h3>
                        <p class="fr-tile__desc">
                            <span class="fr-badge fr-badge--info fr-badge--no-icon">
                                <strong id="total-count">0</strong>
                            </span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="fr-col-12 fr-col-sm-4">
                <div class="fr-tile fr-tile--sm">
                    <div class="fr-tile__body">
                        <h3 class="fr-tile__title">Page actuelle</h3>
                        <p class="fr-tile__desc">
                            <span class="fr-badge fr-badge--success fr-badge--no-icon">
                                <strong><span id="current-page">1</span> / <span id="total-pages">1</span></strong>
                            </span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="fr-col-12 fr-col-sm-4">
                <div class="fr-tile fr-tile--sm">
                    <div class="fr-tile__body">
                        <h3 class="fr-tile__title">Éléments par page</h3>
                        <p class="fr-tile__desc">
                            <span class="fr-badge fr-badge--new fr-badge--no-icon">
                                <strong>10</strong>
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="cards-container" class="fr-grid-row fr-grid-row--gutters card-grid">
            <!-- Les cartes seront générées ici -->
        </div>
        
        <nav role="navigation" class="fr-pagination fr-mt-3w" aria-label="Pagination" id="pagination">
            <ul class="fr-pagination__list" id="pagination-list">
                <!-- La pagination sera générée dynamiquement -->
            </ul>
        </nav>
    </div>
    <!-- FIN ZONE WIDGET RESULT-ENUMERATOR-001 -->
    
    <!-- Modale pour les détails -->
    <dialog id="modal-details" role="dialog" aria-labelledby="modal-details-title">
        <div class="modal-wrapper">
            <div class="modal-header">
                <div class="modal-header-content">
                    <h2 id="modal-details-title" class="modal-title">
                        Détails du signalement
                    </h2>
                </div>
                <button class="btn-close-modal" 
                        type="button"
                        title="Fermer" 
                        aria-label="Fermer la fenêtre"
                        onclick="closeModal()">
                    <svg aria-hidden="true" focusable="false" width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M12 10.586L16.95 5.636L18.364 7.05L13.414 12L18.364 16.95L16.95 18.364L12 13.414L7.05 18.364L5.636 16.95L10.586 12L5.636 7.05L7.05 5.636L12 10.586Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="modal-details-content">
                    <!-- Le contenu sera injecté ici -->
                </div>
            </div>
        </div>
    </dialog>
    
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js"></script>
    <script>
        let allData = [];
        let currentPage = 0;
        const itemsPerPage = 10;
        
        async function loadData() {
            try {
                console.log('Chargement des données...');
                const response = await fetch('https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=100&sort=-creationdate');
                const data = await response.json();
                
                allData = data.records || [];
                document.getElementById('total-count').textContent = data.nhits.toLocaleString('fr-FR');
                
                console.log(`${allData.length} enregistrements chargés`);
                displayCards();
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('cards-container').innerHTML = 
                    '<div class="fr-alert fr-alert--error"><p>Erreur de chargement des données</p></div>';
            }
        }
        
        function displayCards() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            if (allData.length === 0) {
                container.innerHTML = '<div class="fr-alert fr-alert--info"><p>Aucun résultat trouvé</p></div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            const start = currentPage * itemsPerPage;
            const end = Math.min(start + itemsPerPage, allData.length);
            const displayedData = allData.slice(start, end);
            
            displayedData.forEach(record => {
                const fields = record.fields || {};
                const cardCol = document.createElement('div');
                cardCol.className = 'fr-col-12 fr-col-md-6';
                
                const statusClass = `status-${fields.status}`;
                const truncatedSubcategories = fields.subcategories ? 
                    (fields.subcategories.length > 150 ? fields.subcategories.substring(0, 150) + '...' : fields.subcategories) 
                    : 'Aucune description';
                
                cardCol.innerHTML = `
                    <div class="fr-card fr-card--horizontal">
                        <div class="fr-card__body">
                            <div class="fr-card__content">
                                <h3 class="fr-card__title">
                                    <span class="fr-badge">${fields.category || 'Catégorie inconnue'}</span>
                                </h3>
                                <p class="fr-card__desc">
                                    ${truncatedSubcategories}
                                </p>
                                <div class="fr-card__start">
                                    <p class="fr-card__detail">
                                        <span class="fr-icon-map-pin-2-line" aria-hidden="true"></span>
                                        ${fields.dep_name || 'Département inconnu'} (${fields.dep_code || '??'})
                                    </p>
                                    <p class="fr-card__detail">
                                        <span class="fr-icon-calendar-line" aria-hidden="true"></span>
                                        ${fields.creationdate ? new Date(fields.creationdate).toLocaleDateString('fr-FR') : 'Date inconnue'}
                                    </p>
                                    <p class="fr-card__detail">
                                        <span class="status-badge ${statusClass}">${fields.status || 'NA'}</span>
                                    </p>
                                </div>
                            </div>
                            <div class="fr-card__footer">
                                <ul class="fr-btns-group fr-btns-group--inline-reverse fr-btns-group--inline-lg">
                                    <li>
                                        <button class="fr-btn fr-btn--secondary" 
                                                data-recordid="${record.recordid}"
                                                title="Voir les détails du signalement" 
                                                aria-label="Voir les détails"
                                                onclick="viewDetails('${record.recordid}'); return false;">
                                            Voir détails
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(cardCol);
            });
            
            updatePagination();
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            document.getElementById('current-page').textContent = currentPage + 1;
            document.getElementById('total-pages').textContent = totalPages;
            
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            document.getElementById('pagination').style.display = 'block';
            
            const paginationList = document.getElementById('pagination-list');
            paginationList.innerHTML = '';
            
            // Première page
            const firstLi = document.createElement('li');
            firstLi.innerHTML = `
                <a class="fr-pagination__link fr-pagination__link--first ${currentPage === 0 ? 'fr-pagination__link--first-disabled' : ''}" 
                   ${currentPage === 0 ? 'aria-disabled="true"' : ''}
                   href="#" 
                   title="Aller à la première page"
                   aria-label="Aller à la première page"
                   onclick="return goToPage(0);">
                    Première page
                </a>
            `;
            paginationList.appendChild(firstLi);
            
            // Page précédente
            const prevLi = document.createElement('li');
            const prevPageNum = currentPage > 0 ? currentPage : 1;
            prevLi.innerHTML = `
                <a class="fr-pagination__link fr-pagination__link--prev ${currentPage === 0 ? 'fr-pagination__link--prev-disabled' : ''}" 
                   ${currentPage === 0 ? 'aria-disabled="true"' : ''}
                   href="#" 
                   title="Aller à la page ${prevPageNum}"
                   aria-label="Aller à la page précédente (page ${prevPageNum})"
                   onclick="return previousPage();">
                    Page précédente
                </a>
            `;
            paginationList.appendChild(prevLi);
            
            // Numéros de pages
            const maxPages = 5;
            const startPage = Math.max(0, currentPage - Math.floor(maxPages / 2));
            const endPage = Math.min(totalPages, startPage + maxPages);
            
            if (startPage > 0) {
                const li = document.createElement('li');
                li.innerHTML = `<span aria-hidden="true">...</span>`;
                paginationList.appendChild(li);
            }
            
            for (let i = startPage; i < endPage; i++) {
                const li = document.createElement('li');
                const pageNum = i + 1;
                
                if (i === currentPage) {
                    li.innerHTML = `
                        <a class="fr-pagination__link" 
                           aria-current="page" 
                           title="Page courante, page ${pageNum}"
                           aria-label="Page ${pageNum} - Page courante">
                            ${pageNum}
                        </a>
                    `;
                } else {
                    li.innerHTML = `
                        <a class="fr-pagination__link" 
                           href="#" 
                           title="Aller à la page ${pageNum}"
                           aria-label="Aller à la page ${pageNum}"
                           onclick="return goToPage(${i});">
                            ${pageNum}
                        </a>
                    `;
                }
                paginationList.appendChild(li);
            }
            
            if (endPage < totalPages) {
                const li = document.createElement('li');
                li.innerHTML = `<span aria-hidden="true">...</span>`;
                paginationList.appendChild(li);
            }
            
            // Page suivante
            const nextLi = document.createElement('li');
            const nextPageNum = currentPage < totalPages - 1 ? currentPage + 2 : totalPages;
            nextLi.innerHTML = `
                <a class="fr-pagination__link fr-pagination__link--next ${currentPage >= totalPages - 1 ? 'fr-pagination__link--next-disabled' : ''}" 
                   ${currentPage >= totalPages - 1 ? 'aria-disabled="true"' : ''}
                   href="#" 
                   title="Aller à la page ${nextPageNum}"
                   aria-label="Aller à la page suivante (page ${nextPageNum})"
                   onclick="return nextPage();">
                    Page suivante
                </a>
            `;
            paginationList.appendChild(nextLi);
            
            // Dernière page
            const lastLi = document.createElement('li');
            lastLi.innerHTML = `
                <a class="fr-pagination__link fr-pagination__link--last ${currentPage >= totalPages - 1 ? 'fr-pagination__link--last-disabled' : ''}" 
                   ${currentPage >= totalPages - 1 ? 'aria-disabled="true"' : ''}
                   href="#" 
                   title="Aller à la dernière page (page ${totalPages})"
                   aria-label="Aller à la dernière page (page ${totalPages})"
                   onclick="return goToLastPage();">
                    Dernière page
                </a>
            `;
            paginationList.appendChild(lastLi);
        }
        
        function goToPage(page) {
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            currentPage = Math.max(0, Math.min(page, totalPages - 1));
            displayCards();
            window.scrollTo(0, 0);
            return false;
        }
        
        function previousPage() {
            if (currentPage > 0) {
                goToPage(currentPage - 1);
            }
            return false;
        }
        
        function nextPage() {
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            if (currentPage < totalPages - 1) {
                goToPage(currentPage + 1);
            }
            return false;
        }
        
        function goToLastPage() {
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            goToPage(totalPages - 1);
            return false;
        }
        
        // Rendre les fonctions de pagination accessibles globalement
        window.goToPage = goToPage;
        window.previousPage = previousPage;
        window.nextPage = nextPage;
        window.goToLastPage = goToLastPage;
        
        function viewDetails(recordId) {
            console.log('viewDetails appelé avec recordId:', recordId);
            const record = allData.find(r => r.recordid === recordId);
            console.log('Record trouvé:', record);
            if (record) {
                const fields = record.fields;
                const modalContent = document.getElementById('modal-details-content');
                modalContent.innerHTML = `
                    <!-- Alert avec référence -->
                    <div class="fr-alert fr-alert--info fr-alert--sm fr-mb-3w">
                        <p class="fr-alert__title">Référence du signalement</p>
                        <p><code>${recordId}</code></p>
                    </div>
                    
                    <!-- Informations principales -->
                    <div class="modal-info-card">
                        <h3 class="fr-h6">
                            Informations générales
                        </h3>
                        <div class="modal-info-grid">
                            <div class="modal-field-group">
                                <div class="modal-field-label">Date de création</div>
                                <div class="modal-field-value">
                                    <strong>${fields.creationdate ? new Date(fields.creationdate).toLocaleDateString('fr-FR', { 
                                        day: 'numeric', 
                                        month: 'long', 
                                        year: 'numeric' 
                                    }) : 'Non renseignée'}</strong>
                                </div>
                            </div>
                            <div class="modal-field-group">
                                <div class="modal-field-label">Catégorie</div>
                                <div class="modal-field-value">
                                    <span class="fr-badge fr-badge--info">${fields.category || 'Non catégorisé'}</span>
                                </div>
                            </div>
                            <div class="modal-field-group">
                                <div class="modal-field-label">Statut actuel</div>
                                <div class="modal-field-value">
                                    <span class="fr-badge fr-badge--${fields.status === 'PromesseAction' ? 'success' : fields.status === 'NonConsulte' ? 'error' : 'grey'}">
                                        ${fields.status || 'NA'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Localisation -->
                    <div class="modal-info-card">
                        <h3 class="fr-h6">
                            Localisation
                        </h3>
                        <div class="modal-info-grid">
                            <div class="modal-field-group">
                                <div class="modal-field-label">Département</div>
                                <div class="modal-field-value">
                                    <strong>${fields.dep_name || 'Non renseigné'}</strong>
                                    ${fields.dep_code ? ` <span class="fr-badge fr-badge--sm fr-badge--yellow-tournesol">${fields.dep_code}</span>` : ''}
                                </div>
                            </div>
                            <div class="modal-field-group">
                                <div class="modal-field-label">Région</div>
                                <div class="modal-field-value">
                                    <strong>${fields.reg_name || 'Non renseignée'}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- État du signalement -->
                    <div class="fr-callout fr-callout--blue-ecume">
                        <h3 class="fr-callout__title">
                            État du traitement
                        </h3>
                        <ul class="fr-tags-group">
                            <li>
                                <p class="fr-tag ${fields.signalement_transmis == 1 ? 'fr-tag--green-emeraude' : 'fr-tag--grey'}">
                                    ${fields.signalement_transmis == 1 ? '✓' : '✗'} Transmis
                                </p>
                            </li>
                            <li>
                                <p class="fr-tag ${fields.signalement_lu == 1 ? 'fr-tag--blue-ecume' : 'fr-tag--grey'}">
                                    ${fields.signalement_lu == 1 ? '✓' : '✗'} Lu
                                </p>
                            </li>
                            <li>
                                <p class="fr-tag ${fields.signalement_reponse == 1 ? 'fr-tag--purple-glycine' : 'fr-tag--grey'}">
                                    ${fields.signalement_reponse == 1 ? '✓' : '✗'} Réponse
                                </p>
                            </li>
                        </ul>
                    </div>
                `;
                
                // Ouvrir la modale
                openModal();
            }
        }
        
        function openModal() {
            const modal = document.getElementById('modal-details');
            console.log('openModal appelé, modal trouvé:', modal);
            if (modal) {
                try {
                    // Utiliser l'API dialog HTML5
                    if (typeof modal.showModal === 'function') {
                        modal.showModal();
                        console.log('Modal ouvert avec showModal()');
                    } else {
                        // Fallback pour les navigateurs qui ne supportent pas showModal
                        modal.setAttribute('open', '');
                        modal.style.display = 'block';
                        console.log('Modal ouvert avec fallback');
                    }
                } catch (err) {
                    console.error('Erreur ouverture modale:', err);
                    modal.setAttribute('open', '');
                    modal.style.display = 'block';
                }
            } else {
                console.error('Element modal-details non trouvé!');
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('modal-details');
            if (modal) {
                try {
                    // Utiliser l'API dialog HTML5
                    if (typeof modal.close === 'function') {
                        modal.close();
                    } else {
                        // Fallback
                        modal.removeAttribute('open');
                        modal.style.display = 'none';
                    }
                } catch (err) {
                    console.error('Erreur fermeture modale:', err);
                    modal.removeAttribute('open');
                    modal.style.display = 'none';
                }
            }
        }
        
        // Ancienne fonction pour compatibilité
        function closeDetailsModal() {
            closeModal();
        }
        
        // Rendre les fonctions accessibles globalement
        window.viewDetails = viewDetails;
        window.closeModal = closeModal;
        window.openModal = openModal;
        window.closeDetailsModal = closeDetailsModal;
        
        // Polyfill pour dialog si nécessaire
        function setupDialogPolyfill() {
            const modal = document.getElementById('modal-details');
            if (modal && typeof modal.showModal !== 'function') {
                modal.showModal = function() {
                    this.style.display = 'block';
                    this.style.position = 'fixed';
                    this.style.top = '50%';
                    this.style.left = '50%';
                    this.style.transform = 'translate(-50%, -50%)';
                    this.style.zIndex = '9999';
                    this.setAttribute('open', '');
                };
                modal.close = function() {
                    this.style.display = 'none';
                    this.removeAttribute('open');
                };
            }
        }
        
        // Au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            setupDialogPolyfill();
        });
        
        // Charger les données au démarrage
        loadData();
    </script>
</body>
</html>