<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Table avec agrégations - SignalConso</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    <style>
        body { margin: 0; font-family: Marianne, arial, sans-serif; }
        .aggregate-section { margin-bottom: 2rem; }
        .aggregate-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .fr-table { width: 100% !important; border-collapse: collapse; }
        .fr-table table { width: 100% !important; }
        .fr-table.fr-table--bordered th,
        .fr-table.fr-table--bordered td {
            border: 1px solid #ddd;
        }
        .progress-bar {
            height: 8px;
            background: #e5e5e5;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #000091, #6a6af4);
            transition: width 0.3s ease;
        }
        .trend-up { color: #ce0500; }
        .trend-stable { color: #b34000; }
        .trend-down { color: #18753c; }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            height: 20px;
            margin: 0.5rem 0;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Focus visible renforcé pour accessibilité */
        .fr-btn:focus-visible,
        .fr-input:focus-visible,
        .fr-select:focus-visible,
        button:focus-visible,
        a:focus-visible {
            outline: 3px solid #000091;
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 0, 145, 0.2);
        }
        
        /* Classe sr-only pour masquer visuellement mais garder accessible */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div class="fr-container fr-py-3w">
        <h1 class="fr-h3">Table avec agrégations</h1>
        <p class="fr-text--sm">Statistiques et agrégations par catégorie et région</p>

        <!-- Cartes d'agrégation globales -->
        <div class="aggregate-section">
            <h2 class="fr-h5">Statistiques globales</h2>
            <div class="aggregate-cards">
                <div class="fr-tile fr-tile--horizontal">
                    <div class="fr-tile__body">
                        <h3 class="fr-tile__title">Total signalements</h3>
                        <p class="fr-tile__desc fr-text--bold fr-text--lg" id="total-count">
                            <span class="skeleton" style="width: 100px; display: inline-block;"></span>
                        </p>
                    </div>
                </div>
                <div class="fr-tile fr-tile--horizontal">
                    <div class="fr-tile__body">
                        <h3 class="fr-tile__title">Catégories</h3>
                        <p class="fr-tile__desc fr-text--bold fr-text--lg" id="categories-count">
                            <span class="skeleton" style="width: 60px; display: inline-block;"></span>
                        </p>
                    </div>
                </div>
                <div class="fr-tile fr-tile--horizontal">
                    <div class="fr-tile__body">
                        <h3 class="fr-tile__title">Départements</h3>
                        <p class="fr-tile__desc fr-text--bold fr-text--lg" id="departments-count">
                            <span class="skeleton" style="width: 60px; display: inline-block;"></span>
                        </p>
                    </div>
                </div>
                <div class="fr-tile fr-tile--horizontal">
                    <div class="fr-tile__body">
                        <h3 class="fr-tile__title">Régions</h3>
                        <p class="fr-tile__desc fr-text--bold fr-text--lg" id="regions-count">
                            <span class="skeleton" style="width: 60px; display: inline-block;"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table d'agrégation par catégorie -->
        <h2 class="fr-h5">Top 10 Catégories</h2>
        <table class="fr-table fr-table--bordered" style="width: 100%; table-layout: fixed;">
            <thead>
                <tr>
                    <th style="width: 30%;">Catégorie</th>
                    <th style="width: 15%;">Nombre</th>
                    <th style="width: 15%;">Pourcentage</th>
                    <th style="width: 25%;">Progression</th>
                    <th style="width: 15%;">Tendance</th>
                </tr>
            </thead>
            <tbody id="categories-table">
                <tr>
                    <td colspan="5" style="text-align: center;">
                        <div class="skeleton"></div>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Table d'agrégation par région -->
        <h2 class="fr-h5 fr-mt-3w">Top 10 Régions</h2>
        <table class="fr-table fr-table--bordered" style="width: 100%; table-layout: fixed;">
            <thead>
                <tr>
                    <th style="width: 25%;">Région</th>
                    <th style="width: 20%;">Signalements</th>
                    <th style="width: 15%;">Pourcentage</th>
                    <th style="width: 20%;">Département principal</th>
                    <th style="width: 20%;">Catégorie principale</th>
                </tr>
            </thead>
            <tbody id="regions-table">
                <tr>
                    <td colspan="5" style="text-align: center;">
                        <div class="skeleton"></div>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Table d'agrégation par statut -->
        <h2 class="fr-h5 fr-mt-3w">Répartition par statut</h2>
        <table class="fr-table fr-table--bordered" style="width: 100%; table-layout: fixed;">
            <thead>
                <tr>
                    <th style="width: 25%;">Statut</th>
                    <th style="width: 20%;">Nombre</th>
                    <th style="width: 15%;">Pourcentage</th>
                    <th style="width: 40%;">Visualisation</th>
                </tr>
            </thead>
            <tbody id="status-table">
                <tr>
                    <td colspan="4" style="text-align: center;">
                        <div class="skeleton"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
    <script>
        let allData = [];
        let aggregations = {
            categories: {},
            regions: {},
            departments: {},
            status: {}
        };
        let regionDetails = {}; // Pour stocker les détails par région

        async function loadData() {
            try {
                
                // Charger les données
                const response = await fetch('https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=1000&sort=-creationdate');
                const data = await response.json();
                
                allData = data.records || [];
                const totalCount = data.nhits;
                
                
                // Afficher le total
                document.getElementById('total-count').textContent = totalCount.toLocaleString('fr-FR');
                
                // Calculer les agrégations
                calculateAggregations();
                
                // Charger les facettes pour avoir les vraies stats
                loadFacets();
            } catch (error) {
                console.error('Erreur:', error);
                showError();
            }
        }

        function calculateAggregations() {
            // Réinitialiser
            aggregations = {
                categories: {},
                regions: {},
                departments: {},
                status: {}
            };
            regionDetails = {};

            // Calculer les agrégations locales sur l'échantillon
            allData.forEach(record => {
                const fields = record.fields || {};
                
                // Catégories
                if (fields.category) {
                    aggregations.categories[fields.category] = (aggregations.categories[fields.category] || 0) + 1;
                }
                
                // Régions avec détails
                if (fields.reg_name) {
                    aggregations.regions[fields.reg_name] = (aggregations.regions[fields.reg_name] || 0) + 1;
                    
                    // Initialiser les détails de la région si nécessaire
                    if (!regionDetails[fields.reg_name]) {
                        regionDetails[fields.reg_name] = {
                            departments: {},
                            categories: {}
                        };
                    }
                    
                    // Compter les départements par région avec leur code
                    if (fields.dep_name && fields.dep_code) {
                        const deptWithCode = `${fields.dep_name} (${fields.dep_code})`;
                        regionDetails[fields.reg_name].departments[deptWithCode] = 
                            (regionDetails[fields.reg_name].departments[deptWithCode] || 0) + 1;
                    }
                    
                    // Compter les catégories par région
                    if (fields.category) {
                        regionDetails[fields.reg_name].categories[fields.category] = 
                            (regionDetails[fields.reg_name].categories[fields.category] || 0) + 1;
                    }
                }
                
                // Départements
                if (fields.dep_code) {
                    aggregations.departments[fields.dep_code] = (aggregations.departments[fields.dep_code] || 0) + 1;
                }
                
                // Status
                if (fields.status) {
                    aggregations.status[fields.status] = (aggregations.status[fields.status] || 0) + 1;
                }
            });

            // Afficher les compteurs
            document.getElementById('categories-count').textContent = Object.keys(aggregations.categories).length;
            document.getElementById('departments-count').textContent = Object.keys(aggregations.departments).length;
            document.getElementById('regions-count').textContent = Object.keys(aggregations.regions).length;
        }

        async function loadFacets() {
            try {
                // Charger les facettes pour avoir les vraies stats complètes
                const facetResponse = await fetch('https://data.economie.gouv.fr/api/records/1.0/search/?dataset=signalconso&rows=0&facet=category&facet=reg_name&facet=status');
                const facetData = await facetResponse.json();
                
                
                // Traiter et afficher les facettes
                displayCategoriesTable(facetData.facet_groups, facetData.nhits);
                displayRegionsTable(facetData.facet_groups, facetData.nhits);
                displayStatusTable(facetData.facet_groups, facetData.nhits);
            } catch (error) {
                console.error('Erreur chargement facettes:', error);
            }
        }

        function displayCategoriesTable(facetGroups, totalHits) {
            const categoryFacet = facetGroups.find(g => g.name === 'category');
            if (!categoryFacet) return;

            const tbody = document.getElementById('categories-table');
            tbody.innerHTML = '';
            
            // Top 10 catégories
            categoryFacet.facets.slice(0, 10).forEach((item, index) => {
                const percent = (item.count / totalHits * 100).toFixed(1);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="fr-badge fr-badge--${getColorForIndex(index)}">${item.name}</span>
                    </td>
                    <td><strong>${item.count.toLocaleString('fr-FR')}</strong></td>
                    <td>${percent}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%"></div>
                        </div>
                    </td>
                    <td>
                        ${getTrendIcon(percent)}
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Ligne total
            const totalRow = document.createElement('tr');
            totalRow.className = 'fr-table__row--grey';
            totalRow.innerHTML = `
                <td><strong>TOTAL TOP 10</strong></td>
                <td><strong>${categoryFacet.facets.slice(0, 10).reduce((sum, item) => sum + item.count, 0).toLocaleString('fr-FR')}</strong></td>
                <td><strong>${(categoryFacet.facets.slice(0, 10).reduce((sum, item) => sum + item.count, 0) / totalHits * 100).toFixed(1)}%</strong></td>
                <td>-</td>
                <td>-</td>
            `;
            tbody.appendChild(totalRow);
        }

        function displayRegionsTable(facetGroups, totalHits) {
            const regionFacet = facetGroups.find(g => g.name === 'reg_name');
            if (!regionFacet) return;

            const tbody = document.getElementById('regions-table');
            tbody.innerHTML = '';
            
            // Top 10 régions
            regionFacet.facets.slice(0, 10).forEach((item, index) => {
                const percent = (item.count / totalHits * 100).toFixed(1);
                
                // Trouver le département et la catégorie principaux pour cette région
                let mainDepartment = '-';
                let mainCategory = '-';
                
                if (regionDetails[item.name]) {
                    // Département principal
                    const depts = regionDetails[item.name].departments;
                    if (Object.keys(depts).length > 0) {
                        const topDept = Object.entries(depts).sort((a, b) => b[1] - a[1])[0];
                        if (topDept) {
                            mainDepartment = topDept[0];
                        }
                    }
                    
                    // Catégorie principale
                    const cats = regionDetails[item.name].categories;
                    if (Object.keys(cats).length > 0) {
                        const topCat = Object.entries(cats).sort((a, b) => b[1] - a[1])[0];
                        if (topCat) {
                            mainCategory = topCat[0];
                        }
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.name}</strong></td>
                    <td>${item.count.toLocaleString('fr-FR')}</td>
                    <td>
                        <span class="fr-badge fr-badge--sm">${percent}%</span>
                    </td>
                    <td>${mainDepartment}</td>
                    <td><span class="fr-badge fr-badge--sm fr-badge--grey">${mainCategory}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayStatusTable(facetGroups, totalHits) {
            const statusFacet = facetGroups.find(g => g.name === 'status');
            if (!statusFacet) return;

            const tbody = document.getElementById('status-table');
            tbody.innerHTML = '';
            
            statusFacet.facets.forEach(item => {
                const percent = (item.count / totalHits * 100).toFixed(1);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="fr-badge fr-badge--${getStatusColor(item.name)}">${item.name}</span>
                    </td>
                    <td><strong>${item.count.toLocaleString('fr-FR')}</strong></td>
                    <td>${percent}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%; background: ${getStatusGradient(item.name)}"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getColorForIndex(index) {
            const colors = ['info', 'success', 'warning', 'error', 'new', 'grey', 'blue-ecume', 'purple-glycine', 'green-emeraude', 'yellow-tournesol'];
            return colors[index % colors.length];
        }

        function getStatusColor(status) {
            const statusColors = {
                'PromesseAction': 'success',
                'NonConsulte': 'error',
                'NA': 'grey',
                'Infonde': 'warning'
            };
            return statusColors[status] || 'info';
        }

        function getStatusGradient(status) {
            const gradients = {
                'PromesseAction': 'linear-gradient(90deg, #18753c, #27a658)',
                'NonConsulte': 'linear-gradient(90deg, #ce0500, #ff6b6b)',
                'NA': 'linear-gradient(90deg, #666, #999)',
                'Infonde': 'linear-gradient(90deg, #b34000, #ff8c42)'
            };
            return gradients[status] || 'linear-gradient(90deg, #000091, #6a6af4)';
        }

        function getTrendIcon(percent) {
            if (percent > 10) {
                return '<span class="trend-up">↑ Élevé</span>';
            } else if (percent > 5) {
                return '<span class="trend-stable">→ Moyen</span>';
            } else {
                return '<span class="trend-down">↓ Faible</span>';
            }
        }

        function showError() {
            ['categories-table', 'regions-table', 'status-table'].forEach(id => {
                document.getElementById(id).innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: red;">
                            Erreur de chargement des données
                        </td>
                    </tr>
                `;
            });
        }

        // Support clavier amélioré et initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Charger les données
            loadData();
            
            // Support clavier pour tous les boutons
            setTimeout(function() {
                const allButtons = document.querySelectorAll('button');
                allButtons.forEach(button => {
                    if (!button.hasAttribute('aria-label') && button.textContent.trim()) {
                        button.setAttribute('aria-label', button.textContent.trim());
                    }
                    
                    button.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.click();
                        }
                    });
                });
                
                // Amélioration accessibilité des tableaux
                const tables = document.querySelectorAll('table');
                tables.forEach(table => {
                    // Ajouter un résumé si manquant
                    if (!table.querySelector('caption')) {
                        const caption = document.createElement('caption');
                        caption.className = 'sr-only';
                        caption.textContent = 'Tableau de données agrégées';
                        table.insertBefore(caption, table.firstChild);
                    }
                    
                    // S'assurer que les headers ont scope
                    const headers = table.querySelectorAll('th');
                    headers.forEach(header => {
                        if (!header.hasAttribute('scope')) {
                            // Déterminer si c'est une colonne ou une ligne
                            if (header.parentElement.parentElement.tagName === 'THEAD') {
                                header.setAttribute('scope', 'col');
                            } else {
                                header.setAttribute('scope', 'row');
                            }
                        }
                    });
                });
                
                // Ajouter aria-live pour les mises à jour dynamiques
                const statsContainers = document.querySelectorAll('.fr-tile__desc');
                statsContainers.forEach(container => {
                    if (container.querySelector('.skeleton')) {
                        container.setAttribute('aria-live', 'polite');
                        container.setAttribute('aria-busy', 'true');
                    }
                });
            }, 1000); // Attendre que les données soient chargées
        });
    </script>
</body>
</html>