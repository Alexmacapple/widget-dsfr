<!DOCTYPE html>
<html lang="fr" data-fr-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Builder de Widgets DSFR - Interface Graphique</title>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    
    <!-- API Scripts -->
    <script src="js/wrapper-api.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/api-monitor.js"></script>
    
    <style>
        .builder-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .builder-main {
            flex: 1;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            padding: 2rem;
        }
        
        .builder-sidebar {
            background: #f6f6f6;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .builder-preview {
            background: white;
            padding: 1.5rem;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            overflow: auto;
        }
        
        .step {
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
        }
        
        .step.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            background: #000091;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: bold;
        }
        
        .widget-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .widget-type-card {
            padding: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .widget-type-card:hover {
            border-color: #000091;
            background: #f5f5fe;
        }
        
        .widget-type-card.selected {
            border-color: #000091;
            background: #000091;
            color: white;
        }
        
        .code-output {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow: auto;
        }
        
        .dataset-info {
            background: #e3e3fd;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="builder-container">
        <!-- Header -->
        <header role="banner" class="fr-header">
            <div class="fr-header__body">
                <div class="fr-container">
                    <div class="fr-header__body-row">
                        <div class="fr-header__brand fr-enlarge-link">
                            <div class="fr-header__brand-top">
                                <div class="fr-header__logo">
                                    <p class="fr-logo">
                                        République<br>Française
                                    </p>
                                </div>
                            </div>
                            <div class="fr-header__service">
                                <p class="fr-header__service-title">
                                    Builder de Widgets DSFR
                                </p>
                                <p class="fr-header__service-tagline">
                                    Générateur visuel de widgets OpenDataSoft
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="builder-main">
            <!-- Sidebar -->
            <aside class="builder-sidebar">
                <!-- Step 1: Choose Dataset -->
                <div class="step" id="step-1">
                    <div class="step-header">
                        <span class="step-number">1</span>
                        <h2 class="fr-h6">Choisir le dataset</h2>
                    </div>
                    
                    <div class="fr-select-group">
                        <label class="fr-label" for="dataset-select">
                            Dataset OpenDataSoft
                        </label>
                        <select class="fr-select" id="dataset-select">
                            <option value="">-- Sélectionner un dataset --</option>
                            <option value="signalconso">SignalConso - Signalements consommateurs</option>
                            <option value="annuaire-dgccrf">Annuaire DGCCRF</option>
                            <option value="budget-vert">Budget Vert PLF</option>
                            <option value="tarifs-bancaires">Tarifs Bancaires CCSF</option>
                            <option value="taux-de-change">Taux de Change DGFIP</option>
                            <option value="custom">Dataset personnalisé...</option>
                        </select>
                    </div>
                    
                    <div class="fr-input-group" id="custom-dataset-input" style="display: none;">
                        <label class="fr-label" for="custom-dataset">
                            ID du dataset personnalisé
                        </label>
                        <input type="text" class="fr-input" id="custom-dataset" placeholder="ex: mon-dataset">
                    </div>
                    
                    <button class="fr-btn fr-btn--secondary fr-mt-2w" id="analyze-dataset" disabled>
                        Analyser le dataset
                    </button>
                    
                    <div id="dataset-info" class="dataset-info" style="display: none;">
                        <h3 class="fr-h6">Informations du dataset</h3>
                        <p id="dataset-description"></p>
                    </div>
                </div>
                
                <!-- Step 2: Choose Widget Type -->
                <div class="step disabled" id="step-2">
                    <div class="step-header">
                        <span class="step-number">2</span>
                        <h2 class="fr-h6">Type de widget</h2>
                    </div>
                    
                    <div class="widget-type-grid">
                        <div class="widget-type-card" data-type="table">
                            <i class="fr-icon-table-line" aria-hidden="true"></i>
                            <p>Table</p>
                        </div>
                        <div class="widget-type-card" data-type="chart">
                            <i class="fr-icon-bar-chart-box-line" aria-hidden="true"></i>
                            <p>Graphique</p>
                        </div>
                        <div class="widget-type-card" data-type="map">
                            <i class="fr-icon-map-pin-2-line" aria-hidden="true"></i>
                            <p>Carte</p>
                        </div>
                        <div class="widget-type-card" data-type="list">
                            <i class="fr-icon-list-unordered" aria-hidden="true"></i>
                            <p>Liste</p>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Configure -->
                <div class="step disabled" id="step-3">
                    <div class="step-header">
                        <span class="step-number">3</span>
                        <h2 class="fr-h6">Configuration</h2>
                    </div>
                    
                    <div id="config-form">
                        <!-- Dynamic configuration form -->
                    </div>
                    
                    <button class="fr-btn fr-mt-2w" id="generate-widget" disabled>
                        Générer le widget
                    </button>
                </div>
            </aside>
            
            <!-- Preview Area -->
            <div class="builder-preview">
                <h2 class="fr-h4">Aperçu et code généré</h2>
                
                <div id="widget-preview">
                    <div class="fr-alert fr-alert--info">
                        <p>Sélectionnez un dataset et un type de widget pour commencer</p>
                    </div>
                </div>
                
                <div id="code-section" style="display: none;">
                    <div class="fr-mt-3w">
                        <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle">
                            <div class="fr-col">
                                <h3 class="fr-h5">Code HTML généré</h3>
                            </div>
                            <div class="fr-col-auto">
                                <button class="fr-btn fr-btn--secondary fr-btn--sm" id="copy-code">
                                    Copier le code
                                </button>
                            </div>
                        </div>
                        <div class="code-output" id="generated-code"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // Application state
        const app = {
            dataset: null,
            widgetType: null,
            config: {},
            generatedCode: ''
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Dataset selection
            document.getElementById('dataset-select').addEventListener('change', handleDatasetSelect);
            document.getElementById('analyze-dataset').addEventListener('click', analyzeDataset);
            
            // Widget type selection
            document.querySelectorAll('.widget-type-card').forEach(card => {
                card.addEventListener('click', () => selectWidgetType(card.dataset.type));
            });
            
            // Generate button
            document.getElementById('generate-widget').addEventListener('click', generateWidget);
            
            // Copy code button
            document.getElementById('copy-code').addEventListener('click', copyCode);
        }
        
        function handleDatasetSelect(e) {
            const value = e.target.value;
            const customInput = document.getElementById('custom-dataset-input');
            const analyzeBtn = document.getElementById('analyze-dataset');
            
            if (value === 'custom') {
                customInput.style.display = 'block';
                const customDatasetInput = document.getElementById('custom-dataset');
                
                // Clear previous listeners to avoid duplicates
                const newInput = customDatasetInput.cloneNode(true);
                customDatasetInput.parentNode.replaceChild(newInput, customDatasetInput);
                
                newInput.addEventListener('input', (e) => {
                    app.dataset = e.target.value;
                    analyzeBtn.disabled = !e.target.value;
                });
                
                analyzeBtn.disabled = !newInput.value;
            } else {
                customInput.style.display = 'none';
                app.dataset = value;
                analyzeBtn.disabled = !value;
            }
        }
        
        async function analyzeDataset() {
            if (!app.dataset) return;
            
            const infoDiv = document.getElementById('dataset-info');
            const descDiv = document.getElementById('dataset-description');
            
            infoDiv.style.display = 'block';
            descDiv.innerHTML = `
                <strong>Dataset:</strong> ${app.dataset}<br>
                <strong>Source:</strong> data.economie.gouv.fr<br>
                <strong>Status:</strong> ✅ Disponible
            `;
            
            // Enable step 2
            document.getElementById('step-2').classList.remove('disabled');
        }
        
        function selectWidgetType(type) {
            app.widgetType = type;
            
            // Update UI
            document.querySelectorAll('.widget-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            
            // Enable step 3 and show config
            document.getElementById('step-3').classList.remove('disabled');
            showConfigForm(type);
        }
        
        function showConfigForm(type) {
            const configForm = document.getElementById('config-form');
            let html = '';
            
            switch(type) {
                case 'table':
                    html = `
                        <div class="fr-input-group">
                            <label class="fr-label">Nombre de lignes</label>
                            <input type="number" class="fr-input" id="config-limit" value="10">
                        </div>
                        <div class="fr-input-group">
                            <label class="fr-label">Colonnes (séparées par des virgules)</label>
                            <input type="text" class="fr-input" id="config-fields" placeholder="field1,field2,field3">
                        </div>
                    `;
                    break;
                    
                case 'chart':
                    html = `
                        <div class="fr-select-group">
                            <label class="fr-label">Type de graphique</label>
                            <select class="fr-select" id="config-chart-type">
                                <option value="bar">Barres</option>
                                <option value="line">Lignes</option>
                                <option value="pie">Camembert</option>
                            </select>
                        </div>
                        <div class="fr-input-group">
                            <label class="fr-label">Nombre de données</label>
                            <input type="number" class="fr-input" id="config-limit" value="10">
                        </div>
                    `;
                    break;
                    
                case 'map':
                    html = `
                        <div class="fr-input-group">
                            <label class="fr-label">Zoom initial</label>
                            <input type="number" class="fr-input" id="config-zoom" value="6" min="1" max="18">
                        </div>
                        <div class="fr-checkbox-group">
                            <input type="checkbox" id="config-cluster" checked>
                            <label class="fr-label" for="config-cluster">
                                Activer le clustering
                            </label>
                        </div>
                    `;
                    break;
                    
                case 'list':
                    html = `
                        <div class="fr-input-group">
                            <label class="fr-label">Nombre d'éléments</label>
                            <input type="number" class="fr-input" id="config-limit" value="9">
                        </div>
                        <div class="fr-input-group">
                            <label class="fr-label">Champs à afficher</label>
                            <input type="text" class="fr-input" id="config-fields" placeholder="title,description">
                        </div>
                    `;
                    break;
            }
            
            configForm.innerHTML = html;
            
            // Enable generate button
            document.getElementById('generate-widget').disabled = false;
        }
        
        function generateWidget() {
            // Collect config
            app.config = {};
            
            const limitInput = document.getElementById('config-limit');
            if (limitInput) app.config.limit = limitInput.value || 10;
            
            const fieldsInput = document.getElementById('config-fields');
            if (fieldsInput) app.config.fields = fieldsInput.value ? fieldsInput.value.split(',').map(f => f.trim()) : ['field1', 'field2'];
            
            const chartTypeInput = document.getElementById('config-chart-type');
            if (chartTypeInput) app.config.chartType = chartTypeInput.value;
            
            const zoomInput = document.getElementById('config-zoom');
            if (zoomInput) app.config.zoom = zoomInput.value;
            
            const clusterInput = document.getElementById('config-cluster');
            if (clusterInput) app.config.cluster = clusterInput.checked;
            
            // Generate code based on type
            switch(app.widgetType) {
                case 'table':
                    app.generatedCode = generateTableCode();
                    break;
                case 'chart':
                    app.generatedCode = generateChartCode();
                    break;
                case 'map':
                    app.generatedCode = generateMapCode();
                    break;
                case 'list':
                    app.generatedCode = generateListCode();
                    break;
            }
            
            // Show code and preview
            document.getElementById('generated-code').textContent = app.generatedCode;
            document.getElementById('code-section').style.display = 'block';
            showPreview();
        }
        
        function generateTableCode() {
            const fields = app.config.fields || ['field1', 'field2'];
            const limit = app.config.limit || 10;
            
            return `<!-- Widget Table DSFR - ${app.dataset} -->
<div id="widget-table-${app.dataset}" class="fr-table">
    <table>
        <thead>
            <tr>
                ${fields.map(f => `<th>${f}</th>`).join('\n                ')}
            </tr>
        </thead>
        <tbody id="table-body-${app.dataset}">
            <!-- Données chargées dynamiquement -->
        </tbody>
    </table>
</div>

<script>
(async function() {
    const response = await fetch(
        'https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/${app.dataset}/records?limit=${limit}'
    );
    const data = await response.json();
    
    const tbody = document.getElementById('table-body-${app.dataset}');
    data.results.forEach(record => {
        const row = tbody.insertRow();
        ${fields.map(f => `row.insertCell().textContent = record['${f}'] || '';`).join('\n        ')}
    });
})();
<\/script>`;
        }
        
        function generateChartCode() {
            const chartType = app.config.chartType || 'bar';
            const limit = app.config.limit || 10;
            
            return `<!-- Widget Chart DSFR - ${app.dataset} -->
<div class="fr-container">
    <canvas id="chart-${app.dataset}" width="400" height="200"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
<script>
(async function() {
    const response = await fetch(
        'https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/${app.dataset}/records?limit=${limit}'
    );
    const data = await response.json();
    
    const ctx = document.getElementById('chart-${app.dataset}').getContext('2d');
    new Chart(ctx, {
        type: '${chartType}',
        data: {
            labels: data.results.map((r, i) => 'Item ' + (i + 1)),
            datasets: [{
                label: '${app.dataset}',
                data: data.results.map((r, i) => Math.random() * 100),
                backgroundColor: '#000091'
            }]
        }
    });
})();
<\/script>`;
        }
        
        function generateMapCode() {
            const zoom = app.config.zoom || 6;
            const cluster = app.config.cluster ? 'true' : 'false';
            
            return `<!-- Widget Map DSFR - ${app.dataset} -->
<div id="map-${app.dataset}" style="height: 400px;"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
<script>
(async function() {
    const map = L.map('map-${app.dataset}').setView([46.603354, 1.888334], ${zoom});
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Fetch and add markers
    const response = await fetch(
        'https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/${app.dataset}/records?limit=100'
    );
    const data = await response.json();
    
    // Add markers (example)
    data.results.forEach(record => {
        if (record.latitude && record.longitude) {
            L.marker([record.latitude, record.longitude]).addTo(map);
        }
    });
})();
<\/script>`;
        }
        
        function generateListCode() {
            const fields = app.config.fields || ['title', 'description'];
            const limit = app.config.limit || 9;
            
            return `<!-- Widget List DSFR - ${app.dataset} -->
<div class="fr-grid-row fr-grid-row--gutters" id="list-${app.dataset}">
    <!-- Cards will be populated here -->
</div>

<script>
(async function() {
    const response = await fetch(
        'https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/${app.dataset}/records?limit=${limit}'
    );
    const data = await response.json();
    
    const container = document.getElementById('list-${app.dataset}');
    data.results.forEach(record => {
        const card = document.createElement('div');
        card.className = 'fr-col-12 fr-col-md-4';
        card.innerHTML = \`
            <div class="fr-card">
                <div class="fr-card__body">
                    <div class="fr-card__content">
                        <h3 class="fr-card__title">\${record['${fields[0]}'] || 'Sans titre'}</h3>
                        <p class="fr-card__desc">\${record['${fields[1]}'] || ''}</p>
                    </div>
                </div>
            </div>
        \`;
        container.appendChild(card);
    });
})();
<\/script>`;
        }
        
        function showPreview() {
            const previewDiv = document.getElementById('widget-preview');
            
            previewDiv.innerHTML = `
                <div class="fr-alert fr-alert--success fr-mb-3w">
                    <p>Widget généré avec succès !</p>
                </div>
                <div class="fr-callout">
                    <p class="fr-callout__text">
                        Le code HTML a été généré. Vous pouvez le copier et l'intégrer dans votre site.
                    </p>
                </div>
            `;
        }
        
        function copyCode() {
            navigator.clipboard.writeText(app.generatedCode).then(() => {
                const btn = document.getElementById('copy-code');
                const originalText = btn.textContent;
                btn.textContent = 'Copié !';
                btn.classList.add('fr-btn--success');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('fr-btn--success');
                }, 2000);
            });
        }
    </script>
    
    <!-- DSFR JS -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>