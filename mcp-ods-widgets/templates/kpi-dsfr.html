<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Widget KPI DSFR - {{DATASET_NAME}}</title>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    
    <!-- ODS Widgets CSS -->
    <link rel="stylesheet" href="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.min.css">
    
    <style>
        /* Surcharges DSFR pour KPI */
        .kpi-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--text-title-blue-france);
            line-height: 1;
        }
        .kpi-trend {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 500;
        }
        .kpi-trend--up {
            color: var(--text-default-success);
        }
        .kpi-trend--down {
            color: var(--text-default-error);
        }
        .kpi-trend--stable {
            color: var(--text-default-info);
        }
    </style>
</head>
<body>
    <!-- DÉBUT ZONE WIDGET {{WIDGET_ID}} -->
    <div id="widget-{{WIDGET_ID}}" class="fr-container fr-my-4w" ng-app="ods-widgets">
        <ods-dataset-context context="ctx" 
                             ctx-dataset="{{DATASET_ID}}"
                             ctx-domain="{{DOMAIN}}"
                             ctx-apikey="{{API_KEY}}">
            
            <h2 class="fr-h3 fr-mb-3w">{{WIDGET_TITLE}}</h2>
            
            <!-- Grille de KPIs -->
            <div class="fr-grid-row fr-grid-row--gutters">
                
                <!-- KPI 1: Total -->
                <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">
                    <div class="fr-tile fr-tile--vertical">
                        <div class="fr-tile__body">
                            <ods-aggregation context="ctx" 
                                           function="COUNT">
                                <h3 class="fr-tile__title">
                                    <span class="kpi-value">{{ aggregation | number }}</span>
                                </h3>
                            </ods-aggregation>
                            <p class="fr-tile__subtitle">{{KPI1_LABEL}}</p>
                            <p class="fr-tile__desc fr-text--xs">
                                {{KPI1_DESC}}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- KPI 2: Moyenne -->
                <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">
                    <div class="fr-tile fr-tile--vertical">
                        <div class="fr-tile__body">
                            <ods-aggregation context="ctx" 
                                           expression="{{KPI2_FIELD}}"
                                           function="AVG">
                                <h3 class="fr-tile__title">
                                    <span class="kpi-value">{{ aggregation | number:1 }}</span>
                                </h3>
                            </ods-aggregation>
                            <p class="fr-tile__subtitle">{{KPI2_LABEL}}</p>
                            <p class="fr-tile__desc fr-text--xs">
                                {{KPI2_DESC}}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- KPI 3: Maximum -->
                <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">
                    <div class="fr-tile fr-tile--vertical">
                        <div class="fr-tile__body">
                            <ods-aggregation context="ctx" 
                                           expression="{{KPI3_FIELD}}"
                                           function="MAX">
                                <h3 class="fr-tile__title">
                                    <span class="kpi-value">{{ aggregation | number }}</span>
                                </h3>
                            </ods-aggregation>
                            <p class="fr-tile__subtitle">{{KPI3_LABEL}}</p>
                            <p class="fr-tile__desc fr-text--xs">
                                {{KPI3_DESC}}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- KPI 4: Somme -->
                <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">
                    <div class="fr-tile fr-tile--vertical">
                        <div class="fr-tile__body">
                            <ods-aggregation context="ctx" 
                                           expression="{{KPI4_FIELD}}"
                                           function="SUM">
                                <h3 class="fr-tile__title">
                                    <span class="kpi-value">{{ aggregation | number }}</span>
                                </h3>
                            </ods-aggregation>
                            <p class="fr-tile__subtitle">{{KPI4_LABEL}}</p>
                            <p class="fr-tile__desc fr-text--xs">
                                {{KPI4_DESC}}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- KPIs avec graphiques sparkline -->
            <div class="fr-grid-row fr-grid-row--gutters fr-mt-4w">
                <div class="fr-col-12 fr-col-md-6">
                    <div class="fr-card">
                        <div class="fr-card__body">
                            <h3 class="fr-card__title">{{TREND_TITLE}}</h3>
                            <div class="fr-card__desc">
                                <ods-chart timescale="year" single-y-axis="true" scientific-display="false">
                                    <ods-chart-query context="ctx" 
                                                   field-x="{{DATE_FIELD}}"
                                                   timescale="month">
                                        <ods-chart-serie expression-y="{{TREND_EXPRESSION}}"
                                                       chart-type="line"
                                                       function-y="COUNT"
                                                       color="#000091"
                                                       display-legend="false">
                                        </ods-chart-serie>
                                    </ods-chart-query>
                                </ods-chart>
                            </div>
                            <div class="fr-card__content">
                                <p class="fr-text--sm">
                                    Évolution sur les 12 derniers mois
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fr-col-12 fr-col-md-6">
                    <div class="fr-card">
                        <div class="fr-card__body">
                            <h3 class="fr-card__title">{{DISTRIBUTION_TITLE}}</h3>
                            <div class="fr-card__desc">
                                <ods-chart>
                                    <ods-chart-query context="ctx" 
                                                   field-x="{{CATEGORY_FIELD}}"
                                                   max-points="5">
                                        <ods-chart-serie chart-type="pie"
                                                       function-y="COUNT"
                                                       color-thresholds="[#000091,#18753c,#0063cb,#b34000,#ce0500]"
                                                       display-legend="true">
                                        </ods-chart-serie>
                                    </ods-chart-query>
                                </ods-chart>
                            </div>
                            <div class="fr-card__content">
                                <p class="fr-text--sm">
                                    Répartition par {{CATEGORY_LABEL}}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Période et actualisation -->
            <div class="fr-alert fr-alert--info fr-mt-4w">
                <p class="fr-alert__title">Informations sur les données</p>
                <p class="fr-text--sm">
                    <strong>Période :</strong> {{DATA_PERIOD}}<br>
                    <strong>Dernière mise à jour :</strong> {{LAST_UPDATE}}<br>
                    <strong>Source :</strong> {{DATA_SOURCE}}
                </p>
            </div>
            
            <!-- Export des données -->
            <div class="fr-mt-3w">
                <h3 class="fr-h6">Télécharger les données</h3>
                <div class="fr-btns-group fr-btns-group--inline">
                    <ods-export-api context="ctx" format="csv">
                        <button class="fr-btn fr-btn--secondary fr-btn--sm">
                            Format CSV
                        </button>
                    </ods-export-api>
                    <ods-export-api context="ctx" format="json">
                        <button class="fr-btn fr-btn--secondary fr-btn--sm">
                            Format JSON
                        </button>
                    </ods-export-api>
                </div>
            </div>
            
        </ods-dataset-context>
    </div>
    <!-- FIN ZONE WIDGET {{WIDGET_ID}} -->
    
    <!-- Angular et dépendances -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-sanitize/1.8.2/angular-sanitize.min.js"></script>
    
    <!-- ODS Widgets -->
    <script src="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.min.js"></script>
    
    <!-- DSFR JS -->
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
</body>
</html>