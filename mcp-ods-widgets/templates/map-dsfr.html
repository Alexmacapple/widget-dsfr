<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Widget Carte DSFR - {{DATASET_NAME}}</title>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.min.css">
    
    <!-- ODS Widgets CSS -->
    <link rel="stylesheet" href="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.min.css">
    
    <style>
        /* Surcharges DSFR pour cartes */
        .map-container {
            position: relative;
            height: 500px;
            width: 100%;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        ods-map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- DÉBUT ZONE WIDGET {{WIDGET_ID}} -->
    <div id="widget-{{WIDGET_ID}}" class="fr-container fr-my-4w" ng-app="ods-widgets">
        <ods-dataset-context context="ctx" 
                             ctx-dataset="{{DATASET_ID}}"
                             ctx-domain="{{DOMAIN}}"
                             ctx-apikey="{{API_KEY}}">
            
            <!-- Card DSFR pour la carte -->
            <div class="fr-card">
                <div class="fr-card__body">
                    <h2 class="fr-card__title">{{WIDGET_TITLE}}</h2>
                    <p class="fr-card__desc">{{WIDGET_DESCRIPTION}}</p>
                    
                    <!-- Filtres géographiques -->
                    <div class="fr-grid-row fr-grid-row--gutters fr-mb-3w">
                        <div class="fr-col-12 fr-col-md-4">
                            <label class="fr-label" for="region-filter-{{WIDGET_ID}}">
                                Filtrer par région
                            </label>
                            <ods-facet context="ctx" name="{{REGION_FIELD}}">
                                <select class="fr-select" id="region-filter-{{WIDGET_ID}}"
                                        ng-model="ctx.parameters['refine.{{REGION_FIELD}}']">
                                    <option value="">Toutes les régions</option>
                                    <option ng-repeat="item in items" value="{{item.name}}">
                                        {{item.name}} ({{item.count}})
                                    </option>
                                </select>
                            </ods-facet>
                        </div>
                        <div class="fr-col-12 fr-col-md-4">
                            <label class="fr-label" for="dept-filter-{{WIDGET_ID}}">
                                Filtrer par département
                            </label>
                            <ods-facet context="ctx" name="{{DEPT_FIELD}}">
                                <select class="fr-select" id="dept-filter-{{WIDGET_ID}}"
                                        ng-model="ctx.parameters['refine.{{DEPT_FIELD}}']">
                                    <option value="">Tous les départements</option>
                                    <option ng-repeat="item in items" value="{{item.name}}">
                                        {{item.name}} ({{item.count}})
                                    </option>
                                </select>
                            </ods-facet>
                        </div>
                        <div class="fr-col-12 fr-col-md-4">
                            <ods-clear-all-filters context="ctx">
                                <button class="fr-btn fr-btn--secondary fr-btn--sm">
                                    Réinitialiser la carte
                                </button>
                            </ods-clear-all-filters>
                        </div>
                    </div>
                    
                    <!-- Carte ODS dans conteneur DSFR -->
                    <div class="fr-card__content">
                        <div class="map-container">
                            <!-- Contrôles de la carte -->
                            <div class="map-controls">
                                <div class="fr-toggle">
                                    <input type="checkbox" 
                                           class="fr-toggle__input" 
                                           id="cluster-{{WIDGET_ID}}"
                                           ng-model="showClusters">
                                    <label class="fr-toggle__label" for="cluster-{{WIDGET_ID}}">
                                        Regrouper les points
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Carte ODS -->
                            <ods-map context="ctx" 
                                     location="{{MAP_LOCATION}}"
                                     basemap="{{BASEMAP}}"
                                     toolbar-drawing="false"
                                     scroll-wheel-zoom="false">
                                
                                <ods-map-layer context="ctx"
                                               color="#000091"
                                               picto="circle"
                                               show-marker="true"
                                               display="{{showClusters ? 'clusters' : 'auto'}}"
                                               shape-opacity="0.7"
                                               point-opacity="0.9"
                                               border-color="#ffffff"
                                               border-size="2"
                                               size="5"
                                               size-min="3"
                                               size-max="10"
                                               size-function="linear">
                                    
                                    <!-- Popup personnalisé -->
                                    <div class="ods-map__tooltip">
                                        <h3>{{record.fields.{{TITLE_FIELD}}}}</h3>
                                        <p>{{record.fields.{{DESC_FIELD}}}}</p>
                                        <dl class="fr-mt-1w">
                                            {{POPUP_FIELDS}}
                                        </dl>
                                    </div>
                                </ods-map-layer>
                            </ods-map>
                        </div>
                        
                        <!-- Légende -->
                        <div class="fr-alert fr-alert--info fr-mt-2w">
                            <h3 class="fr-alert__title">Légende</h3>
                            <p class="fr-text--sm">
                                Les points sur la carte représentent {{MAP_LEGEND}}.
                                Cliquez sur un point pour voir les détails.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Alternative textuelle -->
                    <details class="fr-accordion fr-mt-2w">
                        <summary class="fr-accordion__btn">
                            Alternative textuelle de la carte
                        </summary>
                        <div class="fr-accordion__content">
                            <p class="fr-text--sm">
                                Cette carte présente {{WIDGET_DESCRIPTION}}.
                                Les données complètes sont disponibles dans le tableau ci-dessous.
                            </p>
                            <div class="fr-table fr-table--bordered">
                                <ods-table context="ctx" 
                                          displayed-fields="{{GEO_FIELDS}}"
                                          sort="{{GEO_SORT}}">
                                </ods-table>
                            </div>
                        </div>
                    </details>
                    
                    <!-- Actions -->
                    <div class="fr-card__footer">
                        <div class="fr-btns-group fr-btns-group--inline">
                            <ods-export-api context="ctx" format="geojson">
                                <button class="fr-btn fr-btn--secondary">
                                    Télécharger GeoJSON
                                </button>
                            </ods-export-api>
                            <ods-export-api context="ctx" format="csv">
                                <button class="fr-btn fr-btn--secondary">
                                    Télécharger CSV
                                </button>
                            </ods-export-api>
                        </div>
                    </div>
                </div>
            </div>
            
        </ods-dataset-context>
    </div>
    <!-- FIN ZONE WIDGET {{WIDGET_ID}} -->
    
    <!-- Angular et dépendances -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-sanitize/1.8.2/angular-sanitize.min.js"></script>
    
    <!-- ODS Widgets -->
    <script src="https://static.opendatasoft.com/ods-widgets/latest-v2/ods-widgets.min.js"></script>
    
    <!-- DSFR JS -->
    <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.0/dist/dsfr.module.min.js"></script>
    
    <!-- Script d'initialisation -->
    <script>
        angular.module('ods-widgets').run(['$rootScope', function($rootScope) {
            $rootScope.showClusters = true;
        }]);
    </script>
</body>
</html>